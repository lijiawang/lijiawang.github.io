<article id="post-kolla-octavia" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 class="article-title" itemprop="name">
      kolla搭建octavia
    </h1>
  


  
  
  
  
    
<div style="margin-top:10px;">
  <span class="post-time">
    <span class="post-meta-item-icon">
      <!-- fonts.scss -->
      <!-- 百度字体平台:http://fontstore.baidu.com/static/editor/index.html -->
      <i class="icon-statistics"></i>
      <span class="post-meta-item-text"> 字数统计:</span>
      <span class="post-count">988字</span>
    </span>
  </span>

  <span class="post-time">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
      <i class="icon-book icon"></i>
      <span class="post-meta-item-text"> 阅读时长≈</span>
      <span class="post-count">5分</span>
    </span>
  </span>
</div>


  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="octavia-介绍"><a href="#octavia-介绍" class="headerlink" title="octavia 介绍"></a>octavia 介绍</h3><p>openstack octavia 是 openstack Lbaas项目分出来的一个子项目，是提供虚拟机流量负载均衡，其实oactavia就是调用nova以及neutron的api生成两台安装好了haproxy和keepalived软件的虚拟机，并连接到目标网络。octavia共有4个组件housekeeping,worker,api,health-manager。详情请参考 <a href="https://docs.openstack.org/octavia/latest/reference/introduction.html" target="_blank" rel="external">octavia介绍</a><br><a id="more"></a></p>
<h3 id="octavia-架构图"><a href="#octavia-架构图" class="headerlink" title="octavia 架构图"></a>octavia 架构图</h3><p><img src="https://ljw.howieli.cn/blog/2017-9-8/octavia架构图.png" alt=""></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>我事先准备好了一个kolla部署的多节点的openstack环境<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack service list</span></div><div class="line">+----------------------------------+------------------+-------------------------+</div><div class="line">| ID                               | Name             | Type                    |</div><div class="line">+----------------------------------+------------------+-------------------------+</div><div class="line">| 11bb0c086a484e33bf65558298a13f2d | manila           | share                   |</div><div class="line">| 126fb7d3b45f44008f9b5649e7fa6772 | glance           | image                   |</div><div class="line">| 1963c13ceda74eaa846ce53447aa9663 | swift            | object-store            |</div><div class="line">| 1d73b2481e0e4c2996e902282f53ac94 | ceilometer       | metering                |</div><div class="line">| 277ac4e4d36b4170a13dff885133d497 | cinderv3         | volumev3                |</div><div class="line">| 313e8abeeb5f46968e21c47be64fe37a | panko            | event                   |</div><div class="line">| 3546da190ebe4cb69a5e4054c1b226e8 | ironic-inspector | baremetal-introspection |</div><div class="line">| 3559efb2c60c4532b0e20f4280d00d65 | gnocchi          | metric                  |</div><div class="line">| 38fa732db46a4bf99a656cc4b29f9955 | trove            | database                |</div><div class="line">| 5003dabefad4462f80758eecc883a185 | sahara           | data_processing         |</div><div class="line">| 5b3ab9520859475fb874e570be8ea064 | manilav2         | sharev2                 |</div><div class="line">| 659cd19c052b452a8a954bbadfd94a5a | nova             | compute                 |</div><div class="line">| 72fcd0fc324248bdb8c5f08f9c65a1ea | nova_legacy      | compute_legacy          |</div><div class="line">| 754afe3e3b4349a0a54d26b7d83fec5e | cinder           | volume                  |</div><div class="line">| 85c1d57869754c38989f228c08896d4c | ironic           | baremetal               |</div><div class="line">| 9962758f42c140c4b811940bdc4041b2 | heat             | orchestration           |</div><div class="line">| b7dc29ababc54104b31ad3b999eae6b5 | heat-cfn         | cloudformation          |</div><div class="line">| bee93d265f994dd3bd9e76a326df0d1b | cinderv2         | volumev2                |</div><div class="line">| d6f1862a19434267a4a51fd4c8a6d665 | neutron          | network                 |</div><div class="line">| ee90e0f359d84c1eb35c3cd9423f43db | placement        | placement               |</div><div class="line">| f7b5b57d52494869ab20501c28237613 | cloudkitty       | rating                  |</div><div class="line">| fdb4e5b1658d4d39a1f807f9d7b2b4d7 | keystone         | identity                |</div><div class="line">+----------------------------------+------------------+-------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> https://review.openstack.org/p/openstack/octavia</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> octavia</span></div><div class="line"><span class="meta">#</span><span class="bash"> grep octavia_ca /etc/kolla/passwords.yml</span></div><div class="line">octavia_ca_password: mEUyBHLopKk501CX30WRnPuiDmoP3I7eNQIQbC6z</div><div class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">'s/foobar/mEUyBHLopKk501CX30WRnPuiDmoP3I7eNQIQbC6z/g'</span> bin/create_certificates.sh</span></div><div class="line"><span class="meta">#</span><span class="bash"> ./bin/create_certificates.sh cert $(<span class="built_in">pwd</span>)/etc/certificates/openssl.cnf</span></div></pre></td></tr></table></figure>
<p>然后你会得到一个文件夹<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ls -al cert/</span></div><div class="line">total 48</div><div class="line">drwxr-xr-x  4 root root  219 Sep  7 09:32 .</div><div class="line">drwxr-xr-x 17 root root 4096 Sep  7 09:32 ..</div><div class="line">-rw-r--r--  1 root root 1294 Sep  7 09:32 ca_01.pem</div><div class="line">-rw-r--r--  1 root root  989 Sep  7 09:32 client.csr</div><div class="line">-rw-r--r--  1 root root 1708 Sep  7 09:32 client.key</div><div class="line">-rw-r--r--  1 root root 4401 Sep  7 09:32 client-.pem</div><div class="line">-rw-r--r--  1 root root 6109 Sep  7 09:32 client.pem</div><div class="line">-rw-r--r--  1 root root   71 Sep  7 09:32 index.txt</div><div class="line">-rw-r--r--  1 root root   21 Sep  7 09:32 index.txt.attr</div><div class="line">-rw-r--r--  1 root root    0 Sep  7 09:32 index.txt.old</div><div class="line">drwxr-xr-x  2 root root   20 Sep  7 09:32 newcerts</div><div class="line">drwx------  2 root root   23 Sep  7 09:32 private</div><div class="line">-rw-r--r--  1 root root    3 Sep  7 09:32 serial</div><div class="line">-rw-r--r--  1 root root    3 Sep  7 09:32 serial.old</div></pre></td></tr></table></figure></p>
<p>将认证放到kolla部署节点上的/etc/kolla/octavia目录里，首先要先在/etc/kolla目录下创建一个octavia文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/kolla/config/octavia</span></div><div class="line"><span class="meta">#</span><span class="bash"> cp certs/&#123;private/cakey.pem,ca_01.pem,client.pem&#125; /etc/kolla/config/ocatava/</span></div><div class="line"><span class="meta">#</span><span class="bash"> ls -al /etc/kolla/config/octavia/</span></div><div class="line">total 20</div><div class="line">drwxr-xr-x 2 root root   58 Sep  8 12:37 .</div><div class="line">drwxr-xr-x 5 root root 4096 Sep  8 12:36 ..</div><div class="line">-rw-r--r-- 1 root root 1294 Sep  8 12:37 ca_01.pem</div><div class="line">-rw-r--r-- 1 root root 1743 Sep  8 12:37 cakey.pem</div><div class="line">-rw-r--r-- 1 root root 6109 Sep  8 12:37 client.pem</div></pre></td></tr></table></figure></p>
<h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># pwd</div><div class="line">/root</div><div class="line"># cd octavia/diskimage-create/</div><div class="line"># ./diskimage-create.sh -i centos</div></pre></td></tr></table></figure>
<p>会产生amphora-x64-haproxy.qcow2镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ls amphora-x64-haproxy.qcow2</span></div><div class="line">amphora-x64-haproxy.qcow2</div></pre></td></tr></table></figure></p>
<p>上传镜像，因为我kolla部署openstack时候后端存储用的ceph，所以首先要把镜像转换成raw格式,然后在上传镜像，上传镜像必须给镜像打一个amphora的tag。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> qemu-img convert <span class="_">-f</span> qcow2 -O raw amphora-x64-haproxy.qcow2 amphora-x64-haproxy.raw</span></div><div class="line"><span class="meta">#</span><span class="bash"> qemu-img info amphora-x64-haproxy.raw</span></div><div class="line">image: amphora-x64-haproxy.raw</div><div class="line">file format: raw</div><div class="line">virtual size: 2.0G (2147483648 bytes)</div><div class="line">disk size: 1.5G</div><div class="line"><span class="meta">#</span><span class="bash"> openstack image create --container-format bare --disk-format raw --private --file amphora-x64-haproxy.raw --tag amphora amphora</span></div></pre></td></tr></table></figure></p>
<h3 id="准备openstack资源"><a href="#准备openstack资源" class="headerlink" title="准备openstack资源"></a>准备openstack资源</h3><p>octavia_amp_boot_network_list 网络,这里需要准备分给octavia用的网络ID,而且这个网络必须能和api互通<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack network create --provider-physical-network physnet1 \</span></div><div class="line">    --provider-network-type vlan --provider-segment 121 lb-net</div><div class="line"><span class="meta">#</span><span class="bash"> openstack subnet create --allocation-pool --network lb-net --subnet-range 10.140.1.0/24 \</span></div><div class="line">    lb-subnet</div></pre></td></tr></table></figure></p>
<p>还需要octavia_amp_flavor_id 值,这是octavia创建的虚拟机的大小。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack flavor create --disk 40 --private --ram 4096 --vcpus 2 octavia_flavor</span></div></pre></td></tr></table></figure></p>
<p>创建一个octavia的安全组，安全组的id值为octavia_amp_secgroup_list 值<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack security group create --description <span class="string">'used by Octavia amphora instance'</span> octavia</span></div></pre></td></tr></table></figure></p>
<p>为octavia安全组设置规则<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack security group rule create --protocol icmp f97161c4-ffda-4205-b984<span class="_">-d</span>3ecad0f9ce1</span></div><div class="line"><span class="meta">#</span><span class="bash"> openstack security group rule create --protocol tcp --dst-port 5555 --egress f97161c4-ffda-4205-b984<span class="_">-d</span>3ecad0f9ce1</span></div><div class="line"><span class="meta">#</span><span class="bash"> openstack security group rule create --protocol tcp --dst-port 9443 --ingress f97161c4-ffda-4205-b984<span class="_">-d</span>3ecad0f9ce1</span></div></pre></td></tr></table></figure></p>
<p>octavia 机器启动时注入的  key, octavia_ssh_key 名字是固定的，需要和 octavia.conf 配置文件相同。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack keypair create --public-key /root/.ssh/id_rsa.pub octavia_ssh_key</span></div><div class="line"><span class="meta">#</span><span class="bash"> 我们也可以使用 octavia 账号去建虚拟机，所以 ssh key 要使用 octavia 账号创建。</span></div><div class="line"><span class="meta">#</span><span class="bash"> openstack --os-username octavia --os-password &lt;octavia_keystone_password&gt; keypair create --public-key /tmp/id_rsa.pub octavia_ssh_key</span></div></pre></td></tr></table></figure></p>
<h3 id="更改globas-yml文件"><a href="#更改globas-yml文件" class="headerlink" title="更改globas.yml文件"></a>更改globas.yml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/globals.yml</span></div><div class="line">enable_horizon_neutron_lbaas: "yes"</div><div class="line">enable_neutron_lbaas: "yes"</div><div class="line">enable_octavia: yes</div><div class="line"><span class="meta">#</span><span class="bash"> Load balancer topology options are [ SINGLE, ACTIVE_STANDBY ]</span></div><div class="line">octavia_loadbalancer_topology: "ACTIVE_STANDBY"</div><div class="line">octavia_amp_boot_network_list: ffc00802-c88b-4a5e-a51b-60071f4045d5</div><div class="line">octavia_amp_secgroup_list: f97161c4-ffda-4205-b984-d3ecad0f9ce1</div><div class="line">octavia_amp_flavor_id: 54f2cc50-81d4-44d3-8e44-a01686e4b2c6</div></pre></td></tr></table></figure>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible deploy -i multinode</span></div></pre></td></tr></table></figure>

    

    
    <div class="page-reward">
      <a href="javascript:void(0);" class="page-reward-btn tooltip-top" target="_self">
        <div class="tooltip tooltip-east">
          <span class="tooltip-item">
            赏
          </span>
          <span class="tooltip-content">
            <span class="tooltip-text">
              <span class="tooltip-inner">
                <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i
                    class="icon icon-quo-right"></i></p>
                <div class="reward-box">
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/alipay.jpg">
                    <span class="reward-type">支付宝</span>
                  </div>
                  
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/weixin.png">
                    <span class="reward-type">微信</span>
                  </div>
                  
                </div>
              </span>
            </span>
          </span>
        </div>
      </a>
    </div>
    

    
    <div class="declare"> 
      <ul class="post-copyright">
        <li>
          <strong>本文作者：</strong>
          李家旺
        </li>
        <li>
          <strong>本文链接：</strong>
          <a href="https://www.lijiawang.org/posts/kolla-octavia.html" title="kolla搭建octavia" target="_blank">https://www.lijiawang.org/posts/kolla-octavia.html</a>
        </li>
        <li>
          <strong>版权声明： </strong>
          本博客所有文章除特别声明外，均采用 <a href="https://www.apache.org/licenses/LICENSE-2.0.html" rel="external nofollow" target="_blank">Apache License 2.0</a> 许可协议。转载请注明出处！
        </li>
      </ul>
    </div>
    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">octavia</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/openstack//" class="article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>


    

    
    
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <!-- <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a> -->
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
     <!-- <img src="//pan.baidu.com/share/qrcode?url=https://www.lijiawang.org/posts/kolla-octavia.html" alt="微信分享二维码"> -->
    </div>
</div>

<div class="mask js-mask"></div>

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>


<nav id="article-nav">
  
    <a href="/posts/Openstack performance testing.html" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          openstack性能测试
        
      </div>
    </a>
  
  
    <a href="/posts/ironic-instruction.html" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">ironic裸机服务使用说明</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>













