<article id="post-ceph ( requests are blocked ) 异常解决方法" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 class="article-title" itemprop="name">
      ceph ( requests are blocked ) 异常解决方法
    </h1>
  


  
  
  
  
    
<div style="margin-top:10px;">
  <span class="post-time">
    <span class="post-meta-item-icon">
      <!-- fonts.scss -->
      <!-- 百度字体平台:http://fontstore.baidu.com/static/editor/index.html -->
      <i class="icon-statistics"></i>
      <span class="post-meta-item-text"> 字数统计:</span>
      <span class="post-count">1.5k字</span>
    </span>
  </span>

  <span class="post-time">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
      <i class="icon-book icon"></i>
      <span class="post-meta-item-text"> 阅读时长≈</span>
      <span class="post-count">9分</span>
    </span>
  </span>
</div>


  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="ceph-requests-are-blocked-异常解决方法"><a href="#ceph-requests-are-blocked-异常解决方法" class="headerlink" title="ceph ( requests are blocked ) 异常解决方法"></a>ceph ( requests are blocked ) 异常解决方法</h3><p><img src="https://ljw.howieli.cn/blog/2018-1-8/%E4%BF%AE%E7%90%86%E5%B7%A5.png" alt=""><br><a id="more"></a><br>最近发现客户kolla平台的ceph环境遇到下面异常错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph -s</div><div class="line">    cluster b233a0b7-4e21-4375-bca8-e215c056cc25</div><div class="line">     health HEALTH_WARN</div><div class="line">            2 requests are blocked &gt; 32 sec</div><div class="line">     monmap e1: 3 mons at &#123;10.254.253.1=10.254.253.1:6789/0,10.254.253.2=10.254.253.2:6789/0,10.254.253.3=10.254.253.3:6789/0&#125;</div><div class="line">            election epoch 26, quorum 0,1,2 10.254.253.1,10.254.253.2,10.254.253.3</div><div class="line">     osdmap e380: 90 osds: 90 up, 90 in</div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v1730087: 1008 pgs, 11 pools, 3502 GB data, 886 kobjects</div><div class="line">            10463 GB used, 235 TB / 245 TB avail</div><div class="line">                1007 active+clean</div><div class="line">                   1 active+clean+scrubbing+deep</div><div class="line">  client io 1838 kB/s rd, 100 MB/s wr, 457 op/s rd, 929 op/s wr</div></pre></td></tr></table></figure></p>
<p>注意: 1 requests are blocked &gt; 32 sec 有可能是在数据迁移过程中, 用户正在对该数据块进行访问, 但访问还没有完成, 数据就迁移到别的 OSD 中, 那么就会导致有请求被 block, 对用户也是有影响的</p>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p>1.寻找block的请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph health detail</div><div class="line">HEALTH_WARN 2 requests are blocked &gt; 32 sec; 1 osds have slow requests</div><div class="line">2 ops are blocked &gt; 4194.3 sec on osd.5</div><div class="line">1 osds have slow requests</div></pre></td></tr></table></figure></p>
<p>可以考到osd.5具有一个操作block<br>2.查找osd对应的主机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph osd tree</div><div class="line">ID  WEIGHT    TYPE NAME              UP/DOWN REWEIGHT PRIMARY-AFFINITY </div><div class="line"> -1 270.00000 root default                                             </div><div class="line"> -2  27.00000     host 10.254.253.1                                    </div><div class="line">  0   3.00000         osd.0               up  1.00000          1.00000 </div><div class="line">  5   3.00000         osd.5               up  1.00000          1.00000 </div><div class="line"> 10   3.00000         osd.10              up  1.00000          1.00000 </div><div class="line"> 15   3.00000         osd.15              up  1.00000          1.00000 </div><div class="line"> 21   3.00000         osd.21              up  1.00000          1.00000 </div><div class="line"> 27   3.00000         osd.27              up  1.00000          1.00000 </div><div class="line"> 30   3.00000         osd.30              up  1.00000          1.00000 </div><div class="line"> 36   3.00000         osd.36              up  1.00000          1.00000 </div><div class="line"> 42   3.00000         osd.42              up  1.00000          1.00000 </div><div class="line"> -3  27.00000     host 10.254.253.5                                    </div><div class="line">  2   3.00000         osd.2               up  1.00000          1.00000 </div><div class="line">  6   3.00000         osd.6               up  1.00000          1.00000 </div><div class="line"> 11   3.00000         osd.11              up  1.00000          1.00000 </div><div class="line"> 17   3.00000         osd.17              up  1.00000          1.00000 </div><div class="line"> 20   3.00000         osd.20              up  1.00000          1.00000 </div><div class="line"> 25   3.00000         osd.25              up  1.00000          1.00000 </div><div class="line"> 31   3.00000         osd.31              up  1.00000          1.00000 </div><div class="line"> 35   3.00000         osd.35              up  1.00000          1.00000 </div><div class="line"> 41   3.00000         osd.41              up  1.00000          1.00000 </div><div class="line"> -4  27.00000     host 10.254.253.2                                    </div><div class="line">  1   3.00000         osd.1               up  1.00000          1.00000 </div><div class="line">  7   3.00000         osd.7               up  1.00000          1.00000 </div><div class="line"> 12   3.00000         osd.12              up  1.00000          1.00000 </div><div class="line"> 16   3.00000         osd.16              up  1.00000          1.00000 </div><div class="line"> 22   3.00000         osd.22              up  1.00000          1.00000 </div><div class="line"> 26   3.00000         osd.26              up  1.00000          1.00000 </div><div class="line"> 32   3.00000         osd.32              up  1.00000          1.00000 </div><div class="line"> 37   3.00000         osd.37              up  1.00000          1.00000 </div><div class="line"> 40   3.00000         osd.40              up  1.00000          1.00000 </div><div class="line"> -6  27.00000     host 10.254.253.4                                    </div><div class="line">  3   3.00000         osd.3               up  1.00000          1.00000 </div><div class="line">  8   3.00000         osd.8               up  1.00000          1.00000 </div><div class="line"> 13   3.00000         osd.13              up  1.00000          1.00000 </div><div class="line"> 18   3.00000         osd.18              up  1.00000          1.00000 </div><div class="line"> 24   3.00000         osd.24              up  1.00000          1.00000 </div><div class="line"> 29   3.00000         osd.29              up  1.00000          1.00000 </div><div class="line"> 33   3.00000         osd.33              up  1.00000          1.00000 </div><div class="line"> 39   3.00000         osd.39              up  1.00000          1.00000 </div><div class="line"> 43   3.00000         osd.43              up  1.00000          1.00000 </div><div class="line"> -5  27.00000     host 10.254.253.3                                    </div><div class="line">  4   3.00000         osd.4               up  1.00000          1.00000 </div><div class="line">  9   3.00000         osd.9               up  1.00000          1.00000 </div><div class="line"> 14   3.00000         osd.14              up  1.00000          1.00000 </div><div class="line"> 19   3.00000         osd.19              up  1.00000          1.00000 </div><div class="line"> 23   3.00000         osd.23              up  1.00000          1.00000 </div><div class="line"> 28   3.00000         osd.28              up  1.00000          1.00000 </div><div class="line"> 34   3.00000         osd.34              up  1.00000          1.00000 </div><div class="line"> 38   3.00000         osd.38              up  1.00000          1.00000 </div><div class="line"> 44   3.00000         osd.44              up  1.00000          1.00000 </div><div class="line"> -7  27.00000     host 10.254.253.8                                    </div><div class="line"> 47   3.00000         osd.47              up  1.00000          1.00000 </div><div class="line"> 51   3.00000         osd.51              up  1.00000          1.00000 </div><div class="line"> 56   3.00000         osd.56              up  1.00000          1.00000 </div><div class="line"> 61   3.00000         osd.61              up  1.00000          1.00000 </div><div class="line"> 66   3.00000         osd.66              up  1.00000          1.00000 </div><div class="line"> 71   3.00000         osd.71              up  1.00000          1.00000 </div><div class="line"> 76   3.00000         osd.76              up  1.00000          1.00000 </div><div class="line"> 81   3.00000         osd.81              up  1.00000          1.00000 </div><div class="line"> 86   3.00000         osd.86              up  1.00000          1.00000 </div><div class="line"> -8  27.00000     host 10.254.253.7                                    </div><div class="line"> 46   3.00000         osd.46              up  1.00000          1.00000 </div><div class="line"> 52   3.00000         osd.52              up  1.00000          1.00000 </div><div class="line"> 57   3.00000         osd.57              up  1.00000          1.00000 </div><div class="line"> 62   3.00000         osd.62              up  1.00000          1.00000 </div><div class="line"> 67   3.00000         osd.67              up  1.00000          1.00000 </div><div class="line"> 72   3.00000         osd.72              up  1.00000          1.00000 </div><div class="line"> 77   3.00000         osd.77              up  1.00000          1.00000 </div><div class="line"> 82   3.00000         osd.82              up  1.00000          1.00000 </div><div class="line"> 87   3.00000         osd.87              up  1.00000          1.00000 </div><div class="line"> -9  27.00000     host 10.254.253.9                                    </div><div class="line"> 48   3.00000         osd.48              up  1.00000          1.00000 </div><div class="line"> 53   3.00000         osd.53              up  1.00000          1.00000 </div><div class="line"> 58   3.00000         osd.58              up  1.00000          1.00000 </div><div class="line"> 63   3.00000         osd.63              up  1.00000          1.00000 </div><div class="line"> 68   3.00000         osd.68              up  1.00000          1.00000 </div><div class="line"> 73   3.00000         osd.73              up  1.00000          1.00000 </div><div class="line"> 78   3.00000         osd.78              up  1.00000          1.00000 </div><div class="line"> 83   3.00000         osd.83              up  1.00000          1.00000 </div><div class="line"> 88   3.00000         osd.88              up  1.00000          1.00000 </div><div class="line">-10  27.00000     host 10.254.253.10                                   </div><div class="line"> 49   3.00000         osd.49              up  1.00000          1.00000 </div><div class="line"> 54   3.00000         osd.54              up  1.00000          1.00000 </div><div class="line"> 59   3.00000         osd.59              up  1.00000          1.00000 </div><div class="line"> 64   3.00000         osd.64              up  1.00000          1.00000 </div><div class="line"> 69   3.00000         osd.69              up  1.00000          1.00000 </div><div class="line"> 74   3.00000         osd.74              up  1.00000          1.00000 </div><div class="line"> 79   3.00000         osd.79              up  1.00000          1.00000 </div><div class="line"> 84   3.00000         osd.84              up  1.00000          1.00000 </div><div class="line"> 89   3.00000         osd.89              up  1.00000          1.00000 </div><div class="line">-11  27.00000     host 10.254.253.6                                    </div><div class="line"> 50   3.00000         osd.50              up  1.00000          1.00000 </div><div class="line"> 55   3.00000         osd.55              up  1.00000          1.00000 </div><div class="line"> 60   3.00000         osd.60              up  1.00000          1.00000 </div><div class="line"> 65   3.00000         osd.65              up  1.00000          1.00000 </div><div class="line"> 70   3.00000         osd.70              up  1.00000          1.00000 </div><div class="line"> 75   3.00000         osd.75              up  1.00000          1.00000 </div><div class="line"> 80   3.00000         osd.80              up  1.00000          1.00000 </div><div class="line"> 85   3.00000         osd.85              up  1.00000          1.00000 </div><div class="line"> 90   3.00000         osd.90              up  1.00000          1.00000</div></pre></td></tr></table></figure></p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# docker restart ceph_osd_5</div><div class="line">ceph_osd_5</div><div class="line"></div><div class="line">[root@control01 ~]# docker ps|grep ceph_osd_5</div><div class="line">9c4fe5eb0090        10.254.254.1:4000/99cloud/centos-source-ceph-osd:animbus-5.4.0                    &quot;kolla_start&quot;            3 weeks ago         Up 13 seconds</div></pre></td></tr></table></figure>
<p>系统会对该 osd 执行 recovery 操作, recovery 过程中, 会断开 block request, 那么这个 request 将会重新请求 mon 节点, 并重新获得新的 pg map, 得到最新的数据访问位置, 从而解决上述问题。</p>
<h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph -s</div><div class="line">    cluster b233a0b7-4e21-4375-bca8-e215c056cc25</div><div class="line">     health HEALTH_OK</div><div class="line">     monmap e1: 3 mons at &#123;10.254.253.1=10.254.253.1:6789/0,10.254.253.2=10.254.253.2:6789/0,10.254.253.3=10.254.253.3:6789/0&#125;</div><div class="line">            election epoch 26, quorum 0,1,2 10.254.253.1,10.254.253.2,10.254.253.3</div><div class="line">     osdmap e387: 90 osds: 90 up, 90 in</div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v1730238: 1008 pgs, 11 pools, 3498 GB data, 886 kobjects</div><div class="line">            10453 GB used, 235 TB / 245 TB avail</div><div class="line">                1006 active+clean</div><div class="line">                   2 active+clean+scrubbing+deep</div><div class="line">  client io 1090 kB/s rd, 92507 kB/s wr, 778 op/s rd, 904 op/s wr</div></pre></td></tr></table></figure>

    

    
    <div class="page-reward">
      <a href="javascript:void(0);" class="page-reward-btn tooltip-top" target="_self">
        <div class="tooltip tooltip-east">
          <span class="tooltip-item">
            赏
          </span>
          <span class="tooltip-content">
            <span class="tooltip-text">
              <span class="tooltip-inner">
                <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i
                    class="icon icon-quo-right"></i></p>
                <div class="reward-box">
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/alipay.jpg">
                    <span class="reward-type">支付宝</span>
                  </div>
                  
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/weixin.png">
                    <span class="reward-type">微信</span>
                  </div>
                  
                </div>
              </span>
            </span>
          </span>
        </div>
      </a>
    </div>
    

    
    <div class="declare"> 
      <ul class="post-copyright">
        <li>
          <strong>本文作者：</strong>
          李家旺
        </li>
        <li>
          <strong>本文链接：</strong>
          <a href="https://www.lijiawang.org/posts/ceph ( requests are blocked ) 异常解决方法.html" title="ceph ( requests are blocked ) 异常解决方法" target="_blank">https://www.lijiawang.org/posts/ceph ( requests are blocked ) 异常解决方法.html</a>
        </li>
        <li>
          <strong>版权声明： </strong>
          本博客所有文章除特别声明外，均采用 <a href="https://www.apache.org/licenses/LICENSE-2.0.html" rel="external nofollow" target="_blank">Apache License 2.0</a> 许可协议。转载请注明出处！
        </li>
      </ul>
    </div>
    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">ceph</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/ceph//" class="article-tag-list-link color5">ceph</a>
        		</li>
      		
		</ul>
	</div>


    

    
    
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <!-- <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a> -->
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
     <!-- <img src="//pan.baidu.com/share/qrcode?url=https://www.lijiawang.org/posts/ceph ( requests are blocked ) 异常解决方法.html" alt="微信分享二维码"> -->
    </div>
</div>

<div class="mask js-mask"></div>

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>


<nav id="article-nav">
  
    <a href="/posts/手动构建Openstack镜像.html" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          手动构建Openstack镜像
        
      </div>
    </a>
  
  
    <a href="/posts/简单shell实现局域网IP扫描.html" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">shell实现局域网IP扫描</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>













