<article id="post-在openstack上的虚拟机绑定vip" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 class="article-title" itemprop="name">
      openstack虚拟机VIP配置步骤
    </h1>
  


  
  
  
  
    
<div style="margin-top:10px;">
  <span class="post-time">
    <span class="post-meta-item-icon">
      <!-- fonts.scss -->
      <!-- 百度字体平台:http://fontstore.baidu.com/static/editor/index.html -->
      <i class="icon-statistics"></i>
      <span class="post-meta-item-text"> 字数统计:</span>
      <span class="post-count">650字</span>
    </span>
  </span>

  <span class="post-time">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
      <i class="icon-book icon"></i>
      <span class="post-meta-item-text"> 阅读时长≈</span>
      <span class="post-count">3分</span>
    </span>
  </span>
</div>


  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="在openstack上的虚拟机绑定vip"><a href="#在openstack上的虚拟机绑定vip" class="headerlink" title="在openstack上的虚拟机绑定vip"></a>在openstack上的虚拟机绑定vip</h3><p>有些情况下，客户想在openstack的虚拟机上配置vip搭建高可用集群，下面我就简单的说下在openstack上的虚拟机如何绑定vip<br><a id="more"></a></p>
<h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><p>1、导入环境变量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> admin-openrc.sh</span></div></pre></td></tr></table></figure></p>
<p>2、执行命令neutron net-list查看网络，找到自己需要设置的网络，获取subnet_id和network_id<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron net-list</span></div><div class="line">+--------------------------------------+----------------------------------------------------+----------------------------------+-------------------------------------------------------+</div><div class="line">| id                                   | name                                               | tenant_id                        | subnets                                               |</div><div class="line">+--------------------------------------+----------------------------------------------------+----------------------------------+-------------------------------------------------------+</div><div class="line">| 32482d56-bb40-4b7f-85df-3be3a460e441 | HA network tenant 7ba30c1e519d4d6eb8f1ace2cfbf30d3 |                                  | 860bf95f-4775-4fac-af88-db392f254416 169.254.192.0/18 |</div><div class="line">| 7cc26554-2795-4a53-b053-34ec1b4c90f2 | web                                                | 7ba30c1e519d4d6eb8f1ace2cfbf30d3 | 4b1f707b-8842-4ce0-acba-4f0de304459b 192.168.1.0/24   |</div><div class="line">| d0ad534f-1bcd-43b0-aa0c-edee32520020 | public                                             | 21c161dda51147fb9ff527aadfe1d81a | 9a7f07e5-e906-4622-8bc6-def64b3622ec 172.18.23.0/24   |</div><div class="line">+--------------------------------------+----------------------------------------------------+----------------------------------+-------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p><img src="https://ljw.howieli.cn/blog/2017-11-28/net-list.png" alt=""><br>3、创建port来占用ip，保证neutron不会将此IP在分配出去，导致IP冲突问题。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">neutron port-create --fixed-ip subnet_id=&lt;subnet_id&gt;,ip_address=&lt;vip&gt; &lt;network_id&gt;</div><div class="line">注：</div><div class="line">	替换subnet_id为neutron net-list中查看到的subnet_id</div><div class="line">	替换vip为需要配置的vip地址</div><div class="line">	替换network_ID为neutron net-list中查看到的network_id</div></pre></td></tr></table></figure></p>
<p>具体命令如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron port-create --fixed-ip subnet_id=9a7f07e5<span class="_">-e</span>906-4622-8bc6-def64b3622ec,ip_address=172.18.23.10 d0ad534f-1bcd-43b0-aa0c-edee32520020</span></div><div class="line">Created a new port:</div><div class="line">+-----------------------+-------------------------------------------------------------------------------------+</div><div class="line">| Field                 | Value                                                                               |</div><div class="line">+-----------------------+-------------------------------------------------------------------------------------+</div><div class="line">| admin_state_up        | True                                                                                |</div><div class="line">| allowed_address_pairs |                                                                                     |</div><div class="line">| binding:host_id       |                                                                                     |</div><div class="line">| binding:profile       | &#123;&#125;                                                                                  |</div><div class="line">| binding:vif_details   | &#123;&#125;                                                                                  |</div><div class="line">| binding:vif_type      | unbound                                                                             |</div><div class="line">| binding:vnic_type     | normal                                                                              |</div><div class="line">| created_at            | 2017-11-28T02:35:17Z                                                                |</div><div class="line">| description           |                                                                                     |</div><div class="line">| device_id             |                                                                                     |</div><div class="line">| device_owner          |                                                                                     |</div><div class="line">| extra_dhcp_opts       |                                                                                     |</div><div class="line">| fixed_ips             | &#123;"subnet_id": "9a7f07e5-e906-4622-8bc6-def64b3622ec", "ip_address": "172.18.23.10"&#125; |</div><div class="line">| id                    | 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63                                                |</div><div class="line">| mac_address           | fa:16:3e:ea:81:a6                                                                   |</div><div class="line">| name                  |                                                                                     |</div><div class="line">| network_id            | d0ad534f-1bcd-43b0-aa0c-edee32520020                                                |</div><div class="line">| port_security_enabled | True                                                                                |</div><div class="line">| project_id            | 21c161dda51147fb9ff527aadfe1d81a                                                    |</div><div class="line">| revision_number       | 5                                                                                   |</div><div class="line">| security_groups       | abfba384-55f2-4eed-902a-712369be9604                                                |</div><div class="line">| status                | DOWN                                                                                |</div><div class="line">| tags                  |                                                                                     |</div><div class="line">| tenant_id             | 21c161dda51147fb9ff527aadfe1d81a                                                    |</div><div class="line">| updated_at            | 2017-11-28T02:35:18Z                                                                |</div><div class="line">+-----------------------+-------------------------------------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p><img src="https://ljw.howieli.cn/blog/2017-11-28/port-create.png" alt=""><br>4、执行命令<code>neutron port-list</code>查看端口，找到VIP的Port ID以及需要使用VIP的虚拟机的IP对应的Port id<br>比如两台虚拟机做HA绑定vip，那么需要查看两台虚拟机的port ID和这个vip的port ID<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron port-list|grep 172.18.23.10</span></div><div class="line">| 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63 |                                                 | 21c161dda51147fb9ff527aadfe1d81a | fa:16:3e:ea:81:a6 | &#123;"subnet_id": "9a7f07e5-e906-4622-8bc6-def64b3622ec", "ip_address": "172.18.23.10"&#125;  |</div></pre></td></tr></table></figure></p>
<p>可以看出vip<code>172.18.23.10</code>的port id为<code>7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</code>.<br>5、取消安全组对应端口的管理<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">neutron port-update --no-security-groups &lt;Port_id&gt;</div><div class="line">neutron port-update --port_security_enabled=false &lt;Port_id&gt;</div><div class="line">注：</div><div class="line">	    替换Port_id为之前neutron port-list中找到的Port_id</div></pre></td></tr></table></figure></p>
<p>具有命令如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron port-update --no-security-groups 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</span></div><div class="line">Updated port: 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</div><div class="line"><span class="meta">#</span><span class="bash"> neutron port-update --port_security_enabled=<span class="literal">false</span> 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</span></div><div class="line">Updated port: 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</div></pre></td></tr></table></figure></p>
<p>6、此时执行命令neutron port-show <port_id><br><img src="https://ljw.howieli.cn/blog/2017-11-28/port-show.png" alt=""><br>可看到port_security_enabled的value为False，security_groups的value为空，即OK，这样两个端口就没有了安全组了。<br>7、意思就是对VIP和需要使用VIP的虚拟机都执行4、5、6步，比如配置HA，VIP+两台虚拟机，总共3个Port，都需要执行4、5、6步<br>然后就可以在这两台虚拟机上搭建keepalived集群使用<code>172.18.23.10</code>这个vip了。</port_id></p>

    

    
    <div class="page-reward">
      <a href="javascript:void(0);" class="page-reward-btn tooltip-top" target="_self">
        <div class="tooltip tooltip-east">
          <span class="tooltip-item">
            赏
          </span>
          <span class="tooltip-content">
            <span class="tooltip-text">
              <span class="tooltip-inner">
                <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i
                    class="icon icon-quo-right"></i></p>
                <div class="reward-box">
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/alipay.jpg">
                    <span class="reward-type">支付宝</span>
                  </div>
                  
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/weixin.png">
                    <span class="reward-type">微信</span>
                  </div>
                  
                </div>
              </span>
            </span>
          </span>
        </div>
      </a>
    </div>
    

    
    <div class="declare"> 
      <ul class="post-copyright">
        <li>
          <strong>本文作者：</strong>
          李家旺
        </li>
        <li>
          <strong>本文链接：</strong>
          <a href="https://www.lijiawang.org/posts/在openstack上的虚拟机绑定vip.html" title="openstack虚拟机VIP配置步骤" target="_blank">https://www.lijiawang.org/posts/在openstack上的虚拟机绑定vip.html</a>
        </li>
        <li>
          <strong>版权声明： </strong>
          本博客所有文章除特别声明外，均采用 <a href="https://www.apache.org/licenses/LICENSE-2.0.html" rel="external nofollow" target="_blank">Apache License 2.0</a> 许可协议。转载请注明出处！
        </li>
      </ul>
    </div>
    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/openstack//" class="article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>


    

    
    
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <!-- <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a> -->
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
     <!-- <img src="//pan.baidu.com/share/qrcode?url=https://www.lijiawang.org/posts/在openstack上的虚拟机绑定vip.html" alt="微信分享二维码"> -->
    </div>
</div>

<div class="mask js-mask"></div>

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>


<nav id="article-nav">
  
    <a href="/posts/kolla部署swift.html" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          kolla部署swift
        
      </div>
    </a>
  
  
    <a href="/posts/kolla-pike-on-centos.html" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">kolla Pike on CentOS 7.4</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>













