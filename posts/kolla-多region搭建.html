<article id="post-kolla-多region搭建" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 class="article-title" itemprop="name">
      kolla 多region搭建
    </h1>
  


  
  
  
  
    
<div style="margin-top:10px;">
  <span class="post-time">
    <span class="post-meta-item-icon">
      <!-- fonts.scss -->
      <!-- 百度字体平台:http://fontstore.baidu.com/static/editor/index.html -->
      <i class="icon-statistics"></i>
      <span class="post-meta-item-text"> 字数统计:</span>
      <span class="post-count">780字</span>
    </span>
  </span>

  <span class="post-time">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
      <i class="icon-book icon"></i>
      <span class="post-meta-item-text"> 阅读时长≈</span>
      <span class="post-count">3分</span>
    </span>
  </span>
</div>


  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="kolla部署openstack多region"><a href="#kolla部署openstack多region" class="headerlink" title="kolla部署openstack多region"></a>kolla部署openstack多region</h3><h3 id="openstack多region基础知识"><a href="#openstack多region基础知识" class="headerlink" title="openstack多region基础知识"></a>openstack多region基础知识</h3><p>我们都知道<code>Region</code>是<code>OpenStack</code>里面用于隔离资源的一个重要概念。简单来说，一个<code>Region</code>对应一套完整的<code>OpenStack</code>环境，而<code>Region</code>和<code>Region</code>之间可以是跨机房的集群，也可以是一个大规模物理机集群分割后的集群。<code>OpenStack</code>在设计之初就是支持多<code>Region</code>的情况，由于<code>Region</code>之间资源（<code>Mariadb</code>,<code>RabbitMQ</code>等）的独立的，所以他们之间并不存在资源交互开销的情况。<br>简单的讲所谓<code>openstack</code>多<code>region</code>，就是多套<code>openstack</code>共享一个<code>keystone</code>和<code>horizon</code>。每个区域一套<code>openstack</code>环境，可以分布在不同的地理位置，只要网络可达就行。个人认为目的就是为了提供环境隔离的功能，选择启虚拟机的时候可以根据自己所处的位置就近选择。<br><img src="https://ljw.howieli.cn/blog/2018-4-3/%E5%A4%9Aregion1.png" alt=""><br><a id="more"></a></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>我这里有两台<code>kolla</code>环境的部署节点分别是<code>172.18.24.150</code>，<code>172.18.24.130</code>两个台虚拟机。<br>| column | column |<br>|——–|————|<br>|RegionOne|172.18.24.150|<br>|RegionTWO|172.18.24.130|<br><code>kolla</code>环境部署节点安装请参考<a href="https://www.lijiawang.org/posts/kolla%20queens%20on%20centos7.41.html">kolla搭建</a>，这次我用<code>kolla</code>部署<code>openstack</code>的<code>queens</code>版本。</p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="用Keystone和Horizon部署第一个区域"><a href="#用Keystone和Horizon部署第一个区域" class="headerlink" title="用Keystone和Horizon部署第一个区域"></a>用<code>Keystone</code>和<code>Horizon</code>部署第一个区域</h4><p>我这这里把<code>keystone</code>,<code>horizon</code>这两个服务放到<code>RegionOne</code>虚拟机上。修改配置<code>/etc/kolla/globals.yml</code>文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> egrep <span class="string">"^[^#]"</span> /etc/kolla/globals.yml</span></div><div class="line">---</div><div class="line">kolla_base_distro: "centos"</div><div class="line">kolla_install_type: "source"</div><div class="line">openstack_release: "queens"</div><div class="line">kolla_internal_vip_address: "172.18.24.150"</div><div class="line">docker_namespace: "kolla"</div><div class="line">network_interface: "eth0"</div><div class="line">neutron_external_interface: "eth1"</div><div class="line">enable_haproxy: "no"</div><div class="line">enable_grafana: "yes"</div><div class="line">enable_horizon_ironic: "&#123;&#123; enable_ironic | bool &#125;&#125;"</div><div class="line">ironic_dnsmasq_dhcp_range:</div><div class="line">tempest_image_id:</div><div class="line">tempest_flavor_ref_id:</div><div class="line">tempest_public_network_id:</div><div class="line">tempest_floating_network_name:</div><div class="line">openstack_region_name: "RegionOne"</div><div class="line">multiple_regions_names:</div><div class="line">    - "&#123;&#123; openstack_region_name &#125;&#125;"</div><div class="line">    - "RegionTwo"</div></pre></td></tr></table></figure></p>
<p>部署<code>RegionOne</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible deploy</span></div></pre></td></tr></table></figure></p>
<h4 id="部署其他区域"><a href="#部署其他区域" class="headerlink" title="部署其他区域"></a>部署其他区域</h4><p>修改<code>RegionTWO</code>的<code>/etc/kolla/globals.yml</code>文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> egrep <span class="string">"^[^#]"</span> /etc/kolla/globals.yml</span></div><div class="line">---</div><div class="line">kolla_base_distro: "centos"</div><div class="line">kolla_install_type: "source"</div><div class="line">openstack_release: "queens"</div><div class="line">kolla_internal_vip_address: "172.18.24.130"</div><div class="line">docker_namespace: "kolla"</div><div class="line">network_interface: "eth0"</div><div class="line">neutron_external_interface: "eth1"</div><div class="line">nova_console: "novnc"</div><div class="line">enable_keystone: "no"</div><div class="line">enable_haproxy: "no"</div><div class="line">enable_horizon: "no"</div><div class="line">nova_compute_virt_type: "qemu"</div><div class="line">tempest_image_id:</div><div class="line">tempest_flavor_ref_id:</div><div class="line">tempest_public_network_id:</div><div class="line">tempest_floating_network_name:</div><div class="line"><span class="meta">#</span><span class="bash"> kolla_internal_fqdn_r1是指RegionOne中kolla_internal_fqdn的值</span></div><div class="line">kolla_internal_fqdn_r1: 172.18.24.150</div><div class="line">keystone_admin_url: "&#123;&#123; admin_protocol &#125;&#125;://&#123;&#123; kolla_internal_fqdn_r1 &#125;&#125;:&#123;&#123; keystone_admin_port &#125;&#125;"</div><div class="line">keystone_internal_url: "&#123;&#123; internal_protocol &#125;&#125;://&#123;&#123; kolla_internal_fqdn_r1 &#125;&#125;:&#123;&#123; keystone_public_port &#125;&#125;"</div><div class="line">openstack_auth:</div><div class="line">    auth_url: "&#123;&#123; admin_protocol &#125;&#125;://&#123;&#123; kolla_internal_fqdn_r1 &#125;&#125;:&#123;&#123; keystone_admin_port &#125;&#125;"</div><div class="line">    username: "admin"</div><div class="line">    password: "&#123;&#123; keystone_admin_password &#125;&#125;"</div><div class="line">    project_name: "admin"</div><div class="line">    domain_name: "default"</div><div class="line">openstack_region_name: "RegionTwo"</div></pre></td></tr></table></figure></p>
<h4 id="RegionTWO上的openstack组件连接RegionOne上的keystone"><a href="#RegionTWO上的openstack组件连接RegionOne上的keystone" class="headerlink" title="RegionTWO上的openstack组件连接RegionOne上的keystone"></a>RegionTWO上的openstack组件连接RegionOne上的keystone</h4><p>需要修改<code>cinder</code>，<code>nova</code>，<code>neutron</code>，<code>glance</code>等配置文件才能联系<code>RegionOne</code>的<code>Keystone</code>。在<code>RegionTWO</code>虚拟机上创建<code>/etc/kolla/config/</code>目录,然后穿件需要连接<code>Keystone</code>服务的配置文件。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir -p /etc/kolla/config/</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/kolla/config/</span></div><div class="line"><span class="meta">#</span><span class="bash"> tree</span></div><div class="line">.</div><div class="line">├── glance.conf</div><div class="line">├── heat.conf</div><div class="line">├── neutron.conf</div><div class="line">└── nova.conf</div></pre></td></tr></table></figure></p>
<p>更新配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cat glance.conf</span></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = &#123;&#123; keystone_internal_url &#125;&#125;</div><div class="line">auth_url = &#123;&#123; keystone_admin_url &#125;&#125;</div><div class="line"><span class="meta">#</span><span class="bash"> cat nova.conf</span></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = &#123;&#123; keystone_internal_url &#125;&#125;</div><div class="line">auth_url = &#123;&#123; keystone_admin_url &#125;&#125;</div><div class="line">[placement]</div><div class="line">auth_url = &#123;&#123; keystone_admin_url &#125;&#125;</div><div class="line"><span class="meta">#</span><span class="bash"> cat neutron.conf</span></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = &#123;&#123; keystone_internal_url &#125;&#125;</div><div class="line">auth_url = &#123;&#123; keystone_admin_url &#125;&#125;</div><div class="line"><span class="meta">#</span><span class="bash"> cat heat.conf</span></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = &#123;&#123; keystone_internal_url &#125;&#125;</div><div class="line">auth_url = &#123;&#123; keystone_admin_url &#125;&#125;</div><div class="line">[trustee]</div><div class="line">auth_uri = &#123;&#123; keystone_internal_url &#125;&#125;</div><div class="line">auth_url = &#123;&#123; keystone_internal_url &#125;&#125;</div><div class="line"></div><div class="line">[ec2authtoken]</div><div class="line">auth_uri = &#123;&#123; keystone_internal_url &#125;&#125;</div><div class="line"></div><div class="line">[clients_keystone]</div><div class="line">auth_uri = &#123;&#123; keystone_internal_url &#125;&#125;</div></pre></td></tr></table></figure></p>
<p>部署<code>RegionTWO</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible deploy</span></div></pre></td></tr></table></figure></p>
<h3 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h3><p>如果以上过程顺利，恭喜你，你的<code>OpenStack</code>现在也支持多区域了。<br><img src="https://ljw.howieli.cn/blog/2018-4-3/%E5%A4%9Aregion.png" alt=""><br><img src="https://ljw.howieli.cn/blog/2018-4-3/%E5%A4%9Aregion2.png" alt=""></p>
<h3 id="Ocata版本多region搭建"><a href="#Ocata版本多region搭建" class="headerlink" title="Ocata版本多region搭建"></a>Ocata版本多region搭建</h3><p>如果您用的是<code>openstack</code>的<code>Ocata</code>版本，需要打一下<code>patch</code>，在部署，<a href="https://review.openstack.org/#/q/project:openstack/kolla-ansible+region" target="_blank" rel="external">这里可以看到所有多region相关bug</a>，除了下面这个没放进去，都<code>merge</code>到<code>ocata</code>。需要把这个<code>patch</code>自己打进去即可。<br><a href="https://review.openstack.org/#/c/431658/" target="_blank" rel="external">https://review.openstack.org/#/c/431658/</a></p>

    

    
    <div class="page-reward">
      <a href="javascript:void(0);" class="page-reward-btn tooltip-top" target="_self">
        <div class="tooltip tooltip-east">
          <span class="tooltip-item">
            赏
          </span>
          <span class="tooltip-content">
            <span class="tooltip-text">
              <span class="tooltip-inner">
                <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i
                    class="icon icon-quo-right"></i></p>
                <div class="reward-box">
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/alipay.jpg">
                    <span class="reward-type">支付宝</span>
                  </div>
                  
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/weixin.png">
                    <span class="reward-type">微信</span>
                  </div>
                  
                </div>
              </span>
            </span>
          </span>
        </div>
      </a>
    </div>
    

    
    <div class="declare"> 
      <ul class="post-copyright">
        <li>
          <strong>本文作者：</strong>
          李家旺
        </li>
        <li>
          <strong>本文链接：</strong>
          <a href="https://www.lijiawang.org/posts/kolla-多region搭建.html" title="kolla 多region搭建" target="_blank">https://www.lijiawang.org/posts/kolla-多region搭建.html</a>
        </li>
        <li>
          <strong>版权声明： </strong>
          本博客所有文章除特别声明外，均采用 <a href="https://www.apache.org/licenses/LICENSE-2.0.html" rel="external nofollow" target="_blank">Apache License 2.0</a> 许可协议。转载请注明出处！
        </li>
      </ul>
    </div>
    

  </div>
  <div class="article-info article-info-index">
    
    
    

    

    
    
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <!-- <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a> -->
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
     <!-- <img src="//pan.baidu.com/share/qrcode?url=https://www.lijiawang.org/posts/kolla-多region搭建.html" alt="微信分享二维码"> -->
    </div>
</div>

<div class="mask js-mask"></div>

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>


<nav id="article-nav">
  
    <a href="/posts/openstack对接ceph存储.html" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          ceph-for-openstack-storage
        
      </div>
    </a>
  
  
    <a href="/posts/kolla queens on centos7.41.html" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">kolla queens on centos7.4</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>













