

  
    <article id="post-openstack instance vm_power_state 状态置为 NOSTATE" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/openstack instance vm_power_state 状态置为 NOSTATE.html" target="_blank">openstack instance vm_power_state 状态置为 NOSTATE</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="openstack-上的instance运行正常，但是power-state状态为NOSTATE，导致instance热迁移失败"><a href="#openstack-上的instance运行正常，但是power-state状态为NOSTATE，导致instance热迁移失败" class="headerlink" title="openstack 上的instance运行正常，但是power_state状态为NOSTATE，导致instance热迁移失败"></a>openstack 上的instance运行正常，但是power_state状态为NOSTATE，导致instance热迁移失败</h3><h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p>1、再一次热迁移时候发现迁移时候报以下错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># openstack server migrate --live node-53 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">Cannot &apos;os-migrateLive&apos; instance 86487ef4-cc12-4be6-995e-46f5ac093901 while it is in power_state 0 (HTTP 409) (Request-ID: req-6c14e0ee-c3df-42de-873d-9ecc8ad215cc)</div></pre></td></tr></table></figure></p>
<p>2、查看实例，发现虚拟机运行正常，但是 power_state 为 NOSTATE<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"># openstack server show 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| Field                               | Value                                                          |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| OS-DCF:diskConfig                   | MANUAL                                                         |</div><div class="line">| OS-EXT-AZ:availability_zone         | m_cpu+san                                                      |</div><div class="line">| OS-EXT-SRV-ATTR:host                | node-27                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | node-27                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:instance_name       | instance-000071aa                                              |</div><div class="line">| OS-EXT-STS:power_state              | NOSTATE                                                        |</div><div class="line">| OS-EXT-STS:task_state               | None                                                           |</div><div class="line">| OS-EXT-STS:vm_state                 | active                                                         |</div><div class="line">| OS-SRV-USG:launched_at              | 2018-09-21T05:40:36.000000                                     |</div><div class="line">| OS-SRV-USG:terminated_at            | None                                                           |</div><div class="line">| accessIPv4                          |                                                                |</div><div class="line">| accessIPv6                          |                                                                |</div><div class="line">| addresses                           | vlan_10.122.44.0/23=10.122.45.53                               |</div><div class="line">| config_drive                        | True                                                           |</div><div class="line">| created                             | 2018-09-21T05:40:31Z                                           |</div><div class="line">| flavor                              | 16-64-100 (1cbe4ea1-8a67-4027-afd4-8f31a8b94851)               |</div><div class="line">| hostId                              | 2730fa3d62e347ddb67e155f6eed973787a868c82316f7e6ba641b10       |</div><div class="line">| id                                  | 86487ef4-cc12-4be6-995e-46f5ac093901                           |</div><div class="line">| image                               | lenovo-centos-7-release (b9f8f864-4217-4ac6-a116-62ecfa0fc074) |</div><div class="line">| key_name                            | None                                                           |</div><div class="line">| name                                | SLP3YM7HRCX                                                    |</div><div class="line">| progress                            | 100                                                            |</div><div class="line">| project_id                          | e992715df18a417997c068e5f9834b0f                               |</div><div class="line">| properties                          |                                                                |</div><div class="line">| security_groups                     | name=&apos;default&apos;                                                 |</div><div class="line">| status                              | ACTIVE                                                         |</div><div class="line">| updated                             | 2019-10-09T07:58:58Z                                           |</div><div class="line">| user_id                             | af518aeb935c4d258f8cb7d302c83797                               |</div><div class="line">| volumes_attached                    | id=&apos;a821856b-409f-4e6e-becd-eb4b2344c7d8&apos;                      |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="查找原因"><a href="#查找原因" class="headerlink" title="查找原因"></a>查找原因</h3><p>列出该虚拟机的历史操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># nova instance-action-list 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">+----------------+------------------------------------------+---------+----------------------------+</div><div class="line">| Action         | Request_ID                               | Message | Start_Time                 |</div><div class="line">+----------------+------------------------------------------+---------+----------------------------+</div><div class="line">| create         | req-4d01a466-ce7a-48a9-b575-e129b61bcc30 | -       | 2018-09-21T05:40:30.000000 |</div><div class="line">| live-migration | req-2d93bc73-e43f-4ca6-88fc-a6ad1a4021a6 | -       | 2018-09-21T05:44:47.000000 |</div><div class="line">| live-migration | req-7fcbfb15-7e3c-471d-8ea5-020d438d23c3 | -       | 2019-03-24T13:00:30.000000 |</div><div class="line">| live-migration | req-2b009c4f-caef-4d90-81fd-d480c1b9efad | Error   | 2019-10-09T07:00:13.000000 |</div><div class="line">| live-migration | req-b364724b-6b28-4d5f-8f14-05d1c4abeceb | Error   | 2019-10-09T07:07:37.000000 |</div><div class="line">| live-migration | req-8669d3b1-e57e-4b35-8d40-a110b64f47c8 | Error   | 2019-10-09T07:29:13.000000 |</div><div class="line">| live-migration | req-ecec98ca-3777-4ca3-afcd-83e36381e038 | Error   | 2019-10-09T07:55:12.000000 |</div><div class="line">| live-migration | req-6378f839-89c0-43c0-8a65-40e5b775283c | Error   | 2019-10-09T07:58:14.000000 |</div><div class="line">| live-migration | req-e966caa7-06e5-4a29-a371-517d98c37121 | Error   | 2019-10-09T07:58:58.000000 |</div><div class="line">| live-migration | req-6c14e0ee-c3df-42de-873d-9ecc8ad215cc | Error   | 2019-10-09T08:31:47.000000 |</div><div class="line">+----------------+------------------------------------------+---------+----------------------------+</div></pre></td></tr></table></figure></p>
<p>列出该实例的迁移记录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"># nova  migration-list|grep 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">| 84892 | -           | -         | node-27        | node-29            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-10-09T07:07:37.000000 | 2019-10-09T07:07:37.000000 | live-migration |</div><div class="line">| 54307 | -           | -         | node-27        | node-53            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-03-24T13:00:30.000000 | 2019-03-24T17:10:10.000000 | live-migration |</div><div class="line">| 84904 | -           | -         | node-27        | node-53            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-10-09T07:29:13.000000 | 2019-10-09T07:29:13.000000 | live-migration |</div><div class="line">| 84913 | -           | -         | node-27        | node-53            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-10-09T07:55:12.000000 | 2019-10-09T07:55:12.000000 | live-migration |</div><div class="line">| 84919 | -           | -         | node-27        | node-53            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-10-09T07:58:14.000000 | 2019-10-09T07:58:14.000000 | live-migration |</div><div class="line">| 84922 | -           | -         | node-27        | node-53            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-10-09T07:58:58.000000 | 2019-10-09T07:58:58.000000 | live-migration |</div><div class="line">| 84931 | -           | -         | node-27        | node-53            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-10-09T08:31:47.000000 | 2019-10-09T08:31:47.000000 | live-migration |</div><div class="line">| 84889 | -           | -         | node-27        | node-89            | -            | error         | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2019-10-09T07:00:13.000000 | 2019-10-09T07:00:13.000000 | live-migration |</div><div class="line">| 42241 | -           | -         | node-33        | node-27            | -            | completed     | 86487ef4-cc12-4be6-995e-46f5ac093901 | 189        | 189        | 2018-09-21T05:44:48.000000 | 2018-09-21T05:45:13.000000 | live-migration |</div><div class="line">可以看到该实例从node-27节点迁移到node-85、node-53、node-29节点均为迁移成功</div><div class="line">查看instance所在的节点</div><div class="line"># ssh node-27</div><div class="line"></div><div class="line">root@node-27:~# virsh list --all|grep instance-000071aa </div><div class="line">root@node-27:~# exit</div><div class="line">logout</div><div class="line">Connection to node-27 closed.</div><div class="line"># ssh node-53</div><div class="line"></div><div class="line">root@node-53:~#  virsh list --all|grep instance-000071aa</div><div class="line"> 91    instance-000071aa              running</div><div class="line">root@node-53:~# exit</div><div class="line">logout</div><div class="line">Connection to node-53 closed.</div><div class="line"># openstack server show 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| Field                               | Value                                                          |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| OS-DCF:diskConfig                   | MANUAL                                                         |</div><div class="line">| OS-EXT-AZ:availability_zone         | m_cpu+san                                                      |</div><div class="line">| OS-EXT-SRV-ATTR:host                | node-27                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | node-27                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:instance_name       | instance-000071aa                                              |</div><div class="line">| OS-EXT-STS:power_state              | NOSTATE                                                        |</div><div class="line">| OS-EXT-STS:task_state               | None                                                           |</div><div class="line">| OS-EXT-STS:vm_state                 | active                                                         |</div><div class="line">| OS-SRV-USG:launched_at              | 2018-09-21T05:40:36.000000                                     |</div><div class="line">| OS-SRV-USG:terminated_at            | None                                                           |</div><div class="line">| accessIPv4                          |                                                                |</div><div class="line">| accessIPv6                          |                                                                |</div><div class="line">| addresses                           | vlan_10.122.44.0/23=10.122.45.53                               |</div><div class="line">| config_drive                        | True                                                           |</div><div class="line">| created                             | 2018-09-21T05:40:31Z                                           |</div><div class="line">| flavor                              | 16-64-100 (1cbe4ea1-8a67-4027-afd4-8f31a8b94851)               |</div><div class="line">| hostId                              | 2730fa3d62e347ddb67e155f6eed973787a868c82316f7e6ba641b10       |</div><div class="line">| id                                  | 86487ef4-cc12-4be6-995e-46f5ac093901                           |</div><div class="line">| image                               | lenovo-centos-7-release (b9f8f864-4217-4ac6-a116-62ecfa0fc074) |</div><div class="line">| key_name                            | None                                                           |</div><div class="line">| name                                | SLP3YM7HRCX                                                    |</div><div class="line">| progress                            | 100                                                            |</div><div class="line">| project_id                          | e992715df18a417997c068e5f9834b0f                               |</div><div class="line">| properties                          |                                                                |</div><div class="line">| security_groups                     | name=&apos;default&apos;                                                 |</div><div class="line">| status                              | ACTIVE                                                         |</div><div class="line">| updated                             | 2019-10-09T08:31:47Z                                           |</div><div class="line">| user_id                             | af518aeb935c4d258f8cb7d302c83797                               |</div><div class="line">| volumes_attached                    | id=&apos;a821856b-409f-4e6e-becd-eb4b2344c7d8&apos;                      |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">root@node-1:~# mysql -unova -pnova</div><div class="line">MariaDB [(none)]&gt; select * from nova.instances where uuid=&apos;86487ef4-cc12-4be6-995e-46f5ac093901&apos;\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">              created_at: 2018-09-21 05:40:31</div><div class="line">              updated_at: 2019-10-09 08:31:47</div><div class="line">              deleted_at: NULL</div><div class="line">                      id: 29098</div><div class="line">             internal_id: NULL</div><div class="line">                 user_id: af518aeb935c4d258f8cb7d302c83797</div><div class="line">              project_id: e992715df18a417997c068e5f9834b0f</div><div class="line">               image_ref: b9f8f864-4217-4ac6-a116-62ecfa0fc074</div><div class="line">               kernel_id: </div><div class="line">              ramdisk_id: </div><div class="line">            launch_index: 0</div><div class="line">                key_name: NULL</div><div class="line">                key_data: NULL</div><div class="line">             power_state: 0</div><div class="line">                vm_state: active</div><div class="line">               memory_mb: 65536</div><div class="line">                   vcpus: 16</div><div class="line">                hostname: slp3ym7hrcx</div><div class="line">                    host: node-27</div><div class="line">               user_data: NULL</div><div class="line">          reservation_id: r-o8dr8ibn</div><div class="line">             launched_at: 2018-09-21 05:40:36</div><div class="line">           terminated_at: NULL</div><div class="line">            display_name: SLP3YM7HRCX</div><div class="line">     display_description: SLP3YM7HRCX</div><div class="line">       availability_zone: no_san</div><div class="line">                  locked: 0</div><div class="line">                 os_type: NULL</div><div class="line">             launched_on: node-33</div><div class="line">        instance_type_id: 189</div><div class="line">                 vm_mode: NULL</div><div class="line">                    uuid: 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">            architecture: NULL</div><div class="line">        root_device_name: /dev/vda</div><div class="line">            access_ip_v4: NULL</div><div class="line">            access_ip_v6: NULL</div><div class="line">            config_drive: True</div><div class="line">              task_state: NULL</div><div class="line">default_ephemeral_device: NULL</div><div class="line">     default_swap_device: NULL</div><div class="line">                progress: 100</div><div class="line">        auto_disk_config: 0</div><div class="line">      shutdown_terminate: 0</div><div class="line">       disable_terminate: 0</div><div class="line">                 root_gb: 100</div><div class="line">            ephemeral_gb: 0</div><div class="line">               cell_name: NULL</div><div class="line">                    node: node-27</div><div class="line">                 deleted: 0</div><div class="line">               locked_by: NULL</div><div class="line">                 cleaned: 1</div><div class="line">      ephemeral_key_uuid: NULL</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">ERROR: No query specified</div></pre></td></tr></table></figure></p>
<p>发现实际instance启动在node-53节点上，但是数据库记录在node-27节点上</p>
<p>manager.py 捕获到 InstanceNotFound 设置 vm_power_state=NOSTATE<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/usr/lib/python2<span class="number">.7</span>/dist-packages/nova/compute/manager.py</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_query_driver_power_state_and_sync</span><span class="params">(self, context, db_instance)</span>:</span></div><div class="line">        <span class="keyword">if</span> db_instance.task_state <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            LOG.info(_LI(<span class="string">"During sync_power_state the instance has a "</span></div><div class="line">                         <span class="string">"pending task (%(task)s). Skip."</span>),</div><div class="line">                     &#123;<span class="string">'task'</span>: db_instance.task_state&#125;, instance=db_instance)</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="comment"># No pending tasks. Now try to figure out the real vm_power_state.</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            vm_instance = self.driver.get_info(db_instance)</div><div class="line">            vm_power_state = vm_instance.state</div><div class="line">        <span class="keyword">except</span> exception.InstanceNotFound:         <span class="comment"># 可以看到如果InstanceNotFound</span></div><div class="line">            vm_power_state = power_state.NOSTATE   <span class="comment"># power_state设置为NOSTATE</span></div><div class="line">        <span class="comment"># Note(maoy): the above get_info call might take a long time,</span></div><div class="line">        <span class="comment"># for example, because of a broken libvirt driver.</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self._sync_instance_power_state(context,</div><div class="line">                                            db_instance,</div><div class="line">                                            vm_power_state,</div><div class="line">                                            use_slave=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">except</span> exception.InstanceNotFound:</div><div class="line">            <span class="comment"># NOTE(hanlind): If the instance gets deleted during sync,</span></div><div class="line">            <span class="comment"># silently ignore.</span></div><div class="line">            <span class="keyword">pass</span></div></pre></td></tr></table></figure></p>
<h3 id="得到原因"><a href="#得到原因" class="headerlink" title="得到原因"></a>得到原因</h3><p>由于之前 migrate ERROR 导致 instance 实际启动的节点和数据库记录的节点不一致，comoute 通过 manager.py 捕获到 InstanceNotFound， 所以把 vm_power_state 状态置为 NOSTATE</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>更新数据库，将数据库中的instance对应的host、node更新成实际instance启动的节点信息。硬重启虚拟机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div></pre></td><td class="code"><pre><div class="line">root@node-1:~# mysql -unova -pnova</div><div class="line">MariaDB [(none)]&gt; update nova.instances set host=&apos;node-53&apos; where uuid=&apos;86487ef4-cc12-4be6-995e-46f5ac093901&apos;\G;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line">Rows matched: 1  Changed: 1  Warnings: 0</div><div class="line"></div><div class="line">ERROR: No query specified</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; update nova.instances set node=&apos;node-53&apos; where uuid=&apos;86487ef4-cc12-4be6-995e-46f5ac093901&apos;\G;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line">Rows matched: 1  Changed: 1  Warnings: 0</div><div class="line"></div><div class="line">ERROR: No query specified</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; select * from nova.instances where uuid=&apos;86487ef4-cc12-4be6-995e-46f5ac093901&apos;\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">              created_at: 2018-09-21 05:40:31</div><div class="line">              updated_at: 2019-10-09 08:31:47</div><div class="line">              deleted_at: NULL</div><div class="line">                      id: 29098</div><div class="line">             internal_id: NULL</div><div class="line">                 user_id: af518aeb935c4d258f8cb7d302c83797</div><div class="line">              project_id: e992715df18a417997c068e5f9834b0f</div><div class="line">               image_ref: b9f8f864-4217-4ac6-a116-62ecfa0fc074</div><div class="line">               kernel_id: </div><div class="line">              ramdisk_id: </div><div class="line">            launch_index: 0</div><div class="line">                key_name: NULL</div><div class="line">                key_data: NULL</div><div class="line">             power_state: 0</div><div class="line">                vm_state: active</div><div class="line">               memory_mb: 65536</div><div class="line">                   vcpus: 16</div><div class="line">                hostname: slp3ym7hrcx</div><div class="line">                    host: node-53</div><div class="line">               user_data: NULL</div><div class="line">          reservation_id: r-o8dr8ibn</div><div class="line">             launched_at: 2018-09-21 05:40:36</div><div class="line">           terminated_at: NULL</div><div class="line">            display_name: SLP3YM7HRCX</div><div class="line">     display_description: SLP3YM7HRCX</div><div class="line">       availability_zone: no_san</div><div class="line">                  locked: 0</div><div class="line">                 os_type: NULL</div><div class="line">             launched_on: node-33</div><div class="line">        instance_type_id: 189</div><div class="line">                 vm_mode: NULL</div><div class="line">                    uuid: 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">            architecture: NULL</div><div class="line">        root_device_name: /dev/vda</div><div class="line">            access_ip_v4: NULL</div><div class="line">            access_ip_v6: NULL</div><div class="line">            config_drive: True</div><div class="line">              task_state: NULL</div><div class="line">default_ephemeral_device: NULL</div><div class="line">     default_swap_device: NULL</div><div class="line">                progress: 100</div><div class="line">        auto_disk_config: 0</div><div class="line">      shutdown_terminate: 0</div><div class="line">       disable_terminate: 0</div><div class="line">                 root_gb: 100</div><div class="line">            ephemeral_gb: 0</div><div class="line">               cell_name: NULL</div><div class="line">                    node: node-53</div><div class="line">                 deleted: 0</div><div class="line">               locked_by: NULL</div><div class="line">                 cleaned: 1</div><div class="line">      ephemeral_key_uuid: NULL</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">ERROR: No query specified</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; exit</div><div class="line">Bye</div><div class="line"># openstack server show 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| Field                               | Value                                                          |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| OS-DCF:diskConfig                   | MANUAL                                                         |</div><div class="line">| OS-EXT-AZ:availability_zone         | no_san                                                         |</div><div class="line">| OS-EXT-SRV-ATTR:host                | node-53                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | node-53                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:instance_name       | instance-000071aa                                              |</div><div class="line">| OS-EXT-STS:power_state              | NOSTATE                                                        |</div><div class="line">| OS-EXT-STS:task_state               | None                                                           |</div><div class="line">| OS-EXT-STS:vm_state                 | active                                                         |</div><div class="line">| OS-SRV-USG:launched_at              | 2018-09-21T05:40:36.000000                                     |</div><div class="line">| OS-SRV-USG:terminated_at            | None                                                           |</div><div class="line">| accessIPv4                          |                                                                |</div><div class="line">| accessIPv6                          |                                                                |</div><div class="line">| addresses                           | vlan_10.122.44.0/23=10.122.45.53                               |</div><div class="line">| config_drive                        | True                                                           |</div><div class="line">| created                             | 2018-09-21T05:40:31Z                                           |</div><div class="line">| flavor                              | 16-64-100 (1cbe4ea1-8a67-4027-afd4-8f31a8b94851)               |</div><div class="line">| hostId                              | f5274ebe433297bc376a4ce09151591735a04d2b6762280866de2729       |</div><div class="line">| id                                  | 86487ef4-cc12-4be6-995e-46f5ac093901                           |</div><div class="line">| image                               | lenovo-centos-7-release (b9f8f864-4217-4ac6-a116-62ecfa0fc074) |</div><div class="line">| key_name                            | None                                                           |</div><div class="line">| name                                | SLP3YM7HRCX                                                    |</div><div class="line">| progress                            | 100                                                            |</div><div class="line">| project_id                          | e992715df18a417997c068e5f9834b0f                               |</div><div class="line">| properties                          |                                                                |</div><div class="line">| security_groups                     | name=&apos;default&apos;                                                 |</div><div class="line">| status                              | ACTIVE                                                         |</div><div class="line">| updated                             | 2019-10-09T08:31:47Z                                           |</div><div class="line">| user_id                             | af518aeb935c4d258f8cb7d302c83797                               |</div><div class="line">| volumes_attached                    | id=&apos;a821856b-409f-4e6e-becd-eb4b2344c7d8&apos;                      |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"># nova reboot --hard 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line"></div><div class="line"># openstack  server show 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| Field                               | Value                                                          |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| OS-DCF:diskConfig                   | MANUAL                                                         |</div><div class="line">| OS-EXT-AZ:availability_zone         | no_san                                                         |</div><div class="line">| OS-EXT-SRV-ATTR:host                | node-53                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | node-53                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:instance_name       | instance-000071aa                                              |</div><div class="line">| OS-EXT-STS:power_state              | Running                                                        |</div><div class="line">| OS-EXT-STS:task_state               | None                                                           |</div><div class="line">| OS-EXT-STS:vm_state                 | active                                                         |</div><div class="line">| OS-SRV-USG:launched_at              | 2018-09-21T05:40:36.000000                                     |</div><div class="line">| OS-SRV-USG:terminated_at            | None                                                           |</div><div class="line">| accessIPv4                          |                                                                |</div><div class="line">| accessIPv6                          |                                                                |</div><div class="line">| addresses                           | vlan_10.122.44.0/23=10.122.45.53                               |</div><div class="line">| config_drive                        | True                                                           |</div><div class="line">| created                             | 2018-09-21T05:40:31Z                                           |</div><div class="line">| flavor                              | 16-64-100 (1cbe4ea1-8a67-4027-afd4-8f31a8b94851)               |</div><div class="line">| hostId                              | 4bfe001f6fa4d443f283121b56139ef8bfbff47be8106387cc19edc6       |</div><div class="line">| id                                  | 86487ef4-cc12-4be6-995e-46f5ac093901                           |</div><div class="line">| image                               | lenovo-centos-7-release (b9f8f864-4217-4ac6-a116-62ecfa0fc074) |</div><div class="line">| key_name                            | None                                                           |</div><div class="line">| name                                | SLP3YM7HRCX                                                    |</div><div class="line">| progress                            | 0                                                              |</div><div class="line">| project_id                          | e992715df18a417997c068e5f9834b0f                               |</div><div class="line">| properties                          |                                                                |</div><div class="line">| security_groups                     | name=&apos;default&apos;                                                 |</div><div class="line">| status                              | ACTIVE                                                         |</div><div class="line">| updated                             | 2019-10-09T10:04:19Z                                           |</div><div class="line">| user_id                             | af518aeb935c4d258f8cb7d302c83797                               |</div><div class="line">| volumes_attached                    | id=&apos;a821856b-409f-4e6e-becd-eb4b2344c7d8&apos;                      |</div><div class="line">|                                     | id=&apos;ff7d2dad-1954-4906-ae18-95c76a09b442&apos;                      |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line"></div><div class="line"># openstack server migrate --live node-89 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line"></div><div class="line"># openstack  server show 86487ef4-cc12-4be6-995e-46f5ac093901</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| Field                               | Value                                                          |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div><div class="line">| OS-DCF:diskConfig                   | MANUAL                                                         |</div><div class="line">| OS-EXT-AZ:availability_zone         | Contingency                                                    |</div><div class="line">| OS-EXT-SRV-ATTR:host                | node-89                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | node-89                                                        |</div><div class="line">| OS-EXT-SRV-ATTR:instance_name       | instance-000071aa                                              |</div><div class="line">| OS-EXT-STS:power_state              | Running                                                        |</div><div class="line">| OS-EXT-STS:task_state               | None                                                           |</div><div class="line">| OS-EXT-STS:vm_state                 | active                                                         |</div><div class="line">| OS-SRV-USG:launched_at              | 2018-09-21T05:40:36.000000                                     |</div><div class="line">| OS-SRV-USG:terminated_at            | None                                                           |</div><div class="line">| accessIPv4                          |                                                                |</div><div class="line">| accessIPv6                          |                                                                |</div><div class="line">| addresses                           | vlan_10.122.44.0/23=10.122.45.53                               |</div><div class="line">| config_drive                        | True                                                           |</div><div class="line">| created                             | 2018-09-21T05:40:31Z                                           |</div><div class="line">| flavor                              | 16-64-100 (1cbe4ea1-8a67-4027-afd4-8f31a8b94851)               |</div><div class="line">| hostId                              | 4bfe001f6fa4d443f283121b56139ef8bfbff47be8106387cc19edc6       |</div><div class="line">| id                                  | 86487ef4-cc12-4be6-995e-46f5ac093901                           |</div><div class="line">| image                               | lenovo-centos-7-release (b9f8f864-4217-4ac6-a116-62ecfa0fc074) |</div><div class="line">| key_name                            | None                                                           |</div><div class="line">| name                                | SLP3YM7HRCX                                                    |</div><div class="line">| progress                            | 0                                                              |</div><div class="line">| project_id                          | e992715df18a417997c068e5f9834b0f                               |</div><div class="line">| properties                          |                                                                |</div><div class="line">| security_groups                     | name=&apos;default&apos;                                                 |</div><div class="line">| status                              | ACTIVE                                                         |</div><div class="line">| updated                             | 2019-10-09T10:04:19Z                                           |</div><div class="line">| user_id                             | af518aeb935c4d258f8cb7d302c83797                               |</div><div class="line">| volumes_attached                    | id=&apos;a821856b-409f-4e6e-becd-eb4b2344c7d8&apos;                      |</div><div class="line">|                                     | id=&apos;ff7d2dad-1954-4906-ae18-95c76a09b442&apos;                      |</div><div class="line">+-------------------------------------+----------------------------------------------------------------+</div></pre></td></tr></table></figure></p>

    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/openstack//" class="article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/openstack instance vm_power_state 状态置为 NOSTATE.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-kubeadm升级k8s集群(v1.15.3 to v1.16.0版)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/kubeadm升级k8s集群(v1.15.3 to v1.16.0版).html" target="_blank">使用kubeadm升级kubernetes集群</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="kubeadm升级k8s集群-v1-15-3-to-v1-16-0版"><a href="#kubeadm升级k8s集群-v1-15-3-to-v1-16-0版" class="headerlink" title="kubeadm升级k8s集群(v1.15.3 to v1.16.0版)"></a><code>kubeadm</code>升级<code>k8s</code>集群(<code>v1.15.3 to v1.16.0</code>版)</h3><blockquote>
<p><code>Kubernetes</code>在2019年9月18日发布了年度的第三个版本<code>1.16</code>,本篇文章介绍使用<code>kubeadm</code>升级现在有的集群到<code>v1.16.0</code>。</p>
</blockquote>
<h3 id="Kubernetes-1-16版本的发布徽章"><a href="#Kubernetes-1-16版本的发布徽章" class="headerlink" title="Kubernetes 1.16版本的发布徽章"></a><code>Kubernetes 1.16</code>版本的发布徽章</h3><p><img src="https://ljw.howieli.cn/blog/2019-9-23/Kubernetes%201.16%E7%89%88%E6%9C%AC%E7%9A%84%E5%8F%91%E5%B8%83%E5%BE%BD%E7%AB%A0.jpg" alt="Kubernetes 1.16版本的发布徽章"></p>
<h3 id="查看k8s集群版本"><a href="#查看k8s集群版本" class="headerlink" title="查看k8s集群版本"></a>查看<code>k8s</code>集群版本</h3><p>查看当前的<code>k8s</code>版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubectl get nodes</div><div class="line">NAME         STATUS   ROLES    AGE   VERSION</div><div class="line">k8s-master   Ready    master   20d   v1.15.3</div><div class="line">k8s-node1    Ready    &lt;none&gt;   20d   v1.15.3</div><div class="line">k8s-node2    Ready    &lt;none&gt;   20d   v1.15.3</div><div class="line">k8s-node3    Ready    &lt;none&gt;   20d   v1.15.3</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubeadm version</div><div class="line">kubeadm version: &amp;version.Info&#123;Major:"1", Minor:"15", GitVersion:"v1.15.3", GitCommit:"2d3c76f9091b6bec110a5e63777c332469e0cba2", GitTreeState:"clean", BuildDate:"2019-08-19T11:11:18Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubelet --version</div><div class="line">Kubernetes v1.15.3</div><div class="line"></div><div class="line"></div><div class="line">[root@k8s-master ~]# systemctl status kubelet.service |grep Active</div><div class="line">   Active: active (running) since Fri 2019-08-30 07:26:33 EDT; 3 weeks 0 days ago</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master yum.repos.d]# kubectl version</div><div class="line">Client Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;15&quot;, GitVersion:&quot;v1.15.3&quot;, GitCommit:&quot;2d3c76f9091b6bec110a5e63777c332469e0cba2&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-08-19T11:13:54Z&quot;, GoVersion:&quot;go1.12.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</div><div class="line">Server Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;15&quot;, GitVersion:&quot;v1.15.3&quot;, GitCommit:&quot;2d3c76f9091b6bec110a5e63777c332469e0cba2&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-08-19T11:05:50Z&quot;, GoVersion:&quot;go1.12.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</div></pre></td></tr></table></figure>
<h3 id="查看版本支持"><a href="#查看版本支持" class="headerlink" title="查看版本支持"></a>查看版本支持</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master yum.repos.d]# yum list kubelet kubeadm kubectl</div><div class="line">Loaded plugins: fastestmirror, langpacks</div><div class="line">Loading mirror speeds from cached hostfile</div><div class="line"> * base: mirrors.aliyun.com</div><div class="line"> * extras: mirrors.aliyun.com</div><div class="line"> * updates: mirrors.aliyun.com</div><div class="line">Installed Packages</div><div class="line">kubeadm.x86_64                                                        1.15.3-0                                                        @kubernetes</div><div class="line">kubectl.x86_64                                                        1.15.3-0                                                        @kubernetes</div><div class="line">kubelet.x86_64                                                        1.15.3-0                                                        @kubernetes</div><div class="line">Available Packages</div><div class="line">kubeadm.x86_64                                                        1.16.0-0                                                        kubernetes </div><div class="line">kubectl.x86_64                                                        1.16.0-0                                                        kubernetes </div><div class="line">kubelet.x86_64                                                        1.16.0-0                                                        kubernetes</div></pre></td></tr></table></figure>
<h3 id="升级kubelet-kubeadm-kubectl版本到1-16-0-每个节点都执行"><a href="#升级kubelet-kubeadm-kubectl版本到1-16-0-每个节点都执行" class="headerlink" title="升级kubelet kubeadm kubectl版本到1.16.0(每个节点都执行)"></a>升级<code>kubelet</code> <code>kubeadm</code> <code>kubectl</code>版本到<code>1.16.0</code>(每个节点都执行)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# yum install -y kubelet kubeadm kubectl</div><div class="line"><span class="meta">#</span><span class="bash"> systemctl daemon-reload &amp;&amp; systemctl restart kubelet &amp;&amp; systemctl status kubelet</span></div><div class="line"></div><div class="line"></div><div class="line">[root@k8s-master ~]# kubectl version</div><div class="line">Client Version: version.Info&#123;Major:"1", Minor:"16", GitVersion:"v1.16.0", GitCommit:"2bd9643cee5b3b3a5ecbd3af49d09018f0773c77", GitTreeState:"clean", BuildDate:"2019-09-18T14:36:53Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div><div class="line">Server Version: version.Info&#123;Major:"1", Minor:"15", GitVersion:"v1.15.3", GitCommit:"2d3c76f9091b6bec110a5e63777c332469e0cba2", GitTreeState:"clean", BuildDate:"2019-08-19T11:05:50Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div><div class="line">[root@k8s-master ~]# kubelet --version</div><div class="line">Kubernetes v1.16.0</div><div class="line">[root@k8s-master ~]# kubeadm version</div><div class="line">kubeadm version: &amp;version.Info&#123;Major:"1", Minor:"16", GitVersion:"v1.16.0", GitCommit:"2bd9643cee5b3b3a5ecbd3af49d09018f0773c77", GitTreeState:"clean", BuildDate:"2019-09-18T14:34:01Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div></pre></td></tr></table></figure>
<h3 id="升级k8s集群"><a href="#升级k8s集群" class="headerlink" title="升级k8s集群"></a>升级<code>k8s</code>集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubectl get nodes</div><div class="line">NAME         STATUS   ROLES    AGE   VERSION</div><div class="line">k8s-master   Ready    master   21d   v1.15.3</div><div class="line">k8s-node1    Ready    &lt;none&gt;   20d   v1.15.3</div><div class="line">k8s-node2    Ready    &lt;none&gt;   20d   v1.15.3</div><div class="line">k8s-node3    Ready    &lt;none&gt;   20d   v1.15.3</div></pre></td></tr></table></figure>
<h3 id="升级集群"><a href="#升级集群" class="headerlink" title="升级集群"></a>升级集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubeadm config print init-defaults &gt; kubeadm1.16.yaml</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# cat kubeadm1.16.yaml </div><div class="line">apiVersion: kubeadm.k8s.io/v1beta2</div><div class="line">bootstrapTokens:</div><div class="line">- groups:</div><div class="line">  - system:bootstrappers:kubeadm:default-node-token</div><div class="line">  token: abcdef.0123456789abcdef</div><div class="line">  ttl: 24h0m0s</div><div class="line">  usages:</div><div class="line">  - signing</div><div class="line">  - authentication</div><div class="line">kind: InitConfiguration</div><div class="line">localAPIEndpoint:</div><div class="line">  advertiseAddress: 10.122.17.200</div><div class="line">  bindPort: 6443</div><div class="line">nodeRegistration:</div><div class="line">  criSocket: /var/run/dockershim.sock</div><div class="line">  name: k8s-master</div><div class="line">  taints:</div><div class="line">  - effect: NoSchedule</div><div class="line">    key: node-role.kubernetes.io/master</div><div class="line">---</div><div class="line">apiServer:</div><div class="line">  timeoutForControlPlane: 4m0s</div><div class="line">apiVersion: kubeadm.k8s.io/v1beta2</div><div class="line">certificatesDir: /etc/kubernetes/pki</div><div class="line">clusterName: kubernetes</div><div class="line">controllerManager: &#123;&#125;</div><div class="line">dns:</div><div class="line">  type: CoreDNS</div><div class="line">etcd:</div><div class="line">  local:</div><div class="line">    dataDir: /var/lib/etcd</div><div class="line">imageRepository: registry.aliyuncs.com/google_containers</div><div class="line">kind: ClusterConfiguration</div><div class="line">kubernetesVersion: v1.16.0</div><div class="line">networking:</div><div class="line">  dnsDomain: cluster.local</div><div class="line">  podSubnet: 192.168.0.0/16</div><div class="line">  serviceSubnet: 10.96.0.0/12</div><div class="line">scheduler: &#123;&#125;</div><div class="line">---</div><div class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</div><div class="line">kind: KubeProxyConfiguration</div><div class="line">mode: ipvs</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubeadm upgrade apply --config kubeadm1.16.yaml</div><div class="line"></div><div class="line"></div><div class="line">.......</div><div class="line">.......</div><div class="line">.......</div><div class="line">[addons] Applied essential addon: CoreDNS</div><div class="line">[addons] Applied essential addon: kube-proxy</div><div class="line"></div><div class="line">[upgrade/successful] SUCCESS! Your cluster was upgraded to &quot;v1.16.0&quot;. Enjoy!</div><div class="line"></div><div class="line">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven&apos;t already done so.</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubectl version</div><div class="line">Client Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;16&quot;, GitVersion:&quot;v1.16.0&quot;, GitCommit:&quot;2bd9643cee5b3b3a5ecbd3af49d09018f0773c77&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-09-18T14:36:53Z&quot;, GoVersion:&quot;go1.12.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</div><div class="line">Server Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;16&quot;, GitVersion:&quot;v1.16.0&quot;, GitCommit:&quot;2bd9643cee5b3b3a5ecbd3af49d09018f0773c77&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-09-18T14:27:17Z&quot;, GoVersion:&quot;go1.12.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@k8s-node1 ~]# yum clean all</div><div class="line">[root@k8s-node1 ~]# yum install -y kubelet kubeadm kubectl</div><div class="line"></div><div class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet &amp;&amp; systemctl status kubelet</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">[root@k8s-node1 ~]# kubectl version</div><div class="line">Client Version: version.Info&#123;Major:"1", Minor:"16", GitVersion:"v1.16.0", GitCommit:"2bd9643cee5b3b3a5ecbd3af49d09018f0773c77", GitTreeState:"clean", BuildDate:"2019-09-18T14:36:53Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div><div class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</div><div class="line">[root@k8s-node1 ~]# kubelet --version</div><div class="line">Kubernetes v1.16.0</div><div class="line">[root@k8s-node1 ~]# kubeadm version</div><div class="line">kubeadm version: &amp;version.Info&#123;Major:"1", Minor:"16", GitVersion:"v1.16.0", GitCommit:"2bd9643cee5b3b3a5ecbd3af49d09018f0773c77", GitTreeState:"clean", BuildDate:"2019-09-18T14:34:01Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubectl version</div><div class="line">Client Version: version.Info&#123;Major:"1", Minor:"16", GitVersion:"v1.16.0", GitCommit:"2bd9643cee5b3b3a5ecbd3af49d09018f0773c77", GitTreeState:"clean", BuildDate:"2019-09-18T14:36:53Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div><div class="line">Server Version: version.Info&#123;Major:"1", Minor:"16", GitVersion:"v1.16.0", GitCommit:"2bd9643cee5b3b3a5ecbd3af49d09018f0773c77", GitTreeState:"clean", BuildDate:"2019-09-18T14:27:17Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">[root@k8s-master ~]# kubectl get nodes</div><div class="line">NAME         STATUS   ROLES    AGE   VERSION</div><div class="line">k8s-master   Ready    master   21d   v1.16.0</div><div class="line">k8s-node1    Ready    &lt;none&gt;   21d   v1.16.0</div><div class="line">k8s-node2    Ready    &lt;none&gt;   21d   v1.16.0</div><div class="line">k8s-node3    Ready    &lt;none&gt;   21d   v1.16.0</div><div class="line"></div><div class="line"></div><div class="line">[root@k8s-master ~]# kubectl get pod -A</div><div class="line">NAMESPACE       NAME                                        READY   STATUS    RESTARTS   AGE</div><div class="line">default         curl-6bf6db5c4f-dqw9x                       1/1     Running   2          20d</div><div class="line">ingress-nginx   nginx-ingress-controller-6956498fcf-jkzbs   1/1     Running   1          16d</div><div class="line">kube-system     calico-kube-controllers-65b8787765-hx9cr    1/1     Running   1          21d</div><div class="line">kube-system     calico-node-2rlsz                           1/1     Running   1          21d</div><div class="line">kube-system     calico-node-5vz46                           1/1     Running   1          21d</div><div class="line">kube-system     calico-node-6szsd                           1/1     Running   1          21d</div><div class="line">kube-system     calico-node-s5nmr                           1/1     Running   1          21d</div><div class="line">kube-system     calicoctl                                   1/1     Running   1          20d</div><div class="line">kube-system     coredns-58cc8c89f4-cnl45                    1/1     Running   1          26m</div><div class="line">kube-system     coredns-58cc8c89f4-nj8hr                    1/1     Running   1          9m4s</div><div class="line">kube-system     etcd-k8s-master                             1/1     Running   0          6m35s</div><div class="line">kube-system     kube-apiserver-k8s-master                   1/1     Running   0          6m30s</div><div class="line">kube-system     kube-controller-manager-k8s-master          1/1     Running   0          6m35s</div><div class="line">kube-system     kube-proxy-52mbf                            1/1     Running   1          26m</div><div class="line">kube-system     kube-proxy-gf75r                            1/1     Running   1          25m</div><div class="line">kube-system     kube-proxy-hbvjf                            1/1     Running   1          26m</div><div class="line">kube-system     kube-proxy-zppdf                            1/1     Running   1          26m</div><div class="line">kube-system     kube-scheduler-k8s-master                   1/1     Running   0          6m31s</div><div class="line">kube-system     kubernetes-dashboard-5dc4c54b55-c7sv2       1/1     Running   1          20d</div><div class="line"></div><div class="line"></div><div class="line">[root@k8s-master ~]# kubectl get pod</div><div class="line">NAME                    READY   STATUS    RESTARTS   AGE</div><div class="line">curl-6bf6db5c4f-dqw9x   1/1     Running   2          20d</div></pre></td></tr></table></figure>
<h3 id="验证cordns"><a href="#验证cordns" class="headerlink" title="验证cordns"></a>验证<code>cordns</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master ~]# kubectl get pod</div><div class="line">NAME                    READY   STATUS    RESTARTS   AGE</div><div class="line">curl-6bf6db5c4f-dqw9x   1/1     Running   2          20d</div><div class="line">[root@k8s-master ~]# kubectl exec -it curl-6bf6db5c4f-dqw9x -- /bin/sh</div><div class="line">/bin/sh: shopt: not found</div><div class="line">[ root@curl-6bf6db5c4f-dqw9x:/ ]$ nslookup kubernetes.default</div><div class="line">Server:    10.96.0.10</div><div class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</div><div class="line"></div><div class="line">Name:      kubernetes.default</div><div class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</div><div class="line">[ root@curl-6bf6db5c4f-dqw9x:/ ]$ exit</div><div class="line">[root@k8s-master ~]#</div></pre></td></tr></table></figure>
<h3 id="未解决的问题"><a href="#未解决的问题" class="headerlink" title="未解决的问题"></a>未解决的问题</h3><p><code>kubectl get cs</code>显示为<code>unknown</code><br>错误提示信息示例如下:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kubectl get cs</span></div><div class="line">NAME                 AGE</div><div class="line">scheduler            &lt;unknown&gt;</div><div class="line">controller-manager   &lt;unknown&gt;</div><div class="line">etcd-0               &lt;unknown&gt;</div></pre></td></tr></table></figure></p>
<p>这个问题似乎对集群没有太大的影响，暂未解决，后续愿意确认之后会继续更新，如果有大神知道如何解决，请指点。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>1、 <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-upgrade/" target="_blank" rel="external">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-upgrade/</a><br>2、 <a href="http://www.sohu.com/a/342118551_198222" target="_blank" rel="external">http://www.sohu.com/a/342118551_198222</a><br>3、 <a href="https://www.linuxidc.com/Linux/2019-09/160728.htm" target="_blank" rel="external">https://www.linuxidc.com/Linux/2019-09/160728.htm</a></p>

    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">kubeadm</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/kubernetes//" class="article-tag-list-link color1">kubernetes</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/kubeadm升级k8s集群(v1.15.3 to v1.16.0版).html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-在k8s上部署ingress-nginx并使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/在k8s上部署ingress-nginx并使用.html" target="_blank">在k8s上部署ingress-nginx并使用</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <a id="more"></a>
<p>[TOC]</p>
<h3 id="部署nginx-ingress"><a href="#部署nginx-ingress" class="headerlink" title="部署nginx-ingress"></a>部署<code>nginx-ingress</code></h3><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>准备一套<code>k8s</code>环境<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kubectl get cs</span></div><div class="line">NAME                 STATUS    MESSAGE             ERROR</div><div class="line">controller-manager   Healthy   ok                  </div><div class="line">scheduler            Healthy   ok                  </div><div class="line">etcd-0               Healthy   &#123;"health":"true"&#125;   </div><div class="line"><span class="meta">#</span><span class="bash"> kubectl cluster-info</span></div><div class="line">Kubernetes master is running at https://10.122.17.200:6443</div><div class="line">KubeDNS is running at https://10.122.17.200:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</div><div class="line"></div><div class="line">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</div><div class="line"><span class="meta">#</span><span class="bash"> kubectl get nodes</span></div><div class="line">NAME         STATUS   ROLES    AGE    VERSION</div><div class="line">k8s-master   Ready    master   4d1h   v1.15.3</div><div class="line">k8s-node1    Ready    &lt;none&gt;   4d1h   v1.15.3</div><div class="line">k8s-node2    Ready    &lt;none&gt;   4d     v1.15.3</div><div class="line">k8s-node3    Ready    &lt;none&gt;   4d     v1.15.3</div></pre></td></tr></table></figure></p>
<h3 id="下载安装nginx-ingress的yaml文件"><a href="#下载安装nginx-ingress的yaml文件" class="headerlink" title="下载安装nginx-ingress的yaml文件"></a>下载安装<code>nginx-ingress</code>的<code>yaml</code>文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</span></div></pre></td></tr></table></figure>
<h3 id="设置nginx-ingress-controller调度节点"><a href="#设置nginx-ingress-controller调度节点" class="headerlink" title="设置nginx-ingress-controller调度节点"></a>设置<code>nginx-ingress-controller</code>调度节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kubectl label nodes k8s-node1 hosts=nginx-ingress-controller</span></div><div class="line"><span class="meta">#</span><span class="bash"> kubectl get node <span class="_">-l</span> hosts=nginx-ingress-controller --show-labels </span></div><div class="line">NAME        STATUS   ROLES    AGE    VERSION   LABELS</div><div class="line">k8s-node1   Ready    &lt;none&gt;   4d6h   v1.15.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,hosts=nginx-ingress-controller,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node1,kubernetes.io/os=linux</div></pre></td></tr></table></figure>
<h3 id="修改mandatory-yaml文件"><a href="#修改mandatory-yaml文件" class="headerlink" title="修改mandatory.yaml文件"></a>修改<code>mandatory.yaml</code>文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim mandatory.yaml</span></div><div class="line">......</div><div class="line">apiVersion: apps/v1</div><div class="line">kind: Deployment</div><div class="line">......</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app.kubernetes.io/name: ingress-nginx</div><div class="line">      app.kubernetes.io/part-of: ingress-nginx</div><div class="line">  template:</div><div class="line">    ......</div><div class="line">    spec:</div><div class="line">      hostNetwork: true    # 使用hostNetwork 模式</div><div class="line">      nodeSelector:        # 使用nodeSelector</div><div class="line">        hosts: nginx-ingress-controller   # 选择标签为hosts=nginx-ingress-controller节点</div><div class="line">      serviceAccountName: nginx-ingress-serviceaccount</div><div class="line">      containers:</div><div class="line">        - name: nginx-ingress-controller</div><div class="line">          image: lijiawang/nginx-ingress-controller:0.25.1   # 更换镜像源</div><div class="line">		  ......</div><div class="line">......</div></pre></td></tr></table></figure>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kubectl apply <span class="_">-f</span> mandatory.yaml</span></div><div class="line"><span class="meta">#</span><span class="bash"> kubectl get pod -n ingress-nginx</span></div><div class="line"><span class="meta">#</span><span class="bash"> kubectl get pod -n ingress-nginx -o wide</span></div><div class="line">NAME                                        READY   STATUS    RESTARTS   AGE   IP              NODE        NOMINATED NODE   READINESS GATES</div><div class="line">nginx-ingress-controller-6956498fcf-jkzbs   1/1     Running   0          55s   10.122.17.204   k8s-node1   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p>可以看到<code>nginx-ingress-controller-6956498fcf-jkzbs</code> <code>POD</code> 调度到了打好标记的<code>k8s-node1</code>。</p>
<h3 id="登录nginx-ingress-controller节点验证"><a href="#登录nginx-ingress-controller节点验证" class="headerlink" title="登录nginx-ingress-controller节点验证"></a>登录<code>nginx-ingress-controller</code>节点验证</h3><p>因为<code>k8s-node1</code>为<code>nginx-ingress-controller</code>节点，所有登录<code>k8s-node1</code>节点即可<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ssh k8s-node1</span></div><div class="line">[root@k8s-node1 ~]# netstat -lntp|grep 80</div><div class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      5901/nginx: master  </div><div class="line">tcp6       0      0 :::80                   :::*                    LISTEN      5901/nginx: master  </div><div class="line">[root@k8s-node1 ~]# netstat -lntp|grep 443</div><div class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      5901/nginx: master  </div><div class="line">tcp6       0      0 :::443                  :::*                    LISTEN      5901/nginx: master  </div><div class="line">[root@k8s-node1 ~]# exit</div><div class="line">logout</div><div class="line">Connection to k8s-node1 closed.</div></pre></td></tr></table></figure></p>
<h3 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h3><p>部署测试应用<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat deploy-demon.yaml </span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">    port:</span> <span class="number">80</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">metadata:</span> </div><div class="line"><span class="attr">  name:</span> <span class="string">myapp-deploy</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">5</span></div><div class="line"><span class="attr">  selector:</span> </div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">      release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">        release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">        image:</span> <span class="string">lijiawang/myapp:v2</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">httpd</span></div><div class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></div><div class="line"><span class="comment"># kubectl  apply -f deploy-demon.yaml </span></div><div class="line"><span class="string">service/myapp</span> <span class="string">created</span></div><div class="line"><span class="string">deployment.apps/myapp-deploy</span> <span class="string">created</span></div><div class="line"><span class="comment"># kubectl get pod </span></div><div class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">curl-6bf6db5c4f-dqw9x</span>          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="number">16</span><span class="string">d</span></div><div class="line"><span class="string">myapp-deploy-c69757d67-9bv4w</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">38</span><span class="string">s</span></div><div class="line"><span class="string">myapp-deploy-c69757d67-j2kxc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">38</span><span class="string">s</span></div><div class="line"><span class="string">myapp-deploy-c69757d67-jgm5v</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">38</span><span class="string">s</span></div><div class="line"><span class="string">myapp-deploy-c69757d67-n5rxw</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">38</span><span class="string">s</span></div><div class="line"><span class="string">myapp-deploy-c69757d67-t4nxr</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">38</span><span class="string">s</span></div><div class="line"><span class="comment"># kubectl get svc</span></div><div class="line"><span class="string">NAME</span>         <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>       <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>   <span class="string">AGE</span></div><div class="line"><span class="string">kubernetes</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span>        <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>   <span class="number">17</span><span class="string">d</span></div><div class="line"><span class="string">myapp</span>        <span class="string">ClusterIP</span>   <span class="number">10.104</span><span class="number">.246</span><span class="number">.234</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">/TCP</span>    <span class="number">2</span><span class="string">m58s</span></div></pre></td></tr></table></figure></p>
<h3 id="以ingress方式暴露应用"><a href="#以ingress方式暴露应用" class="headerlink" title="以ingress方式暴露应用"></a>以<code>ingress</code>方式暴露应用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cat ingress-myapp.yaml </span></div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Ingress</div><div class="line">metadata:</div><div class="line">  name: ingress-myapp</div><div class="line">  namespace: default</div><div class="line">  annotations: </div><div class="line">    kubernetes.io/ingress.class: "nginx"</div><div class="line">spec:</div><div class="line">  rules:</div><div class="line">  - host: myapp.lijw19.com   # 定义域名</div><div class="line">    http:</div><div class="line">      paths:</div><div class="line">      - path: </div><div class="line">        backend:</div><div class="line">          serviceName: myapp   # 跟你要爆了的服务的svc名字相同</div><div class="line">          servicePort: 80     # 要暴露的端口</div><div class="line"><span class="meta">#</span><span class="bash"> kubectl apply <span class="_">-f</span> ingress-myapp.yaml </span></div><div class="line">ingress.extensions/ingress-myapp created</div><div class="line"><span class="meta">#</span><span class="bash"> kubectl get ingresses.</span></div><div class="line">NAME            HOSTS              ADDRESS   PORTS   AGE</div><div class="line">ingress-myapp   myapp.lijw19.com             80      10s</div></pre></td></tr></table></figure>
<p>本地<code>host</code>解析<br><code>windows</code>的<code>hosts</code>文件在<code>c:\windows\system32\drivers\etc</code>下<br>修改<code>host</code>文件，增加以下内容<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">10.122.17.204 myapp.lijw19.com</div></pre></td></tr></table></figure></p>
<h3 id="访问应用"><a href="#访问应用" class="headerlink" title="访问应用"></a>访问应用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> i <span class="keyword">in</span> `seq 10`; <span class="keyword">do</span> curl http://myapp.lijw19.com; <span class="keyword">done</span></span></div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</div></pre></td></tr></table></figure>
<p>使用浏览器访问<code>http://myapp.lijw19.com</code><br><img src="https://ljw.howieli.cn/blog/2019-9-18/http0.png" alt=""></p>
<p><img src="https://ljw.howieli.cn/blog/2019-9-18/http1.png" alt=""><br>这里我们是使用的http访问的，那如果要使用</p>
<h3 id="使用https访问"><a href="#使用https访问" class="headerlink" title="使用https访问"></a>使用<code>https</code>访问</h3><p>创建证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># openssl genrsa -out tls.key 2048</div><div class="line">Generating RSA private key, 2048 bit long modulus</div><div class="line">......................+++</div><div class="line">.....................................+++</div><div class="line">e is 65537 (0x10001)</div><div class="line"># ls -l tls.key </div><div class="line">-rw-r--r-- 1 root root 1675 Sep 16 08:43 tls.key</div><div class="line"># openssl req -new -x509 -key tls.key -out tls.crt</div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter &apos;.&apos;, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [XX]:CN     </div><div class="line">State or Province Name (full name) []:lijw19</div><div class="line">Locality Name (eg, city) [Default City]:lijw19</div><div class="line">Organization Name (eg, company) [Default Company Ltd]:test</div><div class="line">Organizational Unit Name (eg, section) []:test</div><div class="line">Common Name (eg, your name or your server&apos;s hostname) []:test.lijw19.com</div><div class="line">Email Address []:</div><div class="line">[root@k8s-master ~]# ls -l tls.*</div><div class="line">-rw-r--r-- 1 root root 1318 Sep 16 08:46 tls.crt</div><div class="line">-rw-r--r-- 1 root root 1675 Sep 16 08:43 tls.key</div></pre></td></tr></table></figure></p>
<h3 id="证书转成secret"><a href="#证书转成secret" class="headerlink" title="证书转成secret"></a>证书转成<code>secret</code></h3><p>将创建好的证书转成<code>secret</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kubectl create secret tls lijw-ingress-secret --cert=tls.crt --key=tls.key</span></div><div class="line">secret/lijw-ingress-secret created</div><div class="line"><span class="meta">#</span><span class="bash"> kubectl get secrets </span></div><div class="line">NAME                  TYPE                                  DATA   AGE</div><div class="line">default-token-vmfwt   kubernetes.io/service-account-token   3      17d</div><div class="line">lijw-ingress-secret   kubernetes.io/tls                     2      10s</div></pre></td></tr></table></figure></p>
<h3 id="创建https-ingress"><a href="#创建https-ingress" class="headerlink" title="创建https ingress"></a>创建<code>https</code> <code>ingress</code></h3><p>修改下<code>ingress-myapp-https.yaml</code>加入刚刚添加的<code>secret</code>，修改后的文件如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"># cat ingress-myapp-https.yaml </div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Ingress</div><div class="line">metadata:</div><div class="line">  name: ingress-myapp-https</div><div class="line">  namespace: default</div><div class="line">  annotations: </div><div class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</div><div class="line">spec:</div><div class="line">  tls:    # 添加了tls这一段</div><div class="line">  - hosts:</div><div class="line">    - test.lijw19.com</div><div class="line">    secretName: lijw-ingress-secret  # 到这结束</div><div class="line">  rules:</div><div class="line">  - host: test.lijw19.com</div><div class="line">    http:</div><div class="line">      paths:</div><div class="line">      - path: </div><div class="line">        backend:</div><div class="line">          serviceName: myapp</div><div class="line">          servicePort: 80</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"># kubectl apply -f ingress-myapp-https.yaml </div><div class="line">ingress.extensions/ingress-myapp-https created</div><div class="line"># kubectl get ingresses ingress-myapp-https </div><div class="line">NAME                  HOSTS             ADDRESS   PORTS     AGE</div><div class="line">ingress-myapp-https   test.lijw19.com             80, 443   13s</div></pre></td></tr></table></figure></p>
<h3 id="本地host解析"><a href="#本地host解析" class="headerlink" title="本地host解析"></a>本地<code>host</code>解析</h3><p><code>windows</code>的<code>hosts</code>文件在<code>c:\windows\system32\drivers\etc</code>下<br>修改<code>host</code>文件，增加以下内容<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">10.122.17.204 myapp.lijw19.com  test.lijw19.com</div></pre></td></tr></table></figure></p>
<p>在浏览器访问<code>https://test.lijw19.com</code><br><img src="https://ljw.howieli.cn/blog/2019-9-18/https0.png" alt=""></p>
<p><img src="https://ljw.howieli.cn/blog/2019-9-18/https1.png" alt=""></p>

    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">kubernets</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/kubernets//" class="article-tag-list-link color5">kubernets</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/在k8s上部署ingress-nginx并使用.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-使用kubeadm搭建kubernetes1.15" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/使用kubeadm搭建kubernetes1.15.html" target="_blank">使用kubeadm搭建kubernetes1.15</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="使用kubeadm方式安装kubernetes"><a href="#使用kubeadm方式安装kubernetes" class="headerlink" title="使用kubeadm方式安装kubernetes"></a>使用<code>kubeadm</code>方式安装<code>kubernetes</code></h3>
    
    <a class="article-more-a" href="/posts/使用kubeadm搭建kubernetes1.15.html#more">more >></a>
    
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">使用kubeadm搭建kubernetes1.15</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/kubernetes//" class="article-tag-list-link color1">kubernetes</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/使用kubeadm搭建kubernetes1.15.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-harbor搭建" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/harbor搭建.html" target="_blank">harbor搭建</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="harbor介绍"><a href="#harbor介绍" class="headerlink" title="harbor介绍"></a>harbor介绍</h3><p>Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器，通过添加一些企业必需的功能特性，例如安全、标识和管理等，扩展了开源Docker Distribution。作为一个企业级私有Registry服务器，Harbor提供了更好的性能和安全。提升用户使用Registry构建和运行环境传输镜像的效率。Harbor支持安装在多个Registry节点的镜像资源复制，镜像全部保存在私有Registry中， 确保数据和知识产权在公司内部网络中管控。另外，Harbor也提供了高级的安全特性，诸如用户管理，访问控制和活动审计等。</p>
    
    <a class="article-more-a" href="/posts/harbor搭建.html#more">more >></a>
    
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">docker</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/docker//" class="article-tag-list-link color2">docker</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/harbor搭建.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-使用Kubeadm安装最新版Kubernetes 1.12" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/使用Kubeadm安装最新版Kubernetes 1.12.html" target="_blank">使用Kubeadm安装最新版Kubernetes 1.12</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="使用Kubeadm安装最新版Kubernetes-1-12"><a href="#使用Kubeadm安装最新版Kubernetes-1-12" class="headerlink" title="使用Kubeadm安装最新版Kubernetes 1.12"></a>使用Kubeadm安装最新版Kubernetes 1.12</h3><blockquote>
<p>kubeadm是Kubernetes官方提供的用于快速安装Kubernetes集群的工具，伴随Kubernetes每个版本的发布都会同步更新，kubeadm会对集群配置方面的一些实践做调整，通过实验kubeadm可以学习到Kubernetes官方在集群配置上一些新的最佳实践。</p>
</blockquote>
    
    <a class="article-more-a" href="/posts/使用Kubeadm安装最新版Kubernetes 1.12.html#more">more >></a>
    
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">kubernetes</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/kubernetes//" class="article-tag-list-link color1">kubernetes</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/使用Kubeadm安装最新版Kubernetes 1.12.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-kolla部署openstack对接华为san存储" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/kolla部署openstack对接华为san存储.html" target="_blank">kolla部署openstack对接华为san存储</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="kolla部署openstack对接华为san存储"><a href="#kolla部署openstack对接华为san存储" class="headerlink" title="kolla部署openstack对接华为san存储"></a>kolla部署openstack对接华为san存储</h3><p>openstack O版对接华为SAN存储（kolla部署模式）</p>
    
    <a class="article-more-a" href="/posts/kolla部署openstack对接华为san存储.html#more">more >></a>
    
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/openstack//" class="article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/kolla部署openstack对接华为san存储.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-docker网络" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/docker网络.html" target="_blank">docker网络</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="docker四种单节点网络"><a href="#docker四种单节点网络" class="headerlink" title="docker四种单节点网络"></a>docker四种单节点网络</h3><p><code>Docker</code>在创建容器时有四种网络模式，<code>bridge</code>为默认不需要用<code>-–net</code>去指定，其他三种模式需要在创建容器时使用<code>–-net</code>去指定。<br>四种单节点网络模式如下：<br><code>none</code>模式，使用<code>–-net=none</code>指定；<br><code>host</code>模式，使用<code>–-net=host</code>指定；<br><code>bridge</code>模式，使用<code>–-net=bridge</code>指定，默认设置；<br><code>container</code>模式，使用<code>–-net=container</code>:容器名称或ID指定。<br>在<code>Docker</code>安装时会自动在<code>host</code>上创建三个网络,我们可以通过<code>docker network ls</code>查看：<br><img src="https://ljw.howieli.cn/blog/2018-06-12/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180612122600.png" alt=""></p>
    
    <a class="article-more-a" href="/posts/docker网络.html#more">more >></a>
    
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">docker</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/docker//" class="article-tag-list-link color2">docker</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/docker网络.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-openstack对接ceph存储" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/openstack对接ceph存储.html" target="_blank">ceph-for-openstack-storage</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h2 id="openstack对接ceph存储"><a href="#openstack对接ceph存储" class="headerlink" title="openstack对接ceph存储"></a><code>openstack</code>对接<code>ceph</code>存储</h2><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>截至<code>2018</code>年<code>5</code>月<code>3</code>日，<code>OpenStack</code>也已经伴随着我们走过了<code>8</code>个年头了，并且成为了云计算领域中最火热的项目之一，逐渐成为<code>IaaS</code>的事实标准，私有云项目的部署首选；</li>
<li><code>OpenStack</code>发展如此的迅速，以至于部署规模愈发的庞大，此时就该思量<code>OpenStack</code>集群的部署支持以及持续可扩展性；</li>
<li><code>OpenStack</code>和<code>Ceph</code>的集成更让开源项目锦上添花，<code>Ceph</code>作为优秀的分布式存储系统，实现对<code>OpenStack</code>相关子项目进行集成或替代，目前在<code>OpenStack</code>中扮演者非常重要的角色；</li>
</ul>
    
    <a class="article-more-a" href="/posts/openstack对接ceph存储.html#more">more >></a>
    
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">openstack ceph</a>
        		</li>
      		
		</ul>
	</div>

    
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/openstack//" class="article-tag-list-link color5">openstack</a>
        		</li>
      		
		</ul>
	</div>


    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/openstack对接ceph存储.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-kolla-多region搭建" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 itemprop="name">
	
	  <a class="article-title" href="/posts/kolla-多region搭建.html" target="_blank">kolla 多region搭建</a>
  
    </h1>
  


  
  
  
  
    

  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h3 id="kolla部署openstack多region"><a href="#kolla部署openstack多region" class="headerlink" title="kolla部署openstack多region"></a>kolla部署openstack多region</h3><h3 id="openstack多region基础知识"><a href="#openstack多region基础知识" class="headerlink" title="openstack多region基础知识"></a>openstack多region基础知识</h3><p>我们都知道<code>Region</code>是<code>OpenStack</code>里面用于隔离资源的一个重要概念。简单来说，一个<code>Region</code>对应一套完整的<code>OpenStack</code>环境，而<code>Region</code>和<code>Region</code>之间可以是跨机房的集群，也可以是一个大规模物理机集群分割后的集群。<code>OpenStack</code>在设计之初就是支持多<code>Region</code>的情况，由于<code>Region</code>之间资源（<code>Mariadb</code>,<code>RabbitMQ</code>等）的独立的，所以他们之间并不存在资源交互开销的情况。<br>简单的讲所谓<code>openstack</code>多<code>region</code>，就是多套<code>openstack</code>共享一个<code>keystone</code>和<code>horizon</code>。每个区域一套<code>openstack</code>环境，可以分布在不同的地理位置，只要网络可达就行。个人认为目的就是为了提供环境隔离的功能，选择启虚拟机的时候可以根据自己所处的位置就近选择。<br><img src="https://ljw.howieli.cn/blog/2018-4-3/%E5%A4%9Aregion1.png" alt=""><br>
    
    <a class="article-more-a" href="/posts/kolla-多region搭建.html#more">more >></a>
    
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
    

    
    <p class="article-more-link">
      <a class="article-more-a" href="/posts/kolla-多region搭建.html">展开全文 >></a>
    </p>
    

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  

