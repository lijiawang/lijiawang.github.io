<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[kolla queens on centos7.4]]></title>
      <url>/posts/kolla%20queens%20on%20centos7.41.html</url>
      <content type="html"><![CDATA[<h3 id="kolla-queens-on-centos7-4"><a href="#kolla-queens-on-centos7-4" class="headerlink" title="kolla queens on centos7.4"></a>kolla queens on centos7.4</h3><p><img src="https://ljw.howieli.cn/blog/2018-03-29/WX20180329-171345.png" alt=""><br><a id="more"></a></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>我这里用<code>workstation</code> 创建了一个虚拟机，安装<code>centos7.4</code>系统，这台虚拟机上有两张网卡，一张做<code>openstack</code>管理网，一张做为虚拟机的业务网卡。</p>
<h3 id="确定环境信息"><a href="#确定环境信息" class="headerlink" title="确定环境信息"></a>确定环境信息</h3><ul>
<li><p>确认系统版本信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> cat /etc/redhat-release</div><div class="line">CentOS Linux release 7.4.1708 (Core)</div><div class="line"><span class="meta">#</span> uname -r</div><div class="line">3.10.0-693.5.2.el7.x86_64</div></pre></td></tr></table></figure>
</li>
<li><p>确认网卡个数和状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> ip a</div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 ::1/128 scope host</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:a7:8c:91 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.254.15/24 brd 192.168.254.255 scope global dynamic ens33</div><div class="line">       valid_lft 1555sec preferred_lft 1555sec</div><div class="line">    inet6 fe80::5057:38c5:6b65:b5/64 scope link</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">3: ens34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:a7:8c:9b brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet6 fe80::20c:29ff:fea7:8c9b/64 scope link</div><div class="line">       valid_lft forever preferred_lft forever</div></pre></td></tr></table></figure>
</li>
</ul>
<p>上面可以看出有两张网卡<code>ens33</code>和<code>ens34</code>，这里我用<code>ens33</code>做管理网，<code>ens34</code>做业务网，这里不需要配置<code>ip</code>，把<code>ens34</code>网卡<code>up</code>起来就好。</p>
<ul>
<li>查看主机名<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> hostname</div><div class="line">queens</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h3><ul>
<li><p>关闭<code>NetworkManager</code>,<code>firewalld</code>,<code>selinux</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> systemctl stop NetworkManager</div><div class="line"><span class="meta">#</span> systemctl disable NetworkManager</div><div class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/NetworkManager.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.freedesktop.NetworkManager.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.freedesktop.nm-dispatcher.service.</div><div class="line"><span class="meta">#</span> systemctl stop firewalld</div><div class="line"><span class="meta">#</span> systemctl disable firewalld</div><div class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</div><div class="line"><span class="meta">#</span> sed -i "s/SELINUX=enforcing/SELINUX=disabled/" /etc/selinux/config</div><div class="line"><span class="meta">#</span> setenforce 0</div><div class="line"><span class="meta">#</span> getenforce</div><div class="line">Permissive</div></pre></td></tr></table></figure>
</li>
<li><p>查看是否开启了虚拟化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> egrep "vmx|svm" /proc/cpuinfo</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装基础软件包"><a href="#安装基础软件包" class="headerlink" title="安装基础软件包"></a>安装基础软件包</h3><p>配置配置<code>epel</code>源安装基础包<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> yum install epel-release</div><div class="line"><span class="meta">#</span> yum install axel vim git curl wget lrzsz gcc  python-devel python-pip</div></pre></td></tr></table></figure></p>
<h3 id="安装配置docker"><a href="#安装配置docker" class="headerlink" title="安装配置docker"></a>安装配置<code>docker</code></h3><ul>
<li><p>安装<code>docker</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</div><div class="line"><span class="meta">#</span> yum install -y docker-ce</div></pre></td></tr></table></figure>
</li>
<li><p>配置<code>docker</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> mkdir /etc/systemd/system/docker.service.d</div><div class="line"><span class="meta">#</span> tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt; 'EOF'</div><div class="line">[Service]</div><div class="line">MountFlags=shared</div><div class="line">EOF</div><div class="line"><span class="meta">#</span> vim /usr/lib/systemd/system/docker.service</div><div class="line"><span class="meta">#</span> ExecStart=/usr/bin/dockerd</div><div class="line">ExecStart=/usr/bin/dockerd --registry-mirror=http://f2d6cb40.m.daocloud.io --storage-driver=overlay2</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这里<code>docker</code>的文件系统我用<code>overlay2</code></p>
<ul>
<li><p>配置阿里云的 <code>Docker</code> 加速器，加快 <code>pull registry</code> 镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/docker</div><div class="line">tee /etc/docker/daemon.json &lt;&lt;-'EOF'</div><div class="line">&#123;</div><div class="line">"registry-mirrors": ["https://a5aghnme.mirror.aliyuncs.com"]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
</li>
<li><p>启动<code>docker</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> systemctl daemon-reload</div><div class="line"><span class="meta">#</span> systemctl restart docker</div><div class="line"><span class="meta">#</span> systemctl enable docker</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</div><div class="line"><span class="meta">#</span> systemctl status docker</div><div class="line"><span class="meta">#</span> docker info</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装ansible"><a href="#安装ansible" class="headerlink" title="安装ansible"></a>安装<code>ansible</code></h3><p><code>ansible</code>版本必须在2.0以上<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> yum -y install ansible -y</div></pre></td></tr></table></figure></p>
<h3 id="下载kolla-ansible，并安装配置"><a href="#下载kolla-ansible，并安装配置" class="headerlink" title="下载kolla-ansible，并安装配置"></a>下载<code>kolla-ansible</code>，并安装配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> git clone https://github.com/openstack/kolla-ansible -b stable/queens</div><div class="line"><span class="meta">#</span> cd kolla-ansible/</div><div class="line"><span class="meta">#</span> cp -r etc/kolla/ /etc/kolla/</div><div class="line"><span class="meta">#</span> pip install . -i https://pypi.tuna.tsinghua.edu.cn/simple</div></pre></td></tr></table></figure>
<h3 id="配置globals-yml文件"><a href="#配置globals-yml文件" class="headerlink" title="配置globals.yml文件"></a>配置<code>globals.yml</code>文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># egrep &quot;^[^#]&quot; /etc/kolla/globals.yml</div><div class="line">---</div><div class="line">kolla_base_distro: &quot;centos&quot;</div><div class="line">kolla_install_type: &quot;source&quot;</div><div class="line">openstack_release: &quot;queens&quot;</div><div class="line">kolla_internal_vip_address: &quot;192.168.254.11&quot;</div><div class="line">docker_namespace: &quot;kolla&quot;</div><div class="line">network_interface: &quot;eth0&quot;</div><div class="line">neutron_external_interface: &quot;eth1&quot;</div><div class="line">enable_haproxy: &quot;no&quot;</div><div class="line">nova_compute_virt_type: &quot;qemu&quot;</div><div class="line">ironic_dnsmasq_dhcp_range:</div><div class="line">tempest_image_id:</div><div class="line">tempest_flavor_ref_id:</div><div class="line">tempest_public_network_id:</div><div class="line">tempest_floating_network_name:</div></pre></td></tr></table></figure>
<p>说明：这里我直接在<a href="https://hub.docker.com/search/?isAutomated=0&amp;isOfficial=0&amp;page=1&amp;pullCount=0&amp;q=kolla&amp;starCount=0" target="_blank" rel="external">docker hub</a>上拉镜像。如果是在虚拟机里安装 <code>Kolla</code>，希望可以在 <code>OpenStack</code> 平台上创建虚拟机，那么你需要在 <code>globals.yml</code> 文件中把 <code>nova_compute_virt_type</code> 配置项设置为 <code>qemu</code>，默认是 <code>KVM</code>。</p>
<h3 id="安装kolla"><a href="#安装kolla" class="headerlink" title="安装kolla"></a>安装<code>kolla</code></h3><ul>
<li><p>生成密码文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># kolla-genpwd</div></pre></td></tr></table></figure>
</li>
<li><p>编辑 <code>/etc/kolla/passwords.yml</code> 文件，配置 <code>keystone</code> 管理员用户的密码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">keystone_admin_password: password</div></pre></td></tr></table></figure>
</li>
</ul>
<p>同时，也是登录 <code>Dashboard，admin</code> 使用的密码，你可以根据自己需要进行修改。</p>
<ul>
<li><p>运行 <code>prechecks</code> 检查配置是否正确，如果有错误，可以先忽略。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kolla-ansible prechecks</div></pre></td></tr></table></figure>
</li>
<li><p>从<code>docker hub</code>上<code>pull</code>镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kolla-ansible pull</div></pre></td></tr></table></figure>
</li>
<li><p>部署<code>openstack</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kolla-ansible deploy</div></pre></td></tr></table></figure>
</li>
<li><p>创建环境变量文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kolla-ansible post-deploy</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这样就创建了<code>/etc/kolla/admin-openrc.sh</code> 环境变量文件。</p>
<ul>
<li><p>安装 <code>OpenStack Client</code> 端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> pip install python-openstackclient</div></pre></td></tr></table></figure>
</li>
<li><p>编辑<code>init-runonce</code>文件,设置<code>public network</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> vim /usr/share/kolla-ansible/init-runonce</div><div class="line">EXT_NET_CIDR='10.10.20.0/24'</div><div class="line">EXT_NET_RANGE='start=10.10.20.110,end=10.10.20.254'</div><div class="line">EXT_NET_GATEWAY='10.10.20.1'</div></pre></td></tr></table></figure>
</li>
<li><p>加载<code>OpenStack CLI</code>所需的环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> source /etc/kolla/admin-openrc.sh</div></pre></td></tr></table></figure>
</li>
<li><p>初始化部署</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> cd /usr/share/kolla-ansible/ &amp;&amp; ./init-runonce</div></pre></td></tr></table></figure>
</li>
<li><p>登陆<code>Dashboard</code><br>用浏览器访问<code>192.168.254.15</code>登陆<code>Dashboard</code><br><img src="https://ljw.howieli.cn/blog/2018-03-29/WX20180329-170306.png" alt=""><br><img src="https://ljw.howieli.cn/blog/2018-03-29/WX20180329-170337.png" alt=""></p>
</li>
<li><p>如果，在部署过程中失败了，亦或是变更了配置信息，需要重新部署，则执行如下命令，清除掉已部署的 <code>Docker</code> 容器，即 <code>OpenStack</code> 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># kolla-ansible destroy -i /home/multinode --yes-i-really-really-mean-it</div></pre></td></tr></table></figure>
</li>
<li><p>除此外，还有一些小工具，在需要时，可以使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 可用于从系统中移除部署的容器:</div><div class="line">tools/cleanup-containers</div><div class="line"><span class="meta">#</span> 可用于移除由于网络变化引发的 Docker 启动的neutron-agents 主机：</div><div class="line">tools/cleanup-host</div><div class="line"><span class="meta">#</span> 可用于从本地缓存中移除所有的 Docker image</div><div class="line"><span class="meta">#</span> tools/cleanup-images</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="故障诊断与排除"><a href="#故障诊断与排除" class="headerlink" title="故障诊断与排除"></a>故障诊断与排除</h3><p>通过 <code>Kolla</code> 和 <code>Ansible</code> 部署或运行 <code>OpenStack</code> 环境时，如果出现问题，通常可以使用如下一些方法来排查/解决</p>
<ul>
<li><p>查看指定容器（即指定的服务）的输出日志信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> docker logs container_name</div></pre></td></tr></table></figure>
</li>
<li><p>查看指定服务的日志<br>直接 <code>CD</code> 到主机的 <code>/var/lib/docker/volumes/kollalogs/data/</code> 目录下，查看指定服务的日志信息。</p>
</li>
<li>查看容器的状态<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> docker ps</div></pre></td></tr></table></figure>
</li>
</ul>
<p>可以使用 <code>docker ps -a</code> 命令查看到安装的 <code>OpenStack</code> 所有服务的容器</p>
<ul>
<li>进入某个容器<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> docker exec -it -u root container_name bash</div></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> kolla </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[cinder删除lvm卷很慢的问题]]></title>
      <url>/posts/cinder%E5%88%A0%E9%99%A4lvm%E5%8D%B7%E5%BE%88%E6%85%A2%E7%9A%84%E9%97%AE%E9%A2%98.html</url>
      <content type="html"><![CDATA[<h3 id="cinder删除lvm卷很慢的问题"><a href="#cinder删除lvm卷很慢的问题" class="headerlink" title="cinder删除lvm卷很慢的问题"></a>cinder删除lvm卷很慢的问题</h3><p>最近搞<code>kolla</code>部署<code>cinder</code>，使用<code>lvm</code>做后端，在<code>cinder-volume</code>服务删除数据卷，数据卷会删除的很慢，在删除这段时间发现宿主机的<code>load</code>飙高，但是检查虚拟机负载没有异常。</p>
<a id="more"></a>
<h3 id="查找原因"><a href="#查找原因" class="headerlink" title="查找原因"></a>查找原因</h3><p>使用<code>iotop</code>查看<br><img src="https://ljw.howieli.cn/blog/2018-03-20/WechatIMG33.jpeg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DEBUG oslo_concurrency.processutils [req-beeeb583-c07e-4f23-8b63-1f76fc729c9a 0a266a36e53e4469a376f5baa4375064 0a266a36e53e4469a376f5baa4375064 - default default] CMD "sudo cinder-rootwrap /etc/cinder/rootwrap.conf dd count=0 if=/dev/zero of=/dev/mapper/cinder--volumes-volume--beeeb583--c07e--4f23--8b63--1f76fc729c9a  oflag=direct" returned: 0 in 0.127s execute /usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py:374</div></pre></td></tr></table></figure>
<p>从日志里面看到，<code>volume</code>服务调用<code>dd</code>命令对数据卷进行数据清空，同时采用<code>oflag=direct</code>参数直接操作块设备。所以，<code>cinder</code>在删除卷的时间长短和卷的大小有着直接关系。（删除期间<code>iowait</code>值会增高，怪不得<code>load</code>也会飙高）</p>
<h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p><code>cinder</code>在删除卷之前要对其做<code>dd</code>操作，是因为<code>LVM</code>在<code>lvremove</code>后重新<code>lvcreate</code>，新的<code>lv</code>里面还保留着老的数据，原来直接删除的<code>lv</code>并不会抹除卷上的数据。<code>cinder</code>之所以要用<code>dd zero</code>,就是为了避免租户<code>A</code>删除卷后，数据不会串到租户<code>B</code>新创建的数据卷上。这样一方面保证租户<code>A</code>的数据安全性，另一方面也避免租户<code>B</code>在使用数据卷的产生的疑惑。</p>
<h3 id="处理问题"><a href="#处理问题" class="headerlink" title="处理问题"></a>处理问题</h3><ul>
<li>关闭volume安全删除<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Allowed values: none, zero, shred</div><div class="line">volume_clear = none</div></pre></td></tr></table></figure>
</li>
</ul>
<p><code>volume_clear</code>采用<code>shred</code>永久删除,</p>
<ul>
<li><p>置零<code>volume</code>头部<code>100MB</code>左右数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Size in MiB to wipe at start of old volumes. 0 =&gt; all (integer value)</div><div class="line">volume_clear_size = 100</div></pre></td></tr></table></figure>
</li>
<li><p>调整<code>dd</code>进程<code>io</code>调度优先策略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># The flag to pass to ionice to alter the i/o priority of the process used to</div><div class="line"># zero a volume after deletion, for example &quot;-c3&quot; for idle only priority.</div><div class="line"># (string value)</div><div class="line">volume_clear_ionice = -c3</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="保证数据绝对安全"><a href="#保证数据绝对安全" class="headerlink" title="保证数据绝对安全"></a>保证数据绝对安全</h4><p><code>volume_clear</code>采用<code>shred</code>永久删除，根据服务器情况适当调整<code>volume_clear_ionice</code>的值。<br>shred会用一些随机内容覆盖文件所在的节点和数据块，<code>cinder</code>在这里条用<code>shred</code>默认参数采用<code>-n 3</code>即重写<code>3</code>次。</p>
<h4 id="数据相对安全的同时，降低数据卷删除时间"><a href="#数据相对安全的同时，降低数据卷删除时间" class="headerlink" title="数据相对安全的同时，降低数据卷删除时间"></a>数据相对安全的同时，降低数据卷删除时间</h4><p><code>volume_clear</code>采用<code>zero</code>填充，根据情况设置<code>volume_clear_size</code>大小，我们都知道，磁盘的开头部分保存着文件系统的元数据以及索引，清空这部分可以一定程度上保证数据的安全。</p>
<p>至于<code>volume_clear=none</code>这种直接删除<code>lv</code>而不清空数据的方式，我就不建议采用了</p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ceph写流程分析]]></title>
      <url>/posts/ceph%E5%86%99%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90.html</url>
      <content type="html"><![CDATA[<h3 id="ceph写流程分析"><a href="#ceph写流程分析" class="headerlink" title="ceph写流程分析"></a>ceph写流程分析</h3><blockquote>
<p>最近年底了，工作也不太忙了，这几天看看ceph，这几天总结的ceph写流程分析笔记（基于jewel版本&gt;10.2.0），现分享出来，欢迎指点。</p>
</blockquote>
<p><img src="https://ljw.howieli.cn/blog/2018-02-09/ceph.jpg" alt=""></p>
<a id="more"></a>
<h3 id="rbd到OSD映射关系"><a href="#rbd到OSD映射关系" class="headerlink" title="rbd到OSD映射关系"></a>rbd到OSD映射关系</h3><p>客户端使用<code>RBD</code>设备，使用<code>librbd</code>、<code>librados</code>库进行访问管理块设备。</p>
<ul>
<li><p>1、创建 一个<code>pool</code>，为这个<code>pool</code>指定<code>pg</code>的数量，同时在这个<code>pool</code>中指明保存数据的副本数（通常为<code>3</code>个副本）。</p>
</li>
<li><p>2、在这个<code>pool</code>中创建一个<code>rbd</code>设备<code>rbd0</code>，那么这个<code>rbd0</code>都会保存三份，在创建<code>rbd0</code>时必须指定<code>rbd</code>的<code>size</code>，对于这个<code>rbd0</code>的任何操作不能超过这个<code>size</code>。</p>
</li>
<li><p>3、将这个块设备进行切块，每个块的大小默认为<code>4M</code>，并且每个块都有一个名字，名字就是<code>object+</code>序号。</p>
</li>
<li><p>4、将每个<code>object</code>通过<code>pg</code>进行副本位置的分配，<code>pg</code>会寻找<code>3</code>个<code>osd</code>，把这个<code>object</code>分别保存在这三个<code>osd</code>上。最后对于<code>object</code>的存储就变成了存储一个文件 <code>rbd0.object1.file</code>。数据层次映射图如下：<br><img src="https://ljw.howieli.cn/blog/2018-02-09/WX20180209-105337.png" alt=""></p>
</li>
</ul>
<p>经过<code>pool</code>，<code>rbd</code>，<code>object</code>、<code>pg</code>的层层映射关系，在<code>PG</code>这一层中，已经知道存储数据的<code>3</code>个<code>OSD</code>所在位置及主从关系。<br>客户端与<code>primay OSD</code>建立<code>SOCKET</code> 通信，将要写入的数据传给<code>primary OSD</code>，由<code>primary OSD</code>再将数据发送给其他<code>replica OSD</code>数据节点。</p>
<h4 id="RBD保存形式"><a href="#RBD保存形式" class="headerlink" title="RBD保存形式"></a>RBD保存形式</h4><p>如下图所示，<code>Ceph</code> 系统中不同层次的组件/用户所看到的数据的形式是不一样的：<br><img src="https://ljw.howieli.cn/blog/2018-02-09/697113-20150928152213918-1722034221.jpg" alt=""></p>
<ul>
<li><code>Ceph</code> 客户端所见的是一个完整的连续的二进制数据块，其大小为创建 <code>RBD image</code> 是设置的大小或者 <code>resize</code> 的大小，客户端可以从头或者从某个位置开始写入二进制数据。</li>
<li><code>librados</code> 负责在 <code>RADOS</code> 中创建对象（<code>object</code>），其大小为 <code>pool</code> 的 <code>order</code> 决定，默认情况下 <code>order = 22</code> 此时 <code>object</code> 大小为 <code>4MB</code>；以及负责将客户端传入的二进制块条带化为若干个条带（<code>stripe</code>）。</li>
<li><code>librados</code> 控制哪个条带由哪个 <code>OSD</code> 写入（条带 —写入哪个—-&gt; <code>object</code> —-位于哪个 —-&gt; <code>OSD</code>）</li>
</ul>
<p><code>OSD</code> 负责创建在文件系统中创建文件，并将 <code>librados</code> 传入的数据写入数据。</p>
<ol>
<li><code>Ceph client</code> 调用 <code>librados</code> 创建一个 <code>RBD image</code>，这时候不会做存储空间分配，而是创建若干元数据对象来保存元数据信息。</li>
<li><code>Ceph client</code> 调用 <code>librados</code> 开始写数据。<code>librados</code> 计算条带、<code>object</code> 等，然后开始写第一个 <code>stripe</code> 到特定的目标 <code>object</code>。</li>
<li><code>librados</code> 根据 <code>CRUSH</code> 算法，计算出 <code>object</code> 所对应的主 <code>OSD ID</code>，并将二进制数据发给它。</li>
<li>主 <code>OSD</code> 负责调用文件系统接口将二进制数据写入磁盘上的文件（每个 <code>object</code> 对应一个 <code>file，file</code> 的内容是一个或者多个 <code>stripe</code>）。</li>
<li><p>主 <code>ODS</code> 完成数据写入后，它使用 <code>CRUSH</code> 算啊计算出第二个<code>OSD</code>（<code>secondary OSD</code>）和第三个<code>OSD</code>（<code>tertiary OSD</code>）的位置，然后向这两个 <code>OSD</code> 拷贝对象。都完成后，它向 <code>ceph client</code>反馈该 <code>object</code> 保存完毕。</p>
<p><code>Ceph client</code> 向一个 <code>RBD image</code> 写入二进制数据（假设 pool 的拷贝份数为 3）<br><img src="https://ljw.howieli.cn/blog/2018-02-09/WX20180209-110527.png" alt=""></p>
</li>
</ol>
<h3 id="客户的写流程操作"><a href="#客户的写流程操作" class="headerlink" title="客户的写流程操作"></a>客户的写流程操作</h3><p>在客户端使用 rbd 时一般有两种方法：</p>
<ul>
<li>第一种 是 <code>Kernel rbd</code>。就是创建了<code>rbd</code>设备后，把<code>rbd</code>设备<code>map</code>到内核中，形成一个虚拟的块设备，这时这个块设备同其他通用块设备一样，一般的设备文件为<code>/dev/rbd0</code>，后续直接使用这个块设备文件就可以了，可以把 <code>/dev/rbd0</code> 格式化后 <code>mount</code> 到某个目录，也可以直接作为裸设备使用。这时对<code>rbd</code>设备的操作都通过<code>kernel rbd</code>操作方法进行的。 </li>
<li>第二种是 <code>librbd</code> 方式。就是创建了<code>rbd</code>设备后，这时可以使用<code>librbd</code>、<code>librados</code>库进行访问管理块设备。这种方式不会<code>map</code>到内核，直接调用<code>librbd</code>提供的接口，可以实现对<code>rbd</code>设备的访问和管理，但是不会在客户端产生块设备文件。</li>
</ul>
<p>应用写入<code>rbd</code>块设备的过程：</p>
<ol>
<li>应用调用 <code>librbd</code> 接口或者对<code>linux</code> 内核虚拟块设备写入二进制块。下面以 <code>librbd</code> 为例。</li>
<li><code>librbd</code> 对二进制块进行分块，默认块大小为 <code>4M</code>，每一块都有名字，成为一个对象</li>
<li><code>librbd</code> 调用 <code>librados</code> 将对象写入 <code>Ceph</code> 集群</li>
<li><code>librados</code> 向主 <code>OSD</code> 写入分好块的二进制数据块 (先建立<code>TCP/IP</code>连接，然后发送消息给 <code>OSD</code>，<code>OSD</code> 接收后写入其磁盘)</li>
<li>主 <code>OSD</code> 负责同时向一个或者多个次 <code>OSD</code> 写入副本。注意这里是写到日志（<code>Journal</code>）就返回，因此，使用<code>SSD</code>作为<code>Journal</code>的话，可以提高响应速度，做到服务器端对客户端的快速同步返回写结果（<code>ack</code>）。</li>
<li>当主次<code>OSD</code>都写入完成后，主 <code>OSD</code> 向客户端返回写入成功。</li>
<li>当一段时间（也许得几秒钟）后<code>Journal</code> 中的数据向磁盘写入成功后，<code>Ceph</code>通过事件通知客户端数据写入磁盘成功（<code>commit</code>），此时，客户端可以将写缓存中的数据彻底清除掉了。</li>
<li>默认地，<code>Ceph</code> 客户端会缓存写入的数据直到收到集群的<code>commit</code>通知。如果此阶段内（在写方法返回到收到<code>commit</code>通知之间）<code>OSD</code> 出故障导致数据写入文件系统失败，<code>Ceph</code> 将会允许客户端重做尚未提交的操作（<code>replay</code>）。因此，<code>PG</code> 有个状态叫 <code>replay：“The placement group is waiting for clients to replay operations after an OSD crashed.”</code>。<br><img src="https://ljw.howieli.cn/blog/2018-02-09/697113-20160507205321796-1810415144.jpg" alt=""><br>也就是，文件系统负责文件处理，<code>librbd</code> 负责块处理，<code>librados</code> 负责对象处理，<code>OSD</code> 负责将数据写入在<code>Journal</code>和磁盘中。</li>
</ol>
<h3 id="osd端写操作处理流程"><a href="#osd端写操作处理流程" class="headerlink" title="osd端写操作处理流程"></a>osd端写操作处理流程</h3><p>而对于写操作而言，由于要保证数据写入的同步性就会复杂很多：</p>
<ol>
<li><p>首先客户端会将数据发送给主osd，</p>
</li>
<li><p>主<code>osd</code>同样要先进行写操作预处理，完成后它要发送写消息给其他的从<code>osd</code>，让他们对副本<code>pg</code>进行更改，</p>
</li>
<li><p>从<code>osd</code>通过<code>FileJournal</code>完成写操作到<code>Journal</code>中后发送消息告诉主<code>osd</code>说完成，进入<code>5</code></p>
</li>
<li><p>当主<code>osd</code>收到所有的从<code>osd</code>完成写操作的消息后，会通过<code>FileJournal</code>完成自身的写操作到<code>Journal</code>中。完成后会通知客户端，已经完成了写操作。</p>
</li>
<li><p>主<code>osd</code>，从<code>osd</code>的线程开始工作调用<code>Filestore</code>将<code>Journal</code>中的数据写入到底层文件系统中。</p>
</li>
</ol>
<p>今天就先总结这么多，总结的不太好，请谅解</p>
]]></content>
      
        <categories>
            
            <category> ceph </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ceph </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[手动构建Openstack镜像]]></title>
      <url>/posts/%E6%89%8B%E5%8A%A8%E6%9E%84%E5%BB%BAOpenstack%E9%95%9C%E5%83%8F.html</url>
      <content type="html"><![CDATA[<h3 id="手动构建Openstack镜像"><a href="#手动构建Openstack镜像" class="headerlink" title="手动构建Openstack镜像"></a>手动构建Openstack镜像</h3><p>本文以centos7镜像为例，详细介绍手动制作Openstack镜像的步骤，镜像支持一下几个功能：</p>
<ul>
<li>支持密码注入功能(nova boot时通过–admin-pass参数指定设置初始密码）</li>
<li>支持根分区自动调整(根分区自动调整为flavor disk大小，而不是原始镜像分区大小)</li>
<li>支持动态修改密码(使用nova set-password命令可以修改管理员密码)</li>
</ul>
<p>镜像的宿主机操作系统为CentOs7.4，开启了VT功能(使用kvm-ok命令验证)并安装了libvirt系列工具，包括virsh、virt-manager、libguestfs-tools等。</p>
<a id="more"></a>
<h3 id="下载iso镜像"><a href="#下载iso镜像" class="headerlink" title="下载iso镜像"></a>下载iso镜像</h3><p>下载centos7.4.iso镜像，可以选择中国镜像源，相对国外镜像源下载速度会快很多，这里我已经下载好了。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> qemu-img info CentOS-7-x86_64-DVD-1708.iso </span></div><div class="line">image: CentOS-7-x86_64-DVD-1708.iso</div><div class="line">file format: raw</div><div class="line">virtual size: 4.2G (4521459712 bytes)</div><div class="line">disk size: 4.2G</div></pre></td></tr></table></figure></p>
<h3 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h3><p>首先创建一个qcow2格式镜像文件，用于虚拟机的根磁盘，大小10G就够了。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> qemu-img create <span class="_">-f</span> qcow2 centos.qcow2 10G</span></div><div class="line">Formatting 'centos.qcow2', fmt=qcow2 size=10737418240 encryption=off cluster_size=65536 lazy_refcounts=off</div></pre></td></tr></table></figure></p>
<p>使用以下脚本创建并启动虚拟机：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">NAME=centos</div><div class="line">ROOT_DISK=centos.qcow2</div><div class="line">CDROM=`pwd`/CentOS-7-x86_64-DVD-1708.iso</div><div class="line">virt-install --virt-type kvm --name $NAME --ram 1024 \</div><div class="line">--disk $ROOT_DISK,format=qcow2 \</div><div class="line">--network network=default \</div><div class="line">--graphics vnc,listen=0.0.0.0 --noautoconsole \</div><div class="line">--os-type=linux --os-variant=rhel7 \</div><div class="line">--cdrom=$CDROM</div></pre></td></tr></table></figure></p>
<p>启动完成后，使用vnc client连接或者使用virt-manager、virt-viewer连接,这里我直接用virt-manager。</p>
<h3 id="安装OS"><a href="#安装OS" class="headerlink" title="安装OS"></a>安装OS</h3><p>进入虚拟机控制台可以看到CentOS的启动菜单，选择Install Centos 7，继续选择语言后将进入INSTALLION SUMMARY，其中大多数配置默认即可，SOFTWARE SELECTION选择Minimal Install，INSTALLATION DESTINATION需要选择手动配置分区，我们只需要一个根分区即可，不需要swap分区，文件系统选择ext4或者xfs，存储驱动选择Virtio Block Device，如图：<br><img src="https://ljw.howieli.cn/blog/2018-1-12/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180112113728.png" alt=""></p>
<p>配置完成后就可以开始安装了，在CONFIGURATION中设置root临时密码，只需要暂时记住这个临时密码，制作完后cloud-init会重新设置root初始密码。</p>
<p>大约几分钟后，即可自动完成安装配置工作，最后点击右下角的reboot重启退出虚拟机。</p>
<h3 id="配置OS"><a href="#配置OS" class="headerlink" title="配置OS"></a>配置OS</h3><p>安装好操作系统后，需要进行配置才能作为glance镜像使用，启动虚拟机<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> virsh list --all</span></div><div class="line"> Id    名称                         状态</div><div class="line">----------------------------------------------------</div><div class="line"> -     centos                         关闭</div><div class="line"><span class="meta">#</span><span class="bash"> virsh start centos</span></div></pre></td></tr></table></figure></p>
<p>如果云主机不需要支持root ssh远程登录，需要关闭root远程ssh登录功能，修改配置文件/etc/ssh/sshd_config并修改PermitRootLogin值为no，默认是开启的（这里我不做更改，如果更改需要重启ssh服务生效）。</p>
<p>为了加快安装速度，可以配置为本地软件源仓库，若没有本地镜像仓库，则选择国内的软件源，相对官网的速度下载要快。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum -y install wget</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/yum.repos.d/ &amp;&amp; rm -rf * &amp;&amp; <span class="built_in">cd</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></div><div class="line"><span class="meta">#</span><span class="bash"> wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span></div></pre></td></tr></table></figure></p>
<h3 id="acpid"><a href="#acpid" class="headerlink" title="acpid"></a>acpid</h3><p><a href="https://wiki.archlinux.org/index.php/Acpid" target="_blank" rel="external">acpid</a>是一个用户空间的服务进程, 用来处理电源相关事件,比如将kernel中的电源事件转发给应用程序，告诉应用程序安全的退出，防止应用程序异常退出导致数据损坏。libvirt可以通过向guest虚拟机发送acpid事件触发电源操作，使虚拟机安全关机、重启等操作，相对于强制执行关闭电源操作更安全。通过acpid事件发送开关机信号即我们经常所说的软重启或者软关机。<br>为了支持软操作，虚拟机需要安装acpid服务，并设置开机自启动：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum -y install acpid</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> acpid</span></div></pre></td></tr></table></figure></p>
<p>提示：</p>
<ul>
<li>用户执行重启或者关机操作时，OpenStack会首先尝试调用libvirt的shutdown方法，即软关机。</li>
<li>当软关机执行失败或者超时(默认120秒)，则会调动libvirt的destroy方法，即强制关机，因此如果虚拟机关机或者重启很慢，很可能是acpid没有正常运行。</li>
<li>为了使虚拟机进程安全退出，减少数据损坏风险，尽量使用软操作，硬操作可能导致程序崩溃或者数据丢失。</li>
</ul>
<h3 id="console-log"><a href="#console-log" class="headerlink" title="console log"></a>console log</h3><p>当操作系统内核崩溃时会报出内核系统crash出错信息，通常启动的时候一闪而过, 而此时系统还没有起来，不能通过远程工具(比如ssh)进入系统查看，我们可以通过配置grub，把这些日志重定向到Serial Console中，这样我们就可以通过Serial console来访问错误信息，以供分析和排错使用。<br>修改配置文件/etc/default/grub，设置GRUB_CMDLINE_LINUX，：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRUB_CMDLINE_LINUX="crashkernel=auto console=tty0 console=ttyS0,115200n8"</div></pre></td></tr></table></figure></p>
<p>通过这个配置，内核信息会以115200的波特率同时发送到tty0和ttyS0串行端口设备。libvirt可以通过一个普通文件模拟这个串行端口：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">'file'</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">path</span>=<span class="string">'/var/lib/nova/instances/99579ce1-f4c4-4031-a56c-68e85a3d037a/console.log'</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">port</span>=<span class="string">'0'</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">serial</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这样内核产生的日志发到ttyS0，实际上写到console.log文件中。</p>
<p>OpenStack通过nova console-log命令可以获取该文件内容，查看错误日志。</p>
<h3 id="qemu-guest-agent"><a href="#qemu-guest-agent" class="headerlink" title="qemu-guest-agent"></a>qemu-guest-agent</h3><p>qemu-guest-agent是运行在虚拟机内部的一个服务，libvirt会在本地创建一个unix socket，模拟为虚拟机内部的一个串口设备，从而实现了宿主机与虚拟机通信，这种方式不依赖于TCP/IP网络，实现方式简单方便。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">'unix'</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">mode</span>=<span class="string">'bind'</span> <span class="attr">path</span>=<span class="string">'/var/lib/libvirt/qemu/org.qemu.guest_agent.0.instance-00003c2c.sock'</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">'virtio'</span> <span class="attr">name</span>=<span class="string">'org.qemu.guest_agent.0'</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">'virtio-serial'</span> <span class="attr">controller</span>=<span class="string">'0'</span> <span class="attr">bus</span>=<span class="string">'0'</span> <span class="attr">port</span>=<span class="string">'1'</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如上宿主机的socket文件为org.qemu.guest_agent.0.instance-00003c2c.sock，在虚拟机内部为/dev/virtio-ports/org.qemu.guest_agent.0。</p>
<p>通过这种方式，宿主机可以发送指令写到socket文件中，虚拟机内部的qemu-guest-agent会轮询查看这个串行设备是否有指令，一旦接收到指令就可以执行对应的脚本，从而实现了宿主机控制虚拟机执行命令的功能，其中最常用的指令就是通过libvirt修改虚拟机密码。更多关于qemu-guest-agent请参考<a href="http://link.zhihu.com/?target=http%3A//wiki.qemu.org/Features/QAPI/GuestAgent" target="_blank" rel="external">官方文档</a>。</p>
<p>为了支持OpenStack平台动态修改虚拟机密码功能，我们需要手动安装qemu-guest-agent：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install -y qemu-guest-agent</span></div></pre></td></tr></table></figure></p>
<p>修改/etc/sysconfig/qemu-ga配置文件:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">virsh qemu-agent-command instance-000028d5 '&#123;"execute":"guest-info"&#125;' | python -m json.tool | grep 'name' | cut -d ':' -f 2 | tr -d '",'</div><div class="line"> ...</div><div class="line"> guest-set-user-password</div><div class="line"> guest-get-fsinfo</div><div class="line"> guest-set-vcpus</div><div class="line"> guest-get-vcpus</div><div class="line"> ...</div></pre></td></tr></table></figure></p>
<p>确认包含guest-set-user-password指令，支持修改管理员密码。</p>
<h3 id="zeroconf"><a href="#zeroconf" class="headerlink" title="zeroconf"></a>zeroconf</h3><p>zeroconf启动时会自动创建一条路由169.254.0.0/16，而虚拟机访问metadata服务的地址正好是169.254.169.254，如果启动了zeroconf服务，由于路由冲突，虚拟机不能通过169.254.169.254路由到网络节点的metadata服务了。OpenStack虚拟机通常都是通过DHCP获取IP的，因此我们并不需要zeroconf服务。为了虚拟机能够访问metadata服务，我们必须禁止zeroconf服务，关于该问题的更详细讨论可参考<a href="https://zhuanlan.zhihu.com/p/30385809" target="_blank" rel="external">bug#983611</a>：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"NOZEROCONF=yes"</span> &gt;&gt; /etc/sysconfig/network</span></div></pre></td></tr></table></figure></p>
<h3 id="cloud-init"><a href="#cloud-init" class="headerlink" title="cloud-init"></a>cloud-init</h3><p>接下来安装cloud-init，cloud-init是虚拟机第一次启动时执行的脚本，主要负责从metadata服务中拉取配置信息，完成虚拟机的初始化工作，比如设置主机名、初始化密码以及注入密钥等。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install -y cloud-init</span></div></pre></td></tr></table></figure></p>
<h3 id="growpart"><a href="#growpart" class="headerlink" title="growpart"></a>growpart</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum update -y</span></div><div class="line"><span class="meta">#</span><span class="bash"> yum install -y epel-release</span></div><div class="line"><span class="meta">#</span><span class="bash"> yum install -y cloud-utils-growpart.x86.64</span></div><div class="line"><span class="meta">#</span><span class="bash"> rpm -qa kernel | sed <span class="string">'s/^kernel-//'</span>  | xargs -I &#123;&#125; dracut <span class="_">-f</span> /boot/initramfs-&#123;&#125;.img &#123;&#125;</span></div></pre></td></tr></table></figure>
<p>完成以上工作后，我们的镜像配置基本结束，删除一些无用文件，清理history命令后执行关机：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> shutdown -h now</span></div></pre></td></tr></table></figure></p>
<h3 id="移除本地信息"><a href="#移除本地信息" class="headerlink" title="移除本地信息"></a>移除本地信息</h3><p>在宿主机上运行以下命名，移除宿主机信息，比如mac地址等。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> virt-sysprep <span class="_">-d</span> centos</span></div><div class="line">[   0.0] Examining the guest ...</div><div class="line">[  41.1] Performing "abrt-data" ...</div><div class="line">[  42.4] Performing "backup-files" ...</div><div class="line">[  44.4] Performing "bash-history" ...</div><div class="line">[  44.4] Performing "blkid-tab" ...</div><div class="line">[  44.5] Performing "crash-data" ...</div><div class="line">[  44.5] Performing "cron-spool" ...</div><div class="line">[  44.5] Performing "dhcp-client-state" ...</div><div class="line">[  44.5] Performing "dhcp-server-state" ...</div><div class="line">[  44.5] Performing "dovecot-data" ...</div><div class="line">[  44.5] Performing "logfiles" ...</div><div class="line">[  44.7] Performing "machine-id" ...</div><div class="line">[  44.7] Performing "mail-spool" ...</div><div class="line">[  44.7] Performing "net-hostname" ...</div><div class="line">[  44.8] Performing "net-hwaddr" ...</div><div class="line">[  44.8] Performing "pacct-log" ...</div><div class="line">[  44.8] Performing "package-manager-cache" ...</div><div class="line">[  44.8] Performing "pam-data" ...</div><div class="line">[  44.8] Performing "passwd-backups" ...</div><div class="line">[  44.8] Performing "puppet-data-log" ...</div><div class="line">[  44.8] Performing "rh-subscription-manager" ...</div><div class="line">[  44.8] Performing "rhn-systemid" ...</div><div class="line">[  44.8] Performing "rpm-db" ...</div><div class="line">[  44.8] Performing "samba-db-log" ...</div><div class="line">[  44.8] Performing "script" ...</div><div class="line">[  44.8] Performing "smolt-uuid" ...</div><div class="line">[  44.8] Performing "ssh-hostkeys" ...</div><div class="line">[  44.8] Performing "ssh-userdir" ...</div><div class="line">[  44.8] Performing "sssd-db-log" ...</div><div class="line">[  44.9] Performing "tmp-files" ...</div><div class="line">[  44.9] Performing "udev-persistent-net" ...</div><div class="line">[  44.9] Performing "utmp" ...</div><div class="line">[  44.9] Performing "yum-uuid" ...</div><div class="line">[  44.9] Performing "customize" ...</div><div class="line">[  44.9] Setting a random seed</div><div class="line">[  45.4] Performing "lvm-uuids" ...</div></pre></td></tr></table></figure></p>
<p>删除虚拟机，镜像制作完成。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> virsh list --all</span></div><div class="line"> Id    名称                         状态</div><div class="line">----------------------------------------------------</div><div class="line"> -     centos                         关闭</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> virsh undefine centos</span></div><div class="line">域 centos 已经被取消定义</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> virsh list --all</span></div><div class="line"> Id    名称                         状态</div><div class="line">----------------------------------------------------</div></pre></td></tr></table></figure></p>
<h3 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h3><p>镜像制作完成，上传centos.qcow2到glance服务中<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> glance image-create --file ./centos.qcow2 --disk-format qcow2 \</span></div><div class="line">    --container-format bare --name CentOS-7.2 --progress</div></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ceph ( requests are blocked ) 异常解决方法]]></title>
      <url>/posts/ceph%20(%20requests%20are%20blocked%20)%20%E5%BC%82%E5%B8%B8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html</url>
      <content type="html"><![CDATA[<h3 id="ceph-requests-are-blocked-异常解决方法"><a href="#ceph-requests-are-blocked-异常解决方法" class="headerlink" title="ceph ( requests are blocked ) 异常解决方法"></a>ceph ( requests are blocked ) 异常解决方法</h3><p><img src="https://ljw.howieli.cn/blog/2018-1-8/%E4%BF%AE%E7%90%86%E5%B7%A5.png" alt=""><br><a id="more"></a><br>最近发现客户kolla平台的ceph环境遇到下面异常错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph -s</div><div class="line">    cluster b233a0b7-4e21-4375-bca8-e215c056cc25</div><div class="line">     health HEALTH_WARN</div><div class="line">            2 requests are blocked &gt; 32 sec</div><div class="line">     monmap e1: 3 mons at &#123;10.254.253.1=10.254.253.1:6789/0,10.254.253.2=10.254.253.2:6789/0,10.254.253.3=10.254.253.3:6789/0&#125;</div><div class="line">            election epoch 26, quorum 0,1,2 10.254.253.1,10.254.253.2,10.254.253.3</div><div class="line">     osdmap e380: 90 osds: 90 up, 90 in</div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v1730087: 1008 pgs, 11 pools, 3502 GB data, 886 kobjects</div><div class="line">            10463 GB used, 235 TB / 245 TB avail</div><div class="line">                1007 active+clean</div><div class="line">                   1 active+clean+scrubbing+deep</div><div class="line">  client io 1838 kB/s rd, 100 MB/s wr, 457 op/s rd, 929 op/s wr</div></pre></td></tr></table></figure></p>
<p>注意: 1 requests are blocked &gt; 32 sec 有可能是在数据迁移过程中, 用户正在对该数据块进行访问, 但访问还没有完成, 数据就迁移到别的 OSD 中, 那么就会导致有请求被 block, 对用户也是有影响的</p>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p>1.寻找block的请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph health detail</div><div class="line">HEALTH_WARN 2 requests are blocked &gt; 32 sec; 1 osds have slow requests</div><div class="line">2 ops are blocked &gt; 4194.3 sec on osd.5</div><div class="line">1 osds have slow requests</div></pre></td></tr></table></figure></p>
<p>可以考到osd.5具有一个操作block<br>2.查找osd对应的主机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph osd tree</div><div class="line">ID  WEIGHT    TYPE NAME              UP/DOWN REWEIGHT PRIMARY-AFFINITY </div><div class="line"> -1 270.00000 root default                                             </div><div class="line"> -2  27.00000     host 10.254.253.1                                    </div><div class="line">  0   3.00000         osd.0               up  1.00000          1.00000 </div><div class="line">  5   3.00000         osd.5               up  1.00000          1.00000 </div><div class="line"> 10   3.00000         osd.10              up  1.00000          1.00000 </div><div class="line"> 15   3.00000         osd.15              up  1.00000          1.00000 </div><div class="line"> 21   3.00000         osd.21              up  1.00000          1.00000 </div><div class="line"> 27   3.00000         osd.27              up  1.00000          1.00000 </div><div class="line"> 30   3.00000         osd.30              up  1.00000          1.00000 </div><div class="line"> 36   3.00000         osd.36              up  1.00000          1.00000 </div><div class="line"> 42   3.00000         osd.42              up  1.00000          1.00000 </div><div class="line"> -3  27.00000     host 10.254.253.5                                    </div><div class="line">  2   3.00000         osd.2               up  1.00000          1.00000 </div><div class="line">  6   3.00000         osd.6               up  1.00000          1.00000 </div><div class="line"> 11   3.00000         osd.11              up  1.00000          1.00000 </div><div class="line"> 17   3.00000         osd.17              up  1.00000          1.00000 </div><div class="line"> 20   3.00000         osd.20              up  1.00000          1.00000 </div><div class="line"> 25   3.00000         osd.25              up  1.00000          1.00000 </div><div class="line"> 31   3.00000         osd.31              up  1.00000          1.00000 </div><div class="line"> 35   3.00000         osd.35              up  1.00000          1.00000 </div><div class="line"> 41   3.00000         osd.41              up  1.00000          1.00000 </div><div class="line"> -4  27.00000     host 10.254.253.2                                    </div><div class="line">  1   3.00000         osd.1               up  1.00000          1.00000 </div><div class="line">  7   3.00000         osd.7               up  1.00000          1.00000 </div><div class="line"> 12   3.00000         osd.12              up  1.00000          1.00000 </div><div class="line"> 16   3.00000         osd.16              up  1.00000          1.00000 </div><div class="line"> 22   3.00000         osd.22              up  1.00000          1.00000 </div><div class="line"> 26   3.00000         osd.26              up  1.00000          1.00000 </div><div class="line"> 32   3.00000         osd.32              up  1.00000          1.00000 </div><div class="line"> 37   3.00000         osd.37              up  1.00000          1.00000 </div><div class="line"> 40   3.00000         osd.40              up  1.00000          1.00000 </div><div class="line"> -6  27.00000     host 10.254.253.4                                    </div><div class="line">  3   3.00000         osd.3               up  1.00000          1.00000 </div><div class="line">  8   3.00000         osd.8               up  1.00000          1.00000 </div><div class="line"> 13   3.00000         osd.13              up  1.00000          1.00000 </div><div class="line"> 18   3.00000         osd.18              up  1.00000          1.00000 </div><div class="line"> 24   3.00000         osd.24              up  1.00000          1.00000 </div><div class="line"> 29   3.00000         osd.29              up  1.00000          1.00000 </div><div class="line"> 33   3.00000         osd.33              up  1.00000          1.00000 </div><div class="line"> 39   3.00000         osd.39              up  1.00000          1.00000 </div><div class="line"> 43   3.00000         osd.43              up  1.00000          1.00000 </div><div class="line"> -5  27.00000     host 10.254.253.3                                    </div><div class="line">  4   3.00000         osd.4               up  1.00000          1.00000 </div><div class="line">  9   3.00000         osd.9               up  1.00000          1.00000 </div><div class="line"> 14   3.00000         osd.14              up  1.00000          1.00000 </div><div class="line"> 19   3.00000         osd.19              up  1.00000          1.00000 </div><div class="line"> 23   3.00000         osd.23              up  1.00000          1.00000 </div><div class="line"> 28   3.00000         osd.28              up  1.00000          1.00000 </div><div class="line"> 34   3.00000         osd.34              up  1.00000          1.00000 </div><div class="line"> 38   3.00000         osd.38              up  1.00000          1.00000 </div><div class="line"> 44   3.00000         osd.44              up  1.00000          1.00000 </div><div class="line"> -7  27.00000     host 10.254.253.8                                    </div><div class="line"> 47   3.00000         osd.47              up  1.00000          1.00000 </div><div class="line"> 51   3.00000         osd.51              up  1.00000          1.00000 </div><div class="line"> 56   3.00000         osd.56              up  1.00000          1.00000 </div><div class="line"> 61   3.00000         osd.61              up  1.00000          1.00000 </div><div class="line"> 66   3.00000         osd.66              up  1.00000          1.00000 </div><div class="line"> 71   3.00000         osd.71              up  1.00000          1.00000 </div><div class="line"> 76   3.00000         osd.76              up  1.00000          1.00000 </div><div class="line"> 81   3.00000         osd.81              up  1.00000          1.00000 </div><div class="line"> 86   3.00000         osd.86              up  1.00000          1.00000 </div><div class="line"> -8  27.00000     host 10.254.253.7                                    </div><div class="line"> 46   3.00000         osd.46              up  1.00000          1.00000 </div><div class="line"> 52   3.00000         osd.52              up  1.00000          1.00000 </div><div class="line"> 57   3.00000         osd.57              up  1.00000          1.00000 </div><div class="line"> 62   3.00000         osd.62              up  1.00000          1.00000 </div><div class="line"> 67   3.00000         osd.67              up  1.00000          1.00000 </div><div class="line"> 72   3.00000         osd.72              up  1.00000          1.00000 </div><div class="line"> 77   3.00000         osd.77              up  1.00000          1.00000 </div><div class="line"> 82   3.00000         osd.82              up  1.00000          1.00000 </div><div class="line"> 87   3.00000         osd.87              up  1.00000          1.00000 </div><div class="line"> -9  27.00000     host 10.254.253.9                                    </div><div class="line"> 48   3.00000         osd.48              up  1.00000          1.00000 </div><div class="line"> 53   3.00000         osd.53              up  1.00000          1.00000 </div><div class="line"> 58   3.00000         osd.58              up  1.00000          1.00000 </div><div class="line"> 63   3.00000         osd.63              up  1.00000          1.00000 </div><div class="line"> 68   3.00000         osd.68              up  1.00000          1.00000 </div><div class="line"> 73   3.00000         osd.73              up  1.00000          1.00000 </div><div class="line"> 78   3.00000         osd.78              up  1.00000          1.00000 </div><div class="line"> 83   3.00000         osd.83              up  1.00000          1.00000 </div><div class="line"> 88   3.00000         osd.88              up  1.00000          1.00000 </div><div class="line">-10  27.00000     host 10.254.253.10                                   </div><div class="line"> 49   3.00000         osd.49              up  1.00000          1.00000 </div><div class="line"> 54   3.00000         osd.54              up  1.00000          1.00000 </div><div class="line"> 59   3.00000         osd.59              up  1.00000          1.00000 </div><div class="line"> 64   3.00000         osd.64              up  1.00000          1.00000 </div><div class="line"> 69   3.00000         osd.69              up  1.00000          1.00000 </div><div class="line"> 74   3.00000         osd.74              up  1.00000          1.00000 </div><div class="line"> 79   3.00000         osd.79              up  1.00000          1.00000 </div><div class="line"> 84   3.00000         osd.84              up  1.00000          1.00000 </div><div class="line"> 89   3.00000         osd.89              up  1.00000          1.00000 </div><div class="line">-11  27.00000     host 10.254.253.6                                    </div><div class="line"> 50   3.00000         osd.50              up  1.00000          1.00000 </div><div class="line"> 55   3.00000         osd.55              up  1.00000          1.00000 </div><div class="line"> 60   3.00000         osd.60              up  1.00000          1.00000 </div><div class="line"> 65   3.00000         osd.65              up  1.00000          1.00000 </div><div class="line"> 70   3.00000         osd.70              up  1.00000          1.00000 </div><div class="line"> 75   3.00000         osd.75              up  1.00000          1.00000 </div><div class="line"> 80   3.00000         osd.80              up  1.00000          1.00000 </div><div class="line"> 85   3.00000         osd.85              up  1.00000          1.00000 </div><div class="line"> 90   3.00000         osd.90              up  1.00000          1.00000</div></pre></td></tr></table></figure></p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# docker restart ceph_osd_5</div><div class="line">ceph_osd_5</div><div class="line"></div><div class="line">[root@control01 ~]# docker ps|grep ceph_osd_5</div><div class="line">9c4fe5eb0090        10.254.254.1:4000/99cloud/centos-source-ceph-osd:animbus-5.4.0                    &quot;kolla_start&quot;            3 weeks ago         Up 13 seconds</div></pre></td></tr></table></figure>
<p>系统会对该 osd 执行 recovery 操作, recovery 过程中, 会断开 block request, 那么这个 request 将会重新请求 mon 节点, 并重新获得新的 pg map, 得到最新的数据访问位置, 从而解决上述问题。</p>
<h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(ceph-mon)[root@control01 /]# ceph -s</div><div class="line">    cluster b233a0b7-4e21-4375-bca8-e215c056cc25</div><div class="line">     health HEALTH_OK</div><div class="line">     monmap e1: 3 mons at &#123;10.254.253.1=10.254.253.1:6789/0,10.254.253.2=10.254.253.2:6789/0,10.254.253.3=10.254.253.3:6789/0&#125;</div><div class="line">            election epoch 26, quorum 0,1,2 10.254.253.1,10.254.253.2,10.254.253.3</div><div class="line">     osdmap e387: 90 osds: 90 up, 90 in</div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v1730238: 1008 pgs, 11 pools, 3498 GB data, 886 kobjects</div><div class="line">            10453 GB used, 235 TB / 245 TB avail</div><div class="line">                1006 active+clean</div><div class="line">                   2 active+clean+scrubbing+deep</div><div class="line">  client io 1090 kB/s rd, 92507 kB/s wr, 778 op/s rd, 904 op/s wr</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> ceph </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ceph </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[shell实现局域网IP扫描]]></title>
      <url>/posts/%E7%AE%80%E5%8D%95shell%E5%AE%9E%E7%8E%B0%E5%B1%80%E5%9F%9F%E7%BD%91IP%E6%89%AB%E6%8F%8F.html</url>
      <content type="html"><![CDATA[<h3 id="简单shell实现局域网IP扫描"><a href="#简单shell实现局域网IP扫描" class="headerlink" title="简单shell实现局域网IP扫描"></a>简单shell实现局域网IP扫描</h3><p>简单shell实现局域网IP扫描<br>局域网主机联通性的扫描<br><a id="more"></a></p>
<h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#简单shell实现局域网IP扫描</div><div class="line">#Functions: 局域网主机联通性的扫描</div><div class="line">#Author: ljw</div><div class="line"></div><div class="line">network=$1</div><div class="line">time=$(date +%H%M%S)</div><div class="line"></div><div class="line">for i in $(seq $2 $3)</div><div class="line">do</div><div class="line">    ping -c 1 -w 2 $network.$i &gt; /dev/null</div><div class="line">    if [ $? -eq 0 ]; then</div><div class="line">          arp $network.$i | grep &quot;:&quot; | awk &apos;&#123;print $1,$3&#125;&apos; &gt;&gt; $time.log</div><div class="line">          echo &quot;host $network.$i is up&quot;</div><div class="line">   else</div><div class="line">          echo &quot;host $network.$i is down&quot;</div><div class="line">   fi</div><div class="line">done</div></pre></td></tr></table></figure>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./netscan.sh 172.18.22 100 130</div></pre></td></tr></table></figure>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># sh netscan.sh 172.18.22 100 130</div><div class="line">host 172.18.22.100 is up</div><div class="line">host 172.18.22.101 is up</div><div class="line">host 172.18.22.102 is up</div><div class="line">host 172.18.22.103 is up</div><div class="line">host 172.18.22.104 is down</div><div class="line">host 172.18.22.105 is down</div><div class="line">host 172.18.22.106 is down</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> shell </category>
            
        </categories>
        
        
        <tags>
            
            <tag> shell </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在kolla中配置cinder ceph多后端]]></title>
      <url>/posts/%E5%9C%A8kolla%E4%B8%AD%E9%85%8D%E7%BD%AEcinder%20ceph%E5%A4%9A%E5%90%8E%E7%AB%AF.html</url>
      <content type="html"><![CDATA[<h3 id="利用kolla中配置cinder-ceph多后端"><a href="#利用kolla中配置cinder-ceph多后端" class="headerlink" title="利用kolla中配置cinder ceph多后端"></a>利用kolla中配置cinder ceph多后端</h3><p>我一台有2块硬盘，1块ssd（性能盘）和1块sata（容量盘），共有3台同样的服务器（控制计算存储融合）<br>/dev/sdb  ssd<br>/dev/sdc  sata<br><img src="https://ljw.howieli.cn/blog/2017-11-30/ceph.png" alt=""><br><a id="more"></a></p>
<h3 id="配置globals-yml-文件"><a href="#配置globals-yml-文件" class="headerlink" title="配置globals.yml 文件"></a>配置globals.yml 文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ceph_enable_cache: "yes"</div><div class="line">enable_ceph: "yes"</div><div class="line">enable_cinder: "yes"</div><div class="line">cinder_backend_ceph: "&#123;&#123; enable_ceph &#125;&#125;"</div></pre></td></tr></table></figure>
<h3 id="修改cinder配置（代码修改都在部署节点）"><a href="#修改cinder配置（代码修改都在部署节点）" class="headerlink" title="修改cinder配置（代码修改都在部署节点）"></a>修改cinder配置（代码修改都在部署节点）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/config/cinder.conf</span></div><div class="line">[DEFAULT]</div><div class="line">enabled_backends = rbd-1,ssd</div><div class="line">[ssd]</div><div class="line">volume_driver = cinder.volume.drivers.rbd.RBDDriver</div><div class="line">volume_backend_name = ssd</div><div class="line">rbd_pool = volumes-cache</div><div class="line">rbd_ceph_conf = /etc/ceph/ceph.conf</div><div class="line">rbd_flatten_volume_from_snapshot = false</div><div class="line">rbd_max_clone_depth = 5</div><div class="line">rbd_store_chunk_size = 4</div><div class="line">rados_connect_timeout = 5</div><div class="line">rbd_user = cinder</div><div class="line">rbd_secret_uuid = b89a2a40-c009-47da-ba5b-7b6414a1f759</div><div class="line"><span class="meta">#</span><span class="bash"> rbd_secret_uuid = xxxxxxxxxxxxxxxxxxxxxxxxxxx</span></div><div class="line">report_discard_supported = True</div><div class="line">image_upload_use_cinder_backend = True</div></pre></td></tr></table></figure>
<h3 id="给磁盘打标签"><a href="#给磁盘打标签" class="headerlink" title="给磁盘打标签"></a>给磁盘打标签</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">parted /dev/sdb -s -- mklabel gpt mkpart KOLLA_CEPH_OSD_BOOTSTRAP 1 -1</div><div class="line"></div><div class="line">parted /dev/sdc -s -- mklabel gpt mkpart KOLLA_CEPH_OSD_CACHE_BOOTSTRAP 1 -1</div></pre></td></tr></table></figure>
<h3 id="开始部署"><a href="#开始部署" class="headerlink" title="开始部署"></a>开始部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kolla-ansible deploy  -i /root/multinode</div></pre></td></tr></table></figure>
<h3 id="crushmap"><a href="#crushmap" class="headerlink" title="crushmap"></a>crushmap</h3><h3 id="获取crushmap"><a href="#获取crushmap" class="headerlink" title="获取crushmap"></a>获取crushmap</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> docker <span class="built_in">exec</span> -it ceph_mon bash</span></div><div class="line"><span class="meta">#</span><span class="bash"> ceph osd getcrushmap -o crushmap.old</span></div></pre></td></tr></table></figure>
<h4 id="反编译：此后就可以编辑crushmap文件了"><a href="#反编译：此后就可以编辑crushmap文件了" class="headerlink" title="反编译：此后就可以编辑crushmap文件了"></a>反编译：此后就可以编辑crushmap文件了</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> crushtool <span class="_">-d</span> crushmap.old -o crushmap.new</span></div></pre></td></tr></table></figure>
<h4 id="修改crushmap"><a href="#修改crushmap" class="headerlink" title="修改crushmap"></a>修改crushmap</h4><p>根据实际情况编写crushmap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi crushmap.new</span></div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> begin crush map</span></div><div class="line">tunable choose_local_tries 0</div><div class="line">tunable choose_local_fallback_tries 0</div><div class="line">tunable choose_total_tries 50</div><div class="line">tunable chooseleaf_descend_once 1</div><div class="line">tunable chooseleaf_vary_r 1</div><div class="line">tunable straw_calc_version 1</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> devices</span></div><div class="line">device 0 osd.0</div><div class="line">device 1 osd.1</div><div class="line">device 2 osd.2</div><div class="line">device 3 osd.3</div><div class="line">device 4 osd.4</div><div class="line">device 5 osd.5</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> types</span></div><div class="line">type 0 osd</div><div class="line">type 1 host</div><div class="line">type 2 chassis</div><div class="line">type 3 rack</div><div class="line">type 4 row</div><div class="line">type 5 pdu</div><div class="line">type 6 pod</div><div class="line">type 7 room</div><div class="line">type 8 datacenter</div><div class="line">type 9 region</div><div class="line">type 10 root</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> buckets</span></div><div class="line">host 1.1.1.163 &#123;</div><div class="line">        id -2           # do not change unnecessarily</div><div class="line">        # weight 0.990</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item osd.0 weight 0.990</div><div class="line">&#125;</div><div class="line">host 1.1.1.161 &#123;</div><div class="line">        id -3           # do not change unnecessarily</div><div class="line">        # weight 0.990</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item osd.1 weight 0.990</div><div class="line">&#125;</div><div class="line">host 1.1.1.162 &#123;</div><div class="line">        id -4           # do not change unnecessarily</div><div class="line">        # weight 0.990</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item osd.2 weight 0.990</div><div class="line">&#125;</div><div class="line">root default &#123;</div><div class="line">        id -1           # do not change unnecessarily</div><div class="line">        # weight 2.970</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item 1.1.1.163 weight 0.990</div><div class="line">        item 1.1.1.161 weight 0.990</div><div class="line">        item 1.1.1.162 weight 0.990</div><div class="line">&#125;</div><div class="line">host 1.1.1.163-ssd &#123;</div><div class="line">        id -5           # do not change unnecessarily</div><div class="line">        # weight 0.470</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item osd.4 weight 0.470</div><div class="line">&#125;</div><div class="line">host 1.1.1.161-ssd &#123;</div><div class="line">        id -6           # do not change unnecessarily</div><div class="line">        # weight 0.470</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item osd.3 weight 0.470</div><div class="line">&#125;</div><div class="line">host 1.1.1.162-ssd &#123;</div><div class="line">        id -8           # do not change unnecessarily</div><div class="line">        # weight 0.470</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item osd.5 weight 0.470</div><div class="line">&#125;</div><div class="line">root ssd &#123;</div><div class="line">        id -7           # do not change unnecessarily</div><div class="line">        # weight 1.410</div><div class="line">        alg straw</div><div class="line">        hash 0  # rjenkins1</div><div class="line">        item 1.1.1.163-ssd weight 0.470</div><div class="line">        item 1.1.1.161-ssd weight 0.470</div><div class="line">        item 1.1.1.162-ssd weight 0.470</div><div class="line">&#125;</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> rules</span></div><div class="line">rule replicated_ruleset &#123;</div><div class="line">        ruleset 0</div><div class="line">        type replicated</div><div class="line">        min_size 1</div><div class="line">        max_size 10</div><div class="line">        step take default</div><div class="line">        step chooseleaf firstn 0 type host</div><div class="line">        step emit</div><div class="line">&#125;</div><div class="line">rule disks &#123;</div><div class="line">        ruleset 1</div><div class="line">        type replicated</div><div class="line">        min_size 1</div><div class="line">        max_size 10</div><div class="line">        step take default</div><div class="line">        step chooseleaf firstn 0 type host</div><div class="line">        step emit</div><div class="line">&#125;</div><div class="line">rule ssd_releset &#123;</div><div class="line">        ruleset 2</div><div class="line">        type replicated</div><div class="line">        min_size 1</div><div class="line">        max_size 10</div><div class="line">        step take ssd</div><div class="line">        step chooseleaf firstn 0 type host</div><div class="line">        step emit</div><div class="line">&#125;</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> end crush map</span></div></pre></td></tr></table></figure>
<h4 id="重新编译"><a href="#重新编译" class="headerlink" title="重新编译"></a>重新编译</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> crushtool -c crushmap.new -o crushmap.bin</span></div></pre></td></tr></table></figure>
<h4 id="导入新的crushmap"><a href="#导入新的crushmap" class="headerlink" title="导入新的crushmap"></a>导入新的crushmap</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph osd setcrushmap -i crushmap.bin</span></div></pre></td></tr></table></figure>
<h4 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># ceph osd tree</div><div class="line">ID WEIGHT  TYPE NAME              UP/DOWN REWEIGHT PRIMARY-AFFINITY </div><div class="line">-7 1.40996 root ssd                                                 </div><div class="line">-5 0.46999     host 1.1.1.163-ssd                                   </div><div class="line"> 4 0.46999         osd.4               up  1.00000          1.00000 </div><div class="line">-6 0.46999     host 1.1.1.161-ssd                                   </div><div class="line"> 3 0.46999         osd.3               up  1.00000          1.00000 </div><div class="line">-8 0.46999     host 1.1.1.162-ssd                                   </div><div class="line"> 5 0.46999         osd.5               up  1.00000          1.00000 </div><div class="line">-1 2.96997 root default                                             </div><div class="line">-2 0.98999     host 1.1.1.163                                       </div><div class="line"> 0 0.98999         osd.0               up  1.00000          1.00000 </div><div class="line">-3 0.98999     host 1.1.1.161                                       </div><div class="line"> 1 0.98999         osd.1               up  1.00000          1.00000 </div><div class="line">-4 0.98999     host 1.1.1.162                                       </div><div class="line"> 2 0.98999         osd.2               up  1.00000          1.00000</div></pre></td></tr></table></figure>
<h3 id="创建pool"><a href="#创建pool" class="headerlink" title="创建pool"></a>创建pool</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph osd pool create volumes-cache 64 64</span></div></pre></td></tr></table></figure>
<h3 id="设置pool的crushmap"><a href="#设置pool的crushmap" class="headerlink" title="设置pool的crushmap"></a>设置pool的crushmap</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph osd pool <span class="built_in">set</span> volumes-cache crush_ruleset 2</span></div><div class="line"><span class="meta">#</span><span class="bash"> ceph osd dump |grep -i pool</span></div><div class="line">pool 1 'images' replicated size 1 min_size 1 crush_ruleset 1 object_hash rjenkins pg_num 128 pgp_num 128 last_change 285 flags hashpspool stripe_width 0</div><div class="line">pool 2 'volumes' replicated size 1 min_size 1 crush_ruleset 1 object_hash rjenkins pg_num 128 pgp_num 128 last_change 281 flags hashpspool stripe_width 0</div><div class="line">pool 3 'backups' replicated size 1 min_size 1 crush_ruleset 1 object_hash rjenkins pg_num 128 pgp_num 128 last_change 165 flags hashpspool stripe_width 0</div><div class="line">pool 4 'vms' replicated size 1 min_size 1 crush_ruleset 1 object_hash rjenkins pg_num 128 pgp_num 128 last_change 44 flags hashpspool stripe_width 0</div><div class="line">pool 5 'gnocchi' replicated size 1 min_size 1 crush_ruleset 1 object_hash rjenkins pg_num 128 pgp_num 128 last_change 35 flags hashpspool stripe_width 0</div><div class="line">pool 6 'volumes-cache' replicated size 3 min_size 2 crush_ruleset 2 object_hash rjenkins pg_num 64 pgp_num 64 last_change 62 flags hashpspool stripe_width 0</div></pre></td></tr></table></figure>
<h3 id="创建两个cinder卷类型"><a href="#创建两个cinder卷类型" class="headerlink" title="创建两个cinder卷类型"></a>创建两个cinder卷类型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> /etc/kolla/admin-openrc.sh</span></div><div class="line"><span class="meta">#</span><span class="bash"> cinder <span class="built_in">type</span>-create SATA</span></div><div class="line"><span class="meta">#</span><span class="bash"> cinder <span class="built_in">type</span>-create SSD</span></div><div class="line"><span class="meta">#</span><span class="bash"> cinder <span class="built_in">type</span>-list</span></div><div class="line">+--------------------------------------+------+-------------+-----------+</div><div class="line">| ID                                   | Name | Description | Is_Public |</div><div class="line">+--------------------------------------+------+-------------+-----------+</div><div class="line">| 8c1079e5-90a3-4f6d-bdb7-2f25b70bc2c8 | SSD  |             | True      |</div><div class="line">| a605c569-1e88-486d-bd8e-7aba43ce1ef2 | SATA |             | True      |</div><div class="line">+--------------------------------------+------+-------------+-----------+</div></pre></td></tr></table></figure>
<h3 id="设置卷类型的key键值"><a href="#设置卷类型的key键值" class="headerlink" title="设置卷类型的key键值"></a>设置卷类型的key键值</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cinder type-key SSD set volume_backend_name=ssd</div><div class="line">cinder type-key SATA set volume_backend_name=rbd-1</div><div class="line"><span class="meta">#</span><span class="bash"> cinder  extra-specs-list</span></div><div class="line">+--------------------------------------+------+----------------------------------+</div><div class="line">| ID                                   | Name | extra_specs                      |</div><div class="line">+--------------------------------------+------+----------------------------------+</div><div class="line">| 8c1079e5-90a3-4f6d-bdb7-2f25b70bc2c8 | SSD  | &#123;'volume_backend_name': 'ssd'&#125;   |</div><div class="line">| a605c569-1e88-486d-bd8e-7aba43ce1ef2 | SATA | &#123;'volume_backend_name': 'rbd-1'&#125; |</div><div class="line">+--------------------------------------+------+----------------------------------+</div></pre></td></tr></table></figure>
<h3 id="创建云硬盘验证"><a href="#创建云硬盘验证" class="headerlink" title="创建云硬盘验证"></a>创建云硬盘验证</h3><p><img src="https://ljw.howieli.cn/blog/2017-11-30/%E5%88%9B%E5%BB%BA%E4%BA%91%E7%A1%AC%E7%9B%98.png" alt=""></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cinder create --volume_type SSD --display_name vol-ssd 1</span></div><div class="line">+--------------------------------+--------------------------------------+</div><div class="line">| Property                       | Value                                |</div><div class="line">+--------------------------------+--------------------------------------+</div><div class="line">| attachments                    | []                                   |</div><div class="line">| availability_zone              | nova                                 |</div><div class="line">| bootable                       | false                                |</div><div class="line">| consistencygroup_id            | None                                 |</div><div class="line">| created_at                     | 2017-11-30T02:58:17.000000           |</div><div class="line">| description                    | None                                 |</div><div class="line">| encrypted                      | False                                |</div><div class="line">| id                             | e2df2b47-13ec-4503-a78b-2ab60cb5a34b |</div><div class="line">| metadata                       | &#123;&#125;                                   |</div><div class="line">| migration_status               | None                                 |</div><div class="line">| multiattach                    | False                                |</div><div class="line">| name                           | vol-ssd                              |</div><div class="line">| os-vol-host-attr:host          | control@ssd#ssd                      |</div><div class="line">| os-vol-mig-status-attr:migstat | None                                 |</div><div class="line">| os-vol-mig-status-attr:name_id | None                                 |</div><div class="line">| os-vol-tenant-attr:tenant_id   | 21c161dda51147fb9ff527aadfe1d81a     |</div><div class="line">| replication_status             | None                                 |</div><div class="line">| size                           | 1                                    |</div><div class="line">| snapshot_id                    | None                                 |</div><div class="line">| source_volid                   | None                                 |</div><div class="line">| status                         | creating                             |</div><div class="line">| updated_at                     | 2017-11-30T02:58:18.000000           |</div><div class="line">| user_id                        | 68601348f1264a4cb69f8f8f162e3f2a     |</div><div class="line">| volume_type                    | SSD                                  |</div><div class="line">+--------------------------------+--------------------------------------+</div><div class="line"><span class="meta">#</span><span class="bash"> cinder create --volume_type SATA --display_name vol-sata 1</span></div><div class="line">+--------------------------------+--------------------------------------+</div><div class="line">| Property                       | Value                                |</div><div class="line">+--------------------------------+--------------------------------------+</div><div class="line">| attachments                    | []                                   |</div><div class="line">| availability_zone              | nova                                 |</div><div class="line">| bootable                       | false                                |</div><div class="line">| consistencygroup_id            | None                                 |</div><div class="line">| created_at                     | 2017-11-30T02:59:07.000000           |</div><div class="line">| description                    | None                                 |</div><div class="line">| encrypted                      | False                                |</div><div class="line">| id                             | f3f53733-348d-4ff9-a472-445aed77c111 |</div><div class="line">| metadata                       | &#123;&#125;                                   |</div><div class="line">| migration_status               | None                                 |</div><div class="line">| multiattach                    | False                                |</div><div class="line">| name                           | vol-sata                             |</div><div class="line">| os-vol-host-attr:host          | None                                 |</div><div class="line">| os-vol-mig-status-attr:migstat | None                                 |</div><div class="line">| os-vol-mig-status-attr:name_id | None                                 |</div><div class="line">| os-vol-tenant-attr:tenant_id   | 21c161dda51147fb9ff527aadfe1d81a     |</div><div class="line">| replication_status             | None                                 |</div><div class="line">| size                           | 1                                    |</div><div class="line">| snapshot_id                    | None                                 |</div><div class="line">| source_volid                   | None                                 |</div><div class="line">| status                         | creating                             |</div><div class="line">| updated_at                     | None                                 |</div><div class="line">| user_id                        | 68601348f1264a4cb69f8f8f162e3f2a     |</div><div class="line">| volume_type                    | SATA                                 |</div><div class="line">+--------------------------------+--------------------------------------+</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> rbd -p volumes-cache ls|grep e2df2b47-13ec-4503<span class="_">-a</span>78b-2ab60cb5a34b</span></div><div class="line">volume-e2df2b47-13ec-4503-a78b-2ab60cb5a34b</div><div class="line"><span class="meta">#</span><span class="bash"> rbd -p volumes ls|grep f3f53733-348d-4ff9<span class="_">-a</span>472-445aed77c111</span></div><div class="line">volume-f3f53733-348d-4ff9-a472-445aed77c111</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ceph cinder </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[kolla部署swift]]></title>
      <url>/posts/kolla%E9%83%A8%E7%BD%B2swift.html</url>
      <content type="html"><![CDATA[<h3 id="kolla部署swift"><a href="#kolla部署swift" class="headerlink" title="kolla部署swift"></a>kolla部署swift</h3><p>kolla实现对象存储方式有两种：</p>
<ul>
<li>利用ceph_rgw实现</li>
<li>部署swift实现</li>
</ul>
<p>本篇博客介绍利用kolla部署swift实现openstack对象存储<br><a id="more"></a></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>我这是一个all-in-one的环境,利用kolla部署了一个pike版本,部署方法请参考<a href="https://www.lijiawang.org/posts/kolla-pike-on-centos.html#more">kolla部署openstack Pike版</a><br>我这台虚拟机一共有5块盘，分别为sda,sdb,sdc,sdd,sde。sda为系统盘，sdb,sdc,sdd,为ceph的osd用，sde用于做swift</p>
<h3 id="打标签"><a href="#打标签" class="headerlink" title="打标签"></a>打标签</h3><p>swift要求可用的块设备用来存储，所以我事先准备了一个硬盘<code>sde</code>作为存储设备,在部署需要给这块盘打一个特殊的标签。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">index=0</div><div class="line">for d in sde; do</div><div class="line"><span class="meta">#</span><span class="bash"> 因为我这就有一块用于swift存储的盘sde。</span></div><div class="line">    parted /dev/$&#123;d&#125; -s -- mklabel gpt mkpart KOLLA_SWIFT_DATA 1 -1</div><div class="line">    sudo mkfs.xfs -f -L d$&#123;index&#125; /dev/$&#123;d&#125;1</div><div class="line">    (( index++ ))</div><div class="line">done</div></pre></td></tr></table></figure></p>
<h3 id="Rings"><a href="#Rings" class="headerlink" title="Rings"></a>Rings</h3><p>kolla在部署swift前，需要生成rings，这是一种二进制压缩文件，在较高的级别上，让各种快速服务知道集群中的数据在哪里，这里官方给了一个脚本，简单的配置一下即可。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> STORAGE_NODES=(192.168.0.2 192.168.0.3 192.168.0.4)</span></div><div class="line"><span class="meta">#</span><span class="bash"> 这里是swift走的存储网络的ip，因为我是all-in-one环境，所以IP只有一个，这里我的swift存储用网将和管理网在一起</span></div><div class="line">STORAGE_NODES=(192.168.10.139)</div><div class="line"><span class="meta">#</span><span class="bash"> KOLLA_SWIFT_BASE_IMAGE=<span class="string">"docker_registry/docker_namespace/centos-source-swift-base:openstack_release"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> 这里按照需求填写</span></div><div class="line">KOLLA_SWIFT_BASE_IMAGE="192.168.10.139:4000/lokolla/centos-source-swift-base:5.0.1"</div><div class="line"></div><div class="line">mkdir -p /etc/kolla/config/swift</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> Object ring</span></div><div class="line">docker run \</div><div class="line">  --rm \</div><div class="line">  -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \</div><div class="line"><span class="meta">  $</span><span class="bash">KOLLA_SWIFT_BASE_IMAGE \</span></div><div class="line">  swift-ring-builder \</div><div class="line">    /etc/kolla/config/swift/object.builder create 10 3 1</div><div class="line"></div><div class="line">for node in $&#123;STORAGE_NODES[@]&#125;; do</div><div class="line">    for i in &#123;0..2&#125;; do</div><div class="line">      docker run \</div><div class="line">        --rm \</div><div class="line">        -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \</div><div class="line">        $KOLLA_SWIFT_BASE_IMAGE \</div><div class="line">        swift-ring-builder \</div><div class="line">          /etc/kolla/config/swift/object.builder add r1z1-$&#123;node&#125;:6000/d$&#123;i&#125; 1;</div><div class="line">    done</div><div class="line">done</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> Account ring</span></div><div class="line">docker run \</div><div class="line">  --rm \</div><div class="line">  -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \</div><div class="line"><span class="meta">  $</span><span class="bash">KOLLA_SWIFT_BASE_IMAGE \</span></div><div class="line">  swift-ring-builder \</div><div class="line">    /etc/kolla/config/swift/account.builder create 10 3 1</div><div class="line"></div><div class="line">for node in $&#123;STORAGE_NODES[@]&#125;; do</div><div class="line">    for i in &#123;0..2&#125;; do</div><div class="line">      docker run \</div><div class="line">        --rm \</div><div class="line">        -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \</div><div class="line">        $KOLLA_SWIFT_BASE_IMAGE \</div><div class="line">        swift-ring-builder \</div><div class="line">          /etc/kolla/config/swift/account.builder add r1z1-$&#123;node&#125;:6001/d$&#123;i&#125; 1;</div><div class="line">    done</div><div class="line">done</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> Container ring</span></div><div class="line">docker run \</div><div class="line">  --rm \</div><div class="line">  -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \</div><div class="line"><span class="meta">  $</span><span class="bash">KOLLA_SWIFT_BASE_IMAGE \</span></div><div class="line">  swift-ring-builder \</div><div class="line">    /etc/kolla/config/swift/container.builder create 10 3 1</div><div class="line"></div><div class="line">for node in $&#123;STORAGE_NODES[@]&#125;; do</div><div class="line">    for i in &#123;0..2&#125;; do</div><div class="line">      docker run \</div><div class="line">        --rm \</div><div class="line">        -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \</div><div class="line">        $KOLLA_SWIFT_BASE_IMAGE \</div><div class="line">        swift-ring-builder \</div><div class="line">          /etc/kolla/config/swift/container.builder add r1z1-$&#123;node&#125;:6002/d$&#123;i&#125; 1;</div><div class="line">    done</div><div class="line">done</div><div class="line"></div><div class="line">for ring in object account container; do</div><div class="line">  docker run \</div><div class="line">    --rm \</div><div class="line">    -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \</div><div class="line">    $KOLLA_SWIFT_BASE_IMAGE \</div><div class="line">    swift-ring-builder \</div><div class="line">      /etc/kolla/config/swift/$&#123;ring&#125;.builder rebalance;</div><div class="line">done</div></pre></td></tr></table></figure></p>
<h3 id="globals-yml文件"><a href="#globals-yml文件" class="headerlink" title="globals.yml文件"></a>globals.yml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/globals.yml</span></div><div class="line"><span class="meta">#</span><span class="bash">enable_ceph_rgw: <span class="string">"no"</span></span></div><div class="line">enable_swift: "yes"</div><div class="line"><span class="meta">#</span><span class="bash">enable_ceph_rgw_keystone: <span class="string">"no"</span></span></div></pre></td></tr></table></figure>
<p>这里需要说下，ceph_rgw实现的对象存储和swift实现的对象存储二者不能共存。如果要想用ceph_rgw实现以上步骤均不要做直接修改globals文件后deploy即可<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/globals.yml</span></div><div class="line">enable_ceph_rgw: "yes"</div><div class="line"><span class="meta">#</span><span class="bash"> enable_swift: <span class="string">"no"</span></span></div><div class="line">enable_ceph_rgw_keystone: "yes"</div></pre></td></tr></table></figure></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible deploy</span></div></pre></td></tr></table></figure>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> /etc/kolla/admin-openrc.sh </span></div><div class="line"><span class="meta">#</span><span class="bash"> openstack container create mycontainer</span></div><div class="line">+---------------------------------------+-------------+------------------------------------+</div><div class="line">| account                               | container   | x-trans-id                         |</div><div class="line">+---------------------------------------+-------------+------------------------------------+</div><div class="line">| AUTH_2a568be969b34c288ef52a2987973145 | mycontainer | txc68d723c0c934a7282cfe-005a1e5d11 |</div><div class="line">+---------------------------------------+-------------+------------------------------------+</div><div class="line">[root@pike ~]# openstack object create mycontainer README.rst</div><div class="line">+------------+-------------+----------------------------------+</div><div class="line">| object     | container   | etag                             |</div><div class="line">+------------+-------------+----------------------------------+</div><div class="line">| README.rst | mycontainer | a2f288979d0af55c5e9313f525c75615 |</div><div class="line">+------------+-------------+----------------------------------+</div><div class="line"><span class="meta">#</span><span class="bash"> openstack container show mycontainer</span></div><div class="line">+--------------+---------------------------------------+</div><div class="line">| Field        | Value                                 |</div><div class="line">+--------------+---------------------------------------+</div><div class="line">| account      | AUTH_2a568be969b34c288ef52a2987973145 |</div><div class="line">| bytes_used   | 39                                    |</div><div class="line">| container    | mycontainer                           |</div><div class="line">| object_count | 1                                     |</div><div class="line">+--------------+---------------------------------------+</div><div class="line"><span class="meta">#</span><span class="bash"> openstack object store account show</span></div><div class="line">+------------+---------------------------------------+</div><div class="line">| Field      | Value                                 |</div><div class="line">+------------+---------------------------------------+</div><div class="line">| Account    | AUTH_2a568be969b34c288ef52a2987973145 |</div><div class="line">| Bytes      | 0                                     |</div><div class="line">| Containers | 1                                     |</div><div class="line">| Objects    | 0                                     |</div><div class="line">+------------+---------------------------------------+</div></pre></td></tr></table></figure>
<p><img src="https://ljw.howieli.cn/blog/2017-11-29/swift.png" alt=""></p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://docs.openstack.org/kolla-ansible/latest/reference/swift-guide.html#rings" target="_blank" rel="external">https://docs.openstack.org/kolla-ansible/latest/reference/swift-guide.html#rings</a></p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> swift </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[openstack虚拟机VIP配置步骤]]></title>
      <url>/posts/%E5%9C%A8openstack%E4%B8%8A%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BB%91%E5%AE%9Avip.html</url>
      <content type="html"><![CDATA[<h3 id="在openstack上的虚拟机绑定vip"><a href="#在openstack上的虚拟机绑定vip" class="headerlink" title="在openstack上的虚拟机绑定vip"></a>在openstack上的虚拟机绑定vip</h3><p>有些情况下，客户想在openstack的虚拟机上配置vip搭建高可用集群，下面我就简单的说下在openstack上的虚拟机如何绑定vip<br><a id="more"></a></p>
<h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><p>1、导入环境变量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> admin-openrc.sh</span></div></pre></td></tr></table></figure></p>
<p>2、执行命令neutron net-list查看网络，找到自己需要设置的网络，获取subnet_id和network_id<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron net-list</span></div><div class="line">+--------------------------------------+----------------------------------------------------+----------------------------------+-------------------------------------------------------+</div><div class="line">| id                                   | name                                               | tenant_id                        | subnets                                               |</div><div class="line">+--------------------------------------+----------------------------------------------------+----------------------------------+-------------------------------------------------------+</div><div class="line">| 32482d56-bb40-4b7f-85df-3be3a460e441 | HA network tenant 7ba30c1e519d4d6eb8f1ace2cfbf30d3 |                                  | 860bf95f-4775-4fac-af88-db392f254416 169.254.192.0/18 |</div><div class="line">| 7cc26554-2795-4a53-b053-34ec1b4c90f2 | web                                                | 7ba30c1e519d4d6eb8f1ace2cfbf30d3 | 4b1f707b-8842-4ce0-acba-4f0de304459b 192.168.1.0/24   |</div><div class="line">| d0ad534f-1bcd-43b0-aa0c-edee32520020 | public                                             | 21c161dda51147fb9ff527aadfe1d81a | 9a7f07e5-e906-4622-8bc6-def64b3622ec 172.18.23.0/24   |</div><div class="line">+--------------------------------------+----------------------------------------------------+----------------------------------+-------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p><img src="https://ljw.howieli.cn/blog/2017-11-28/net-list.png" alt=""><br>3、创建port来占用ip，保证neutron不会将此IP在分配出去，导致IP冲突问题。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">neutron port-create --fixed-ip subnet_id=&lt;subnet_id&gt;,ip_address=&lt;vip&gt; &lt;network_id&gt;</div><div class="line">注：</div><div class="line">	替换subnet_id为neutron net-list中查看到的subnet_id</div><div class="line">	替换vip为需要配置的vip地址</div><div class="line">	替换network_ID为neutron net-list中查看到的network_id</div></pre></td></tr></table></figure></p>
<p>具体命令如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron port-create --fixed-ip subnet_id=9a7f07e5<span class="_">-e</span>906-4622-8bc6-def64b3622ec,ip_address=172.18.23.10 d0ad534f-1bcd-43b0-aa0c-edee32520020</span></div><div class="line">Created a new port:</div><div class="line">+-----------------------+-------------------------------------------------------------------------------------+</div><div class="line">| Field                 | Value                                                                               |</div><div class="line">+-----------------------+-------------------------------------------------------------------------------------+</div><div class="line">| admin_state_up        | True                                                                                |</div><div class="line">| allowed_address_pairs |                                                                                     |</div><div class="line">| binding:host_id       |                                                                                     |</div><div class="line">| binding:profile       | &#123;&#125;                                                                                  |</div><div class="line">| binding:vif_details   | &#123;&#125;                                                                                  |</div><div class="line">| binding:vif_type      | unbound                                                                             |</div><div class="line">| binding:vnic_type     | normal                                                                              |</div><div class="line">| created_at            | 2017-11-28T02:35:17Z                                                                |</div><div class="line">| description           |                                                                                     |</div><div class="line">| device_id             |                                                                                     |</div><div class="line">| device_owner          |                                                                                     |</div><div class="line">| extra_dhcp_opts       |                                                                                     |</div><div class="line">| fixed_ips             | &#123;"subnet_id": "9a7f07e5-e906-4622-8bc6-def64b3622ec", "ip_address": "172.18.23.10"&#125; |</div><div class="line">| id                    | 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63                                                |</div><div class="line">| mac_address           | fa:16:3e:ea:81:a6                                                                   |</div><div class="line">| name                  |                                                                                     |</div><div class="line">| network_id            | d0ad534f-1bcd-43b0-aa0c-edee32520020                                                |</div><div class="line">| port_security_enabled | True                                                                                |</div><div class="line">| project_id            | 21c161dda51147fb9ff527aadfe1d81a                                                    |</div><div class="line">| revision_number       | 5                                                                                   |</div><div class="line">| security_groups       | abfba384-55f2-4eed-902a-712369be9604                                                |</div><div class="line">| status                | DOWN                                                                                |</div><div class="line">| tags                  |                                                                                     |</div><div class="line">| tenant_id             | 21c161dda51147fb9ff527aadfe1d81a                                                    |</div><div class="line">| updated_at            | 2017-11-28T02:35:18Z                                                                |</div><div class="line">+-----------------------+-------------------------------------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p><img src="https://ljw.howieli.cn/blog/2017-11-28/port-create.png" alt=""><br>4、执行命令<code>neutron port-list</code>查看端口，找到VIP的Port ID以及需要使用VIP的虚拟机的IP对应的Port id<br>比如两台虚拟机做HA绑定vip，那么需要查看两台虚拟机的port ID和这个vip的port ID<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron port-list|grep 172.18.23.10</span></div><div class="line">| 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63 |                                                 | 21c161dda51147fb9ff527aadfe1d81a | fa:16:3e:ea:81:a6 | &#123;"subnet_id": "9a7f07e5-e906-4622-8bc6-def64b3622ec", "ip_address": "172.18.23.10"&#125;  |</div></pre></td></tr></table></figure></p>
<p>可以看出vip<code>172.18.23.10</code>的port id为<code>7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</code>.<br>5、取消安全组对应端口的管理<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">neutron port-update --no-security-groups &lt;Port_id&gt;</div><div class="line">neutron port-update --port_security_enabled=false &lt;Port_id&gt;</div><div class="line">注：</div><div class="line">	    替换Port_id为之前neutron port-list中找到的Port_id</div></pre></td></tr></table></figure></p>
<p>具有命令如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> neutron port-update --no-security-groups 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</span></div><div class="line">Updated port: 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</div><div class="line"><span class="meta">#</span><span class="bash"> neutron port-update --port_security_enabled=<span class="literal">false</span> 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</span></div><div class="line">Updated port: 7c7ccc26-9ac9-4ef7-8178-2b97218b1d63</div></pre></td></tr></table></figure></p>
<p>6、此时执行命令neutron port-show <port_id><br><img src="https://ljw.howieli.cn/blog/2017-11-28/port-show.png" alt=""><br>可看到port_security_enabled的value为False，security_groups的value为空，即OK，这样两个端口就没有了安全组了。<br>7、意思就是对VIP和需要使用VIP的虚拟机都执行4、5、6步，比如配置HA，VIP+两台虚拟机，总共3个Port，都需要执行4、5、6步<br>然后就可以在这两台虚拟机上搭建keepalived集群使用<code>172.18.23.10</code>这个vip了。</port_id></p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[kolla Pike on CentOS 7.4]]></title>
      <url>/posts/kolla-pike-on-centos.html</url>
      <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>我这里用workstation 创建了一个虚拟机，安装centos7.4系统，这台虚拟机上有两张网卡，一张做openstack管理网，一张做为虚拟机的业务网卡。<br><a id="more"></a></p>
<h3 id="确认环境信息"><a href="#确认环境信息" class="headerlink" title="确认环境信息"></a>确认环境信息</h3><p>1.确认系统版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cat /etc/redhat-release</span></div><div class="line">CentOS Linux release 7.4.1708 (Core)</div></pre></td></tr></table></figure></p>
<p>2.确认网卡个数和状态<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ip a</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 ::1/128 scope host</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:a7:8c:91 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.10.139/24 brd 192.168.10.255 scope global dynamic ens33</div><div class="line">       valid_lft 1555sec preferred_lft 1555sec</div><div class="line">    inet6 fe80::5057:38c5:6b65:b5/64 scope link</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">3: ens34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:a7:8c:9b brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet6 fe80::20c:29ff:fea7:8c9b/64 scope link</div><div class="line">       valid_lft forever preferred_lft forever</div></pre></td></tr></table></figure></p>
<p>上面可以看出有两张网卡<code>ens33</code>和<code>ens34</code>，这里我用<code>ens33</code>做管理网，<code>ens34</code>做业务网，这里不需要配置ip，把<code>ens34</code>网卡up起来就好。</p>
<h3 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h3><p>1.更改主机名<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> hostnamectl <span class="built_in">set</span>-hostname pike</span></div><div class="line"><span class="meta">#</span><span class="bash"> hostname pike</span></div><div class="line"><span class="meta">#</span><span class="bash"> hostname</span></div><div class="line">pike</div></pre></td></tr></table></figure></p>
<p>2.关闭NetworkManager,firewalld,selinux<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> systemctl stop NetworkManager</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">disable</span> NetworkManager</span></div><div class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/NetworkManager.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.freedesktop.NetworkManager.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.freedesktop.nm-dispatcher.service.</div><div class="line"><span class="meta">#</span><span class="bash"> systemctl stop firewalld</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">disable</span> firewalld</span></div><div class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</div><div class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/"</span> /etc/selinux/config</span></div><div class="line"><span class="meta">#</span><span class="bash"> setenforce 0</span></div><div class="line"><span class="meta">#</span><span class="bash"> getenforce</span></div><div class="line">Permissive</div></pre></td></tr></table></figure></p>
<p>3.查看是否开启了虚拟化<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> egrep <span class="string">"vmx|svm"</span> /proc/cpuinfo</span></div></pre></td></tr></table></figure></p>
<h3 id="安装基础包"><a href="#安装基础包" class="headerlink" title="安装基础包"></a>安装基础包</h3><p>1.配置epel源安装基础包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># yum install epel-release</div><div class="line"># yum install axel vim git curl wget lrzsz gcc  python-devel yum* python-pip</div></pre></td></tr></table></figure></p>
<p>2.配置docker-ce的yum源安装docker-ce,这里我用的docker版本为docker-ce17.09<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></div><div class="line"><span class="meta">#</span><span class="bash"> yum install -y docker-ce</span></div><div class="line"><span class="meta">#</span><span class="bash"> docker -v</span></div><div class="line">Docker version 17.09.0-ce, build afdb6d4</div></pre></td></tr></table></figure></p>
<p>3.配置docker<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/systemd/system/docker.service.d</span></div><div class="line"><span class="meta">#</span><span class="bash"> tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt; <span class="string">'EOF'</span></span></div><div class="line">[Service]</div><div class="line">MountFlags=shared</div><div class="line">EOF</div><div class="line"><span class="meta">#</span><span class="bash"> vim /usr/lib/systemd/system/docker.service</span></div><div class="line"><span class="meta">#</span><span class="bash"> ExecStart=/usr/bin/dockerd</span></div><div class="line">ExecStart=/usr/bin/dockerd --insecure-registry 192.168.10.139:4000</div></pre></td></tr></table></figure></p>
<p>4.启动docker<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> systemctl daemon-reload</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl restart docker</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> docker</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</div><div class="line"><span class="meta">#</span><span class="bash"> systemctl status docker</span></div><div class="line"><span class="meta">#</span><span class="bash"> docker info</span></div></pre></td></tr></table></figure></p>
<h3 id="安装ansible"><a href="#安装ansible" class="headerlink" title="安装ansible"></a>安装ansible</h3><p>ansible版本必须在2.0以上<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum -y install ansible -y</span></div></pre></td></tr></table></figure></p>
<h3 id="搭建Registry"><a href="#搭建Registry" class="headerlink" title="搭建Registry"></a>搭建Registry</h3><p>默认docker的registry是使用5000端口，对于OpenStack来说，有端口冲突，所以我将端口改成了4000。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> docker run <span class="_">-d</span> -v /opt/registry:/var/lib/registry -p 4000:5000 \</span></div><div class="line">--restart=always --name registry registry:2</div><div class="line"><span class="meta">#</span><span class="bash"> docker ps</span></div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</div><div class="line">005883e5a115        registry:2          "/entrypoint.sh /e..."   24 seconds ago      Up 22 seconds       0.0.0.0:4000-&gt;5000/tcp   registry</div></pre></td></tr></table></figure></p>
<h3 id="下载kolla官方提供的Pile镜像"><a href="#下载kolla官方提供的Pile镜像" class="headerlink" title="下载kolla官方提供的Pile镜像"></a>下载kolla官方提供的Pile镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> wget http://tarballs.openstack.org/kolla/images/centos-source-registry-pike.tar.gz</span></div><div class="line"><span class="meta">#</span><span class="bash"> du -sh centos-source-registry-pike.tar.gz</span></div><div class="line">4.2G	centos-source-registry-pike.tar.gz</div><div class="line"><span class="meta">#</span><span class="bash"> tar zxf centos-source-registry-pike.tar.gz -C /opt/registry/</span></div><div class="line"><span class="meta">#</span><span class="bash"> curl http://192.168.10.139:4000/v2/_catalog</span></div></pre></td></tr></table></figure>
<h3 id="下载kolla-ansible，并配置"><a href="#下载kolla-ansible，并配置" class="headerlink" title="下载kolla-ansible，并配置"></a>下载kolla-ansible，并配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/openstack/kolla-ansible -b stable/pike</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> kolla-ansible/</span></div><div class="line"><span class="meta">#</span><span class="bash"> cp -r etc/kolla/ /etc/kolla/</span></div><div class="line"><span class="meta">#</span><span class="bash"> pip install . -i https://pypi.tuna.tsinghua.edu.cn/simple</span></div></pre></td></tr></table></figure>
<h3 id="安装kolla"><a href="#安装kolla" class="headerlink" title="安装kolla"></a>安装kolla</h3><p>1.因为我是在虚拟机安装的kolla，希望可以启动虚拟机，那么需要把virt_type=qemu,默认是kvm<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir -p /etc/kolla/config/nova</span></div><div class="line"><span class="meta">#</span><span class="bash"> cat &lt;&lt; EOF &gt; /etc/kolla/config/nova/nova-compute.conf</span></div><div class="line"><span class="meta">&gt;</span><span class="bash"> [libvirt]</span></div><div class="line"><span class="meta">&gt;</span><span class="bash"> virt_type=qemu</span></div><div class="line"><span class="meta">&gt;</span><span class="bash"> cpu_mode = none</span></div><div class="line"><span class="meta">&gt;</span><span class="bash"> EOF</span></div></pre></td></tr></table></figure></p>
<p>2.ceph打标签,下面两个命令分别用来快速删除 osd disk 的分区和快速给 disk 打 ceph 标签<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> lsblk</span></div><div class="line"><span class="meta">#</span><span class="bash"> lsblk | grep <span class="string">"^sd[^a]"</span> | awk <span class="string">'&#123;print $1&#125;'</span> | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> \</span></div><div class="line">parted /dev/$line -s -- mklabel gpt mkpart KOLLA_CEPH_OSD_BOOTSTRAP 1 -1; \</div><div class="line">done</div><div class="line"><span class="meta">#</span><span class="bash"> lsblk</span></div></pre></td></tr></table></figure></p>
<p>3.配置GLOBALS.YML文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cat /etc/kolla/globals.yml |grep -Ev <span class="string">'^$|^#'</span></span></div><div class="line">---</div><div class="line">kolla_base_distro: "centos"</div><div class="line">kolla_install_type: "source"</div><div class="line">openstack_release: "5.0.1"</div><div class="line">kolla_internal_vip_address: "192.168.10.139"</div><div class="line">docker_registry: "192.168.10.139:4000"</div><div class="line">docker_namespace: "lokolla"</div><div class="line">network_interface: "ens33"</div><div class="line">neutron_external_interface: "ens34"</div><div class="line">keepalived_virtual_router_id: "52"</div><div class="line">enable_ceph: "yes"</div><div class="line">enable_chrony: "yes"</div><div class="line">enable_cinder: "yes"</div><div class="line">enable_haproxy: "no"</div><div class="line">enable_horizon: "yes"</div><div class="line">tempest_image_id:</div><div class="line">tempest_flavor_ref_id:</div><div class="line">tempest_public_network_id:</div><div class="line">tempest_floating_network_name:</div></pre></td></tr></table></figure></p>
<p>4.创建 /etc/kolla/config/ceph.conf<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[global]</div><div class="line">osd pool default size = 1</div><div class="line">osd pool default min size = 1</div></pre></td></tr></table></figure></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>1.生成密码,编辑/etc/kolla/passwords.yml<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-genpwd</span></div><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/passwords.yml</span></div><div class="line">keystone_admin_password: lijiawang</div></pre></td></tr></table></figure></p>
<p>这是登录Dashboard，admin使用的密码，你可以根据自己需要进行修改<br>2.部署检查<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible prechecks</span></div></pre></td></tr></table></figure></p>
<p>3.部署<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible deploy</span></div><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible post-deploy</span></div></pre></td></tr></table></figure></p>
<h3 id="安装openstack-client-端"><a href="#安装openstack-client-端" class="headerlink" title="安装openstack client 端"></a>安装openstack client 端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> pip install python-openstackclient</span></div></pre></td></tr></table></figure>
<h3 id="创建网络"><a href="#创建网络" class="headerlink" title="创建网络"></a>创建网络</h3><p>1.编辑 /usr/share/kolla-ansible/init-runonce<br>网络需要根据实际情况修改,我都是用的nat模式<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">EXT_NET_CIDR='192.168.10.0/24'</div><div class="line">EXT_NET_RANGE='start=192.168.10.150,end=192.168.10.199'</div><div class="line">EXT_NET_GATEWAY='192.168.10.2'</div></pre></td></tr></table></figure></p>
<p>2.运行脚本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> /etc/kolla/admin-openrc.sh</span></div><div class="line"><span class="meta">#</span><span class="bash"> bash /usr/share/kolla-ansible/init-runonce</span></div></pre></td></tr></table></figure></p>
<p>3.创建实例绑定浮动ip，测试网络<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@pike ~]# nova list</div><div class="line">+--------------------------------------+-------+--------+------------+-------------+------------------------------------+</div><div class="line">| ID                                   | Name  | Status | Task State | Power State | Networks                           |</div><div class="line">+--------------------------------------+-------+--------+------------+-------------+------------------------------------+</div><div class="line">| cbc40238-3bee-4df1-abc0-a10fc269e6e0 | demo1 | ACTIVE | -          | Running     | demo-net=10.0.0.10, 192.168.10.154 |</div><div class="line">+--------------------------------------+-------+--------+------------+-------------+------------------------------------+</div><div class="line">[root@pike ~]# ping 192.168.10.154</div><div class="line">PING 192.168.10.154 (192.168.10.154) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.10.154: icmp_seq=1 ttl=63 time=3.91 ms</div><div class="line">64 bytes from 192.168.10.154: icmp_seq=2 ttl=63 time=4.56 ms</div><div class="line">64 bytes from 192.168.10.154: icmp_seq=3 ttl=63 time=2.04 ms</div></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[opensyack glance学习]]></title>
      <url>/posts/openstack-glance.html</url>
      <content type="html"><![CDATA[<h3 id="openstack-Glance介绍"><a href="#openstack-Glance介绍" class="headerlink" title="openstack Glance介绍"></a>openstack Glance介绍</h3><p>Glance项目提供虚拟机镜像的发现，注册，取得服务。<br>Glance提供restful API可以查询虚拟机镜像的metadata，并且可以获得镜像。<br>通过Glance，虚拟机镜像可以被存储到多种存储上，比如简单的文件存储或者对象存储（比如OpenStack中swiftx项目）。<br>Glance，像所有的OpenStack项目一样，遵循以下思想：<br>1.基于组件的架构      便于快速增加新特性<br>2.高可用性                  支持大负荷<br>3.容错性                      独立的进程避免串行错误<br>4.开放标准                  对社区驱动的API提供参考实现<br><a id="more"></a></p>
<h3 id="Glance架构"><a href="#Glance架构" class="headerlink" title="Glance架构"></a>Glance架构</h3><p><img src="https://ljw.howieli.cn/blog/2017-10-26/glance架构图.png" alt=""><br>以上是glance架构图<br><a href="https://docs.openstack.org/glance/latest/" target="_blank" rel="external">glance官网</a></p>
<h3 id="glance服务"><a href="#glance服务" class="headerlink" title="glance服务"></a>glance服务</h3><p>我这是一个kolla环境<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# docker ps |grep glance</div><div class="line">1b240466af76        172.18.22.161:4000/99cloud/centos-source-glance-registry:animbus-5.3.0             "kolla_start"            2 weeks ago         Up 17 hours                                  glance_registry</div><div class="line">3f25b6ace631        172.18.22.161:4000/99cloud/centos-source-glance-api:animbus-5.3.0                  "kolla_start"            2 weeks ago         Up 17 hours                                  glance_api</div></pre></td></tr></table></figure></p>
<h3 id="glancce-api"><a href="#glancce-api" class="headerlink" title="glancce-api"></a>glancce-api</h3><p>glance-api 是系统后台运行的服务进程。 对外提供 REST API，响应 image 查询、获取和存储的调用。</p>
<p>glance-api 不会真正处理请求。 如果操作是与 image metadata（元数据）相关，glance-api 会把请求转发给 glance-registry； 如果操作是与 image 自身存取相关，glance-api 会把请求转发给该 image 的 store backend。<br>在控制节点可以查看glance-api的进程<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# ps -e |grep glance-api</div><div class="line"> 4381 ?        00:09:56 glance-api</div><div class="line"> 9026 ?        00:00:14 glance-api</div><div class="line"> 9035 ?        00:00:11 glance-api</div><div class="line"> 9046 ?        00:00:14 glance-api</div><div class="line"> 9059 ?        00:00:16 glance-api</div><div class="line"> 9067 ?        00:00:13 glance-api</div></pre></td></tr></table></figure></p>
<h3 id="glance-registry"><a href="#glance-registry" class="headerlink" title="glance-registry"></a>glance-registry</h3><p>glance-registry 是系统后台运行的服务进程。 负责处理和存取 image 的 metadata，例如 image 的大小和类型。在控制节点上可以查看 glance-registry 进程.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# ps -e |grep glance-registry</div><div class="line"> 2645 ?        00:00:03 glance-registry</div><div class="line"> 5351 ?        00:00:00 glance-registry</div><div class="line"> 5352 ?        00:00:00 glance-registry</div><div class="line"> 5353 ?        00:00:00 glance-registry</div><div class="line"> 5354 ?        00:00:00 glance-registry</div><div class="line"> 5355 ?        00:00:00 glance-registry</div></pre></td></tr></table></figure></p>
<h3 id="Store-backend"><a href="#Store-backend" class="headerlink" title="Store backend"></a>Store backend</h3><p>Glance 自己并不存储 image。 真正的 image 是存放在 backend 中的。 Glance 支持多种 backend，包括：</p>
<ul>
<li>A directory on a local file system（这是默认配置）</li>
<li>GridFS</li>
<li>Ceph RBD</li>
<li>Amazon S3</li>
<li>Sheepdog</li>
<li>OpenStack Block Storage (Cinder)</li>
<li>OpenStack Object Storage (Swift)</li>
<li>VMware ESX</li>
</ul>
<h3 id="image数据存放"><a href="#image数据存放" class="headerlink" title="image数据存放"></a>image数据存放</h3><p>image的元数据通过glance-registry存放到db中；image的chunk数据通过glance-store存放在各种 backend store 中，并从中获取。</p>
<h3 id="image的访问权限"><a href="#image的访问权限" class="headerlink" title="image的访问权限"></a>image的访问权限</h3><p>image 的 访问权限分为：</p>
<ul>
<li>public 公共的：可以被所有的 tenant 使用。</li>
<li>private 私有的/项目的：只能被 image owner 所在的 tenant 使用。</li>
<li>shared 共享的：一个非共有的image 可以 共享给另外的 tenant，可通过member-* 操作来实现。</li>
<li>protected 受保护的：protected 的 image 不能被删除。</li>
</ul>
<h3 id="image各种状态"><a href="#image各种状态" class="headerlink" title="image各种状态"></a>image各种状态</h3><ul>
<li>queued：没有上传 image 数据，只有db 中的元数据。</li>
<li>saving：正在上传 image data</li>
<li>active：正常状态</li>
<li>deleted/pending_delete： 已删除/等待删除</li>
<li>killed：image 元数据不正确，等待被删除。</li>
</ul>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[openstack性能测试]]></title>
      <url>/posts/Openstack%20performance%20testing.html</url>
      <content type="html"><![CDATA[<h3 id="文档说明"><a href="#文档说明" class="headerlink" title="文档说明"></a>文档说明</h3><p>本文档验证在openstack ocata环境上开展自动化测试，性能测试，压力测试。<br><a id="more"></a></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>openstack ocata for kolla环境一台（多节点，三个控制也做计算存储）</p>
<h3 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h3><h4 id="Tempest-介绍"><a href="#Tempest-介绍" class="headerlink" title="Tempest 介绍"></a>Tempest 介绍</h4><p>目前Tempest 的测试代码，包括计算、认证、镜像管理、网络、对象存储、块存储 六个核心模块。</p>
<p><img src="https://ljw.howieli.cn/blog/2017-9-8/tempest.png" alt=""></p>
<h4 id="Tempest-安装"><a href="#Tempest-安装" class="headerlink" title="Tempest 安装"></a>Tempest 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]<span class="comment"># vim /etc/kolla/globals.yml</span></div><div class="line">enable_tempest: <span class="string">"yes"</span></div><div class="line">[root@control01 ~]<span class="comment"># kolla-ansible -i multinode deploy</span></div><div class="line">[root@control01 ~]<span class="comment"># docker ps |grep tempest</span></div><div class="line">06512704e13e        172.18.22.162:4000/99cloud/centos-source-tempest:animbus-5.2.0                     <span class="string">"kolla_start"</span>            8 days ago          Up 8 days                                    tempest</div></pre></td></tr></table></figure>
<h4 id="Tempest-配置"><a href="#Tempest-配置" class="headerlink" title="Tempest 配置"></a>Tempest 配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]<span class="comment"># docker exec -it -u root tempest bash</span></div><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment">#</span></div><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment"># vi /etc/tempest/tempest.conf</span></div><div class="line">image_ref = a1958f75-ae81-4b1d<span class="_">-a</span>167-213f4681856b</div><div class="line">image_ref_alt = a1958f75-ae81-4b1d<span class="_">-a</span>167-213f4681856b</div><div class="line">flavor_ref = 2</div><div class="line">flavor_ref_alt = 2</div><div class="line">public_network_id = f157770d<span class="_">-e</span>81c-41a3-acf1-8<span class="built_in">fc</span>3f4ea7f31</div><div class="line">floating_network_name = f157770d<span class="_">-e</span>81c-41a3-acf1-8<span class="built_in">fc</span>3f4ea7f31</div></pre></td></tr></table></figure>
<h4 id="测试执行"><a href="#测试执行" class="headerlink" title="测试执行"></a>测试执行</h4><h5 id="执行一个测试类"><a href="#执行一个测试类" class="headerlink" title="执行一个测试类"></a>执行一个测试类</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment"># ostestr --pdb tempest.api.compute.servers.test_create_server | tee tempest_compute.log</span></div></pre></td></tr></table></figure>
<p>测试输出<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">======</div><div class="line">Totals</div><div class="line">======</div><div class="line">Ran: 16 tests in 334.0000 sec.</div><div class="line"> - Passed: 12</div><div class="line"> - Skipped: 4</div><div class="line"> - Expected Fail: 0</div><div class="line"> - Unexpected Success: 0</div><div class="line"> - Failed: 0</div><div class="line">Sum of execute time for each test: 232.6021 sec.</div><div class="line"></div><div class="line">==============</div><div class="line">Worker Balance</div><div class="line">==============</div><div class="line"> - Worker 0 (16 tests) =&gt; 0:04:47.392702</div></pre></td></tr></table></figure></p>
<h5 id="执行多个项目下的所有测试，并输出subunit"><a href="#执行多个项目下的所有测试，并输出subunit" class="headerlink" title="执行多个项目下的所有测试，并输出subunit"></a>执行多个项目下的所有测试，并输出subunit</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment"># ostestr --no-pretty --subunit --regex '^tempest\.api\.(compute|identity|image|network|volume|object_storage)' | tee tempest_all.log</span></div></pre></td></tr></table></figure>
<p>测试输出<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Test id                                                                                                                                                               Runtime (s)</div><div class="line">--------------------------------------------------------------------------------------------------------------------------------------------------------------------  -----------</div><div class="line">tempest.api.volume.test_volume_delete_cascade.VolumesDeleteCascade.test_volume_from_snapshot_cascade_delete[id-59a77ede-609b-4ee8-9f68-fc3c6ffe97b5]                  304.790</div><div class="line">tempest.api.image.v1.test_images.CreateRegisterImagesTest.test_register_http_image[id-6d0e13a7-515b-460c-b91f-9f4793f09816]                                           301.614</div><div class="line">tempest.api.compute.servers.test_attach_interfaces.AttachInterfacesTestJSON.test_create_list_show_delete_interfaces[id-73fe8f02-590d-4bf1-b184-e9ca81065051,network]  170.781</div><div class="line">tempest.api.compute.servers.test_delete_server.DeleteServersTestJSON.test_delete_server_while_in_shelved_state[id-bb0cb402-09dd-4947-b6e5-5e7e1cfa61ad]               153.487</div><div class="line">tempest.api.compute.volumes.test_attach_volume.AttachVolumeTestJSON.test_list_get_volume_attachments[id-7fa563fe-f0f7-43eb-9e22-a1ece036b513]                         105.981</div><div class="line">tempest.api.compute.images.test_images_oneserver.ImagesOneServerTestJSON.test_create_delete_image[id-3731d080-d4c5-4872-b41a-64d0d0021314]                             71.267</div><div class="line">tempest.api.volume.test_volumes_snapshots.VolumesSnapshotTestJSON.test_snapshot_create_delete_with_volume_in_use[compute,id-8567b54c-4455-446d-a1cf-651ddeaa3ff2]      69.934</div><div class="line">tempest.api.volume.test_volumes_snapshots.VolumesSnapshotTestJSON.test_snapshot_create_offline_delete_online[compute,id-5210a1de-85a0-11e6-bb21-641c676a5d61]          68.662</div><div class="line">tempest.api.compute.servers.test_delete_server.DeleteServersTestJSON.test_delete_server_while_in_shutoff_state[id-546d368c-bb6c-4645-979a-83ed16f3a6be]                61.945</div><div class="line">tempest.api.compute.servers.test_attach_interfaces.AttachInterfacesTestJSON.test_add_remove_fixed_ip[id-c7e0e60b-ee45-43d0-abeb-8596fd42a2f9,network,smoke]            60.422</div><div class="line"></div><div class="line">Slowest Tests:</div></pre></td></tr></table></figure></p>
<h4 id="转换测试结果为html文件"><a href="#转换测试结果为html文件" class="headerlink" title="转换测试结果为html文件"></a>转换测试结果为html文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment"># subunit2html tempest_all.log tempest.html</span></div></pre></td></tr></table></figure>
<h4 id="Tempest-执行时间很长，如何放到后台执行"><a href="#Tempest-执行时间很长，如何放到后台执行" class="headerlink" title="Tempest 执行时间很长，如何放到后台执行"></a>Tempest 执行时间很长，如何放到后台执行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]<span class="comment"># screen -r tempest</span></div><div class="line">[root@control01 ~]<span class="comment"># docker exec -it -u root tempest ostestr --no-pretty --subunit --regex  '^tempest\.api\.(compute|identity|image|network|volume|object_storage)' | tee tempest_all.log</span></div></pre></td></tr></table></figure>
<p><code>screen</code>窗口键入<code>ctrl</code>+<code>a</code> <code>d</code>,退出<code>screen</code><br>再次进入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]<span class="comment"># screen -r tempest</span></div></pre></td></tr></table></figure></p>
<h4 id="执行测试后提示：No-testr-conf-config-file"><a href="#执行测试后提示：No-testr-conf-config-file" class="headerlink" title="执行测试后提示：No .testr.conf config file"></a>执行测试后提示：No .testr.conf config file</h4><p>需要切换到<code>/tempest-source/tempest-16.0.1.dev358</code>目录执行，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment"># ls .testr.conf</span></div><div class="line">.testr.conf</div><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment"># pwd</span></div><div class="line">/tempest-source/tempest-16.0.1.dev358</div><div class="line">(tempest)[root@control01 tempest-16.0.1.dev358]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><h4 id="Rally介绍"><a href="#Rally介绍" class="headerlink" title="Rally介绍"></a>Rally介绍</h4><p><img src="https://ljw.howieli.cn/blog/2017-9-8/rally.png" alt=""></p>
<p>详情请看官方文档：<a href="https://wiki.openstack.org/wiki/Rally" target="_blank" rel="external">参考文档</a></p>
<h4 id="安装Rally"><a href="#安装Rally" class="headerlink" title="安装Rally"></a>安装Rally</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]<span class="comment"># vim /etc/kolla/globals.yml</span></div><div class="line">enable_rally: <span class="string">"yes"</span></div><div class="line">[root@control01 ~]<span class="comment"># kolla-ansible -i multinode deploy</span></div><div class="line">[root@control01 ~]<span class="comment"># docker ps |grep rally</span></div><div class="line">b239cb679134        172.18.22.162:4000/99cloud/centos-source-rally:animbus-5.2.0                       <span class="string">"kolla_start"</span>            8 days ago          Up 8 days                                    rally</div></pre></td></tr></table></figure>
<h4 id="Rally-配置"><a href="#Rally-配置" class="headerlink" title="Rally 配置"></a>Rally 配置</h4><h5 id="认证配置"><a href="#认证配置" class="headerlink" title="认证配置"></a>认证配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]<span class="comment"># docker cp /etc/kolla/admin-openrc.sh rally:/</span></div><div class="line">[root@control01 ~]<span class="comment"># docker exec -it -u root rally bash</span></div><div class="line">(rally)[root@control01 /]<span class="comment"># source admin-openrc.sh</span></div><div class="line">(rally)[root@control01 /]<span class="comment"># openstack image list</span></div></pre></td></tr></table></figure>
<h5 id="创建deployment"><a href="#创建deployment" class="headerlink" title="创建deployment"></a>创建deployment</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(rally)[root@control01 /]<span class="comment"># rally deployment create --fromenv --name ljw</span></div><div class="line">+--------------------------------------+---------------------+------+------------------+--------+</div><div class="line">| uuid                                 | created_at          | name | status           | active |</div><div class="line">+--------------------------------------+---------------------+------+------------------+--------+</div><div class="line">| 66dea2c5-bef5-41ac-8a83-1d80f0d3755f | 2017-09-12T05:55:54 | ljw  | deploy-&gt;finished |        |</div><div class="line">+--------------------------------------+---------------------+------+------------------+--------+</div></pre></td></tr></table></figure>
<h4 id="配置测试方案"><a href="#配置测试方案" class="headerlink" title="配置测试方案"></a>配置测试方案</h4><p>测试方案：</p>
<ul>
<li>使用image cirros创建10GB大小云硬盘</li>
<li>然后用此与硬盘、flavor m1.tiny创建虚拟机，并发是1，执行100次，使用20个租户，每个租户下面2个用户</li>
</ul>
<p>编辑测试脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">(rally)[root@control01 /]<span class="comment"># vi boot-from-volume.json</span></div><div class="line">&#123;% <span class="built_in">set</span> flavor_name = flavor_name or <span class="string">"m1.tiny"</span> %&#125;</div><div class="line">&#123;% <span class="built_in">set</span> volume_type = volume_type or <span class="string">""</span> %&#125;</div><div class="line">&#123;</div><div class="line">    <span class="string">"NovaServers.boot_server_from_volume"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"args"</span>: &#123;</div><div class="line">                <span class="string">"flavor"</span>: &#123;</div><div class="line">                    <span class="string">"name"</span>: <span class="string">"&#123;&#123;flavor_name&#125;&#125;"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"image"</span>: &#123;</div><div class="line">                    <span class="string">"name"</span>: <span class="string">"^cirros"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"volume_size"</span>: 10,</div><div class="line">                <span class="string">"volume_type"</span>: <span class="string">"&#123;&#123;volume_type&#125;&#125;"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"runner"</span>: &#123;</div><div class="line">                <span class="string">"type"</span>: <span class="string">"constant"</span>,</div><div class="line">                <span class="string">"times"</span>: 100,</div><div class="line">                <span class="string">"concurrency"</span>: 1</div><div class="line">            &#125;,</div><div class="line">            <span class="string">"context"</span>: &#123;</div><div class="line">                <span class="string">"users"</span>: &#123;</div><div class="line">                    <span class="string">"tenants"</span>: 20,</div><div class="line">                    <span class="string">"users_per_tenant"</span>: 2</div><div class="line">                &#125;,</div><div class="line">                <span class="string">"quotas"</span>: &#123;</div><div class="line">                    <span class="string">"nova"</span>: &#123;</div><div class="line">                        <span class="string">"instances"</span>: 20</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>导出测试报告<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(rally)[root@control01 /]<span class="comment"># rally task report b77ccde5-ceb7-444a-b9a9-75f0ff40b480 --out boot_server.html</span></div></pre></td></tr></table></figure></p>
<p>从容器中导出测试报告<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]<span class="comment"># docker cp rally:/boot_server.html .</span></div></pre></td></tr></table></figure></p>
<h4 id="分析测试报告"><a href="#分析测试报告" class="headerlink" title="分析测试报告"></a>分析测试报告</h4><p>可以用Google Chrome浏览器分析<br><img src="https://ljw.howieli.cn/blog/2017-9-8/rally测试报告.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> tempest rally </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[kolla搭建octavia]]></title>
      <url>/posts/kolla-octavia.html</url>
      <content type="html"><![CDATA[<h3 id="octavia-介绍"><a href="#octavia-介绍" class="headerlink" title="octavia 介绍"></a>octavia 介绍</h3><p>openstack octavia 是 openstack Lbaas项目分出来的一个子项目，是提供虚拟机流量负载均衡，其实oactavia就是调用nova以及neutron的api生成两台安装好了haproxy和keepalived软件的虚拟机，并连接到目标网络。octavia共有4个组件housekeeping,worker,api,health-manager。详情请参考 <a href="https://docs.openstack.org/octavia/latest/reference/introduction.html" target="_blank" rel="external">octavia介绍</a><br><a id="more"></a></p>
<h3 id="octavia-架构图"><a href="#octavia-架构图" class="headerlink" title="octavia 架构图"></a>octavia 架构图</h3><p><img src="https://ljw.howieli.cn/blog/2017-9-8/octavia架构图.png" alt=""></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>我事先准备好了一个kolla部署的多节点的openstack环境<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack service list</span></div><div class="line">+----------------------------------+------------------+-------------------------+</div><div class="line">| ID                               | Name             | Type                    |</div><div class="line">+----------------------------------+------------------+-------------------------+</div><div class="line">| 11bb0c086a484e33bf65558298a13f2d | manila           | share                   |</div><div class="line">| 126fb7d3b45f44008f9b5649e7fa6772 | glance           | image                   |</div><div class="line">| 1963c13ceda74eaa846ce53447aa9663 | swift            | object-store            |</div><div class="line">| 1d73b2481e0e4c2996e902282f53ac94 | ceilometer       | metering                |</div><div class="line">| 277ac4e4d36b4170a13dff885133d497 | cinderv3         | volumev3                |</div><div class="line">| 313e8abeeb5f46968e21c47be64fe37a | panko            | event                   |</div><div class="line">| 3546da190ebe4cb69a5e4054c1b226e8 | ironic-inspector | baremetal-introspection |</div><div class="line">| 3559efb2c60c4532b0e20f4280d00d65 | gnocchi          | metric                  |</div><div class="line">| 38fa732db46a4bf99a656cc4b29f9955 | trove            | database                |</div><div class="line">| 5003dabefad4462f80758eecc883a185 | sahara           | data_processing         |</div><div class="line">| 5b3ab9520859475fb874e570be8ea064 | manilav2         | sharev2                 |</div><div class="line">| 659cd19c052b452a8a954bbadfd94a5a | nova             | compute                 |</div><div class="line">| 72fcd0fc324248bdb8c5f08f9c65a1ea | nova_legacy      | compute_legacy          |</div><div class="line">| 754afe3e3b4349a0a54d26b7d83fec5e | cinder           | volume                  |</div><div class="line">| 85c1d57869754c38989f228c08896d4c | ironic           | baremetal               |</div><div class="line">| 9962758f42c140c4b811940bdc4041b2 | heat             | orchestration           |</div><div class="line">| b7dc29ababc54104b31ad3b999eae6b5 | heat-cfn         | cloudformation          |</div><div class="line">| bee93d265f994dd3bd9e76a326df0d1b | cinderv2         | volumev2                |</div><div class="line">| d6f1862a19434267a4a51fd4c8a6d665 | neutron          | network                 |</div><div class="line">| ee90e0f359d84c1eb35c3cd9423f43db | placement        | placement               |</div><div class="line">| f7b5b57d52494869ab20501c28237613 | cloudkitty       | rating                  |</div><div class="line">| fdb4e5b1658d4d39a1f807f9d7b2b4d7 | keystone         | identity                |</div><div class="line">+----------------------------------+------------------+-------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> https://review.openstack.org/p/openstack/octavia</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> octavia</span></div><div class="line"><span class="meta">#</span><span class="bash"> grep octavia_ca /etc/kolla/passwords.yml</span></div><div class="line">octavia_ca_password: mEUyBHLopKk501CX30WRnPuiDmoP3I7eNQIQbC6z</div><div class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">'s/foobar/mEUyBHLopKk501CX30WRnPuiDmoP3I7eNQIQbC6z/g'</span> bin/create_certificates.sh</span></div><div class="line"><span class="meta">#</span><span class="bash"> ./bin/create_certificates.sh cert $(<span class="built_in">pwd</span>)/etc/certificates/openssl.cnf</span></div></pre></td></tr></table></figure>
<p>然后你会得到一个文件夹<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ls -al cert/</span></div><div class="line">total 48</div><div class="line">drwxr-xr-x  4 root root  219 Sep  7 09:32 .</div><div class="line">drwxr-xr-x 17 root root 4096 Sep  7 09:32 ..</div><div class="line">-rw-r--r--  1 root root 1294 Sep  7 09:32 ca_01.pem</div><div class="line">-rw-r--r--  1 root root  989 Sep  7 09:32 client.csr</div><div class="line">-rw-r--r--  1 root root 1708 Sep  7 09:32 client.key</div><div class="line">-rw-r--r--  1 root root 4401 Sep  7 09:32 client-.pem</div><div class="line">-rw-r--r--  1 root root 6109 Sep  7 09:32 client.pem</div><div class="line">-rw-r--r--  1 root root   71 Sep  7 09:32 index.txt</div><div class="line">-rw-r--r--  1 root root   21 Sep  7 09:32 index.txt.attr</div><div class="line">-rw-r--r--  1 root root    0 Sep  7 09:32 index.txt.old</div><div class="line">drwxr-xr-x  2 root root   20 Sep  7 09:32 newcerts</div><div class="line">drwx------  2 root root   23 Sep  7 09:32 private</div><div class="line">-rw-r--r--  1 root root    3 Sep  7 09:32 serial</div><div class="line">-rw-r--r--  1 root root    3 Sep  7 09:32 serial.old</div></pre></td></tr></table></figure></p>
<p>将认证放到kolla部署节点上的/etc/kolla/octavia目录里，首先要先在/etc/kolla目录下创建一个octavia文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/kolla/config/octavia</span></div><div class="line"><span class="meta">#</span><span class="bash"> ls -al /etc/kolla/config/octavia/</span></div><div class="line">total 20</div><div class="line">drwxr-xr-x 2 root root   58 Sep  8 12:37 .</div><div class="line">drwxr-xr-x 5 root root 4096 Sep  8 12:36 ..</div><div class="line">-rw-r--r-- 1 root root 1294 Sep  8 12:37 ca_01.pem</div><div class="line">-rw-r--r-- 1 root root 1743 Sep  8 12:37 cakey.pem</div><div class="line">-rw-r--r-- 1 root root 6109 Sep  8 12:37 client.pem</div></pre></td></tr></table></figure></p>
<h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># pwd</div><div class="line">/root</div><div class="line"># cd octavia/diskimage-create/</div><div class="line"># ./diskimage-create.sh -i centos</div></pre></td></tr></table></figure>
<p>会产生amphora-x64-haproxy.qcow2镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ls amphora-x64-haproxy.qcow2</span></div><div class="line">amphora-x64-haproxy.qcow2</div></pre></td></tr></table></figure></p>
<p>上传镜像，因为我kolla部署openstack时候后端存储用的ceph，所以首先要把镜像转换成raw格式,然后在上传镜像，上传镜像必须给镜像打一个amphora的tag。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> qemu-img convert <span class="_">-f</span> qcow2 -O raw amphora-x64-haproxy.qcow2 amphora-x64-haproxy.raw</span></div><div class="line"><span class="meta">#</span><span class="bash"> qemu-img info amphora-x64-haproxy.raw</span></div><div class="line">image: amphora-x64-haproxy.raw</div><div class="line">file format: raw</div><div class="line">virtual size: 2.0G (2147483648 bytes)</div><div class="line">disk size: 1.5G</div><div class="line"><span class="meta">#</span><span class="bash"> openstack image create --container-format bare --disk-format raw --private --file amphora-x64-haproxy.raw --tag amphora amphora</span></div></pre></td></tr></table></figure></p>
<h3 id="准备openstack资源"><a href="#准备openstack资源" class="headerlink" title="准备openstack资源"></a>准备openstack资源</h3><p>octavia_amp_boot_network_list 网络,这里需要准备分给octavia用的网络ID,而且这个网络必须能和api互通<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack network create --provider-physical-network physnet1 \</span></div><div class="line">    --provider-network-type vlan --provider-segment 121 lb-net</div><div class="line"><span class="meta">#</span><span class="bash"> openstack subnet create --allocation-pool --network lb-net --subnet-range 10.140.1.0/24 \</span></div><div class="line">    lb-subnet</div></pre></td></tr></table></figure></p>
<p>还需要octavia_amp_flavor_id 值,这是octavia创建的虚拟机的大小。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack flavor create --disk 40 --private --ram 4096 --vcpus 2 octavia_flavor</span></div></pre></td></tr></table></figure></p>
<p>创建一个octavia的安全组，安全组的id值为octavia_amp_secgroup_list 值<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack security group create --description <span class="string">'used by Octavia amphora instance'</span> octavia</span></div></pre></td></tr></table></figure></p>
<p>为octavia安全组设置规则<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack security group rule create --protocol icmp f97161c4-ffda-4205-b984<span class="_">-d</span>3ecad0f9ce1</span></div><div class="line"><span class="meta">#</span><span class="bash"> openstack security group rule create --protocol tcp --dst-port 5555 --egress f97161c4-ffda-4205-b984<span class="_">-d</span>3ecad0f9ce1</span></div><div class="line"><span class="meta">#</span><span class="bash"> openstack security group rule create --protocol tcp --dst-port 9443 --ingress f97161c4-ffda-4205-b984<span class="_">-d</span>3ecad0f9ce1</span></div></pre></td></tr></table></figure></p>
<p>octavia 机器启动时注入的  key, octavia_ssh_key 名字是固定的，需要和 octavia.conf 配置文件相同。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack keypair create --public-key /root/.ssh/id_rsa.pub octavia_ssh_key</span></div><div class="line"><span class="meta">#</span><span class="bash"> 我们也可以使用 octavia 账号去建虚拟机，所以 ssh key 要使用 octavia 账号创建。</span></div><div class="line"><span class="meta">#</span><span class="bash"> openstack --os-username octavia --os-password &lt;octavia_keystone_password&gt; keypair create --public-key /tmp/id_rsa.pub octavia_ssh_key</span></div></pre></td></tr></table></figure></p>
<h3 id="更改globas-yml文件"><a href="#更改globas-yml文件" class="headerlink" title="更改globas.yml文件"></a>更改globas.yml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/globals.yml</span></div><div class="line">enable_horizon_neutron_lbaas: "yes"</div><div class="line">enable_neutron_lbaas: "yes"</div><div class="line">enable_octavia: yes</div><div class="line"><span class="meta">#</span><span class="bash"> Load balancer topology options are [ SINGLE, ACTIVE_STANDBY ]</span></div><div class="line">octavia_loadbalancer_topology: "ACTIVE_STANDBY"</div><div class="line">octavia_amp_boot_network_list: ffc00802-c88b-4a5e-a51b-60071f4045d5</div><div class="line">octavia_amp_secgroup_list: f97161c4-ffda-4205-b984-d3ecad0f9ce1</div><div class="line">octavia_amp_flavor_id: 54f2cc50-81d4-44d3-8e44-a01686e4b2c6</div></pre></td></tr></table></figure>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible deploy -i multinode</span></div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> octavia </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ironic裸机服务使用说明]]></title>
      <url>/posts/ironic-instruction.html</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>“裸机功能使用说明”介绍了裸机配置中的一些技术细节，旨在帮助用户更好地了解和使用 ironic。<br><a id="more"></a></p>
<h3 id="whole-disk镜像和partition镜像区别"><a href="#whole-disk镜像和partition镜像区别" class="headerlink" title="whole disk镜像和partition镜像区别"></a>whole disk镜像和partition镜像区别</h3><hr>
<p>partition image部署可以支持windows系统，但是不支持自定义分区，因为分区表在制作镜像时已经被确定下来。但partition image支持按照配置中规定的root,swap分区来自动进行磁盘分区。</p>
<p>partition image方式部署的机器将kernel和ramdisk都存放在tftp server上，每次启动都需要访问tftp,whole disk部署的服务器启动时不需要访问tftp server。</p>
<hr>
<h3 id="noop，neutron和flat简介"><a href="#noop，neutron和flat简介" class="headerlink" title="noop，neutron和flat简介"></a>noop，neutron和flat简介</h3><hr>
<p>noop ：用于stand alone(不和OpenStack集成的模式)部署用的网络模式，在部署过程不进行任何的网络切换。</p>
<p>neutron ：通过与provide的网络集成来提供租户定义的网络，同时还将租户网络与provision network和cleaning network网络分开。</p>
<p>flat ：用于提供外网访问和部署的二层网络,provision network和cleaning network网络可以放在一起，也可以分开。</p>
<h3 id="IPMI带内（in-band）信道和带外（out-of-band）信道"><a href="#IPMI带内（in-band）信道和带外（out-of-band）信道" class="headerlink" title="IPMI带内（in band）信道和带外（out of band）信道"></a>IPMI带内（in band）信道和带外（out of band）信道</h3><hr>
<p>IPMI 信道分为带内信道和带外信道两种类型，但配置裸机并不是按照带内和带外信道的方式来划分驱动。</p>
<p>带内和带外的区别主要体现在不同行为的的管理方式上,例如检查时，通过agent发现硬件属性就是带内的管理方式，通过ilo rest接口查询就是带外的方式；部署时，通过iscsi部署是带外的部署方式，通过agent部署是带内的部署方式。</p>
<hr>
<h3 id="裸机配置状态介绍"><a href="#裸机配置状态介绍" class="headerlink" title="裸机配置状态介绍"></a>裸机配置状态介绍</h3><hr>
<p><img src="https://ljw.howieli.cn/blog/2017-9-8/ironic.png" alt=""><br>注册（Enroll)：所有节点的初始状态，代表节点已经存在，但在这种状态下无法对节点进行下一步操作。</p>
<p>当获取到节点信息以及驱动详情后，可通过调用manage API，使节点过渡到验证状态。</p>
<p>验证（Verifying)：ironic会对节点的驱动和证书进行验证，验证成功后节点的配置状态将过渡到可管理状态。</p>
<p>可管理（Manageable)：此时，可对节点进行管理（包括电源状态等）。此时节点可以：</p>
<pre><code>从清理中（Cleaning）到可管理，通过调用clean API；
从检查中（Inspecting）到可管理，通过调用inspect API；
通过清理中（Cleaning）到Available，通过调用provide API。
</code></pre><p>检查（Inspecting)：检查过程将调用节点的自我检查功能来更新节点的硬件属性。如果检查失败配置状态将过渡到检查失败（inspectfail）。</p>
<p>清理中（Cleaning):节点通过清理确保自身能够成功过渡到可用状态（Available）。清理过程中的任务包括：</p>
<pre><code>清除驱动器
验证硬件完整性
验证节点中的配置信息和物理硬件的配置是否一致。
启动Ramdisk内核
</code></pre><p>当节点处于清理状态，如果使用带外信道（out of band)则控制器会进入清理步骤，如果是带内信道（in band)方式，控制器会开始为安装磁盘做环境准备。</p>
<p>可用（Available):处于可用状态下的节点已经进行过清理和预配置过程，在可用状态下：</p>
<pre><code>通过调用active API过渡到活跃状态（Active)；
通过调用manage API过渡到可管理状态(Manageable)
</code></pre><p>配置中（Deploying):处于配置中的节点，正在为裸机的创建作积极准备。这一过程中会运行一系列短暂任务，如：</p>
<pre><code>配置BIOS；
部署分区、安装文件系统驱动；
创建额外的资源（如：网络配置）以及其他附加
</code></pre><p>的子系统要求；</p>
<p>活跃（Active):节点上有裸机在运行，此时节点可：</p>
<pre><code>通过调用rescue API过渡到维护（Rescue）状态；
通过调用delete API过渡到可用状态（Available)；
通过调用rebuild API过渡到活跃状态（Active).
</code></pre><p>删除中（Deleting)：在删除状态下，部署在节点上的裸机会删除。</p>
<hr>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> kolla </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[kolla搭建ironic裸机服务]]></title>
      <url>/posts/kolla-ironic.html</url>
      <content type="html"><![CDATA[<h3 id="内容说明"><a href="#内容说明" class="headerlink" title="内容说明"></a>内容说明</h3><p>  本文介绍在kolla 管理虚拟机配置流程，包括部署ironic和 裸机管理配置两部分，实现在flat 网络下管理裸机。<br><a id="more"></a></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>在kolla 环境上增加裸机管理功能。</p>
<p>由于ironic 在管理裸机时需要一个网络来管理裸机的部署和清理。所以需要在部署ironic 前先创建一个flat类型的provision network 网络。本文档业务网络和provision network 网络共用一个。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# source /etc/kolla/admin-openrc.sh</div><div class="line">[root@control01 ~]# openstack network create --provider-physical-network physnet1 \</div><div class="line">    --provider-network-type flat provision-net</div><div class="line">[root@control01 ~]# openstack subnet create --allocation-pool start=172.18.23.1,end=172.18.23.199 \</div><div class="line">    --network provision-net --subnet-range 172.18.23.0.0/24 \</div><div class="line">    --gateway 172.18.151.1 provision-subnet</div></pre></td></tr></table></figure></p>
<h3 id="部署ironic"><a href="#部署ironic" class="headerlink" title="部署ironic"></a>部署ironic</h3><h4 id="修改globals-yml文件"><a href="#修改globals-yml文件" class="headerlink" title="修改globals.yml文件"></a>修改globals.yml文件</h4><p>ironic_cleaning_network 是上面创建的provision network网络ID。 ironic_dnsmasq_dhcp_range 可以随便定义一个，并不会用到，是为了保证ironic_dnsmasq 容器启动正常。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# vim /etc/kolla/globals.yml</div><div class="line">ironic_cleaning_network: "f157770d-e81c-41a3-acf1-8fc3f4ea7f31"</div><div class="line">ironic_dnsmasq_dhcp_range: "172.18.22.210,172.18.22.219"</div><div class="line">enable_horizon_ironic: "&#123;&#123; enable_ironic | bool &#125;&#125;"</div><div class="line">enable_ironic: "yes"</div><div class="line">enable_nova_serialconsole_proxy: "yes"</div></pre></td></tr></table></figure></p>
<h4 id="准备ironic-agent镜像"><a href="#准备ironic-agent镜像" class="headerlink" title="准备ironic-agent镜像"></a>准备ironic-agent镜像</h4><p>ironic-agent 镜像是在联网环境下通过diskimage-builder 生成, 参考官方文档 <a href="https://docs.openstack.org/ironic/latest/install/deploy-ramdisk.html#disk-image-builder" target="_blank" rel="external">disk-image-builder</a>。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# pip install diskimage-builder</div><div class="line">[root@control01 ~]# disk-image-create ironic-agent fedora -o ironic-agent</div></pre></td></tr></table></figure></p>
<p>上传镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# source /etc/kolla/admin-openrc.sh</div><div class="line">[root@control01 ~]# glance image-create --name deploy-vmlinuz \</div><div class="line">    --visibility public  --disk-format aki \</div><div class="line">    --container-format aki --file ./ironic-agent.vmlinuz</div><div class="line">[root@control01 ~]# glance image-create --name deploy-initrd \</div><div class="line">    --visibility public --disk-format ari \</div><div class="line">    --container-format ari --file ./ironic-agent.initramfs</div></pre></td></tr></table></figure></p>
<p>把ironic-agent.initramfs ironic-agent.kernel放到/etc/kolla/config/ironic目录下。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# cd /etc/kolla/config/ironic</div><div class="line">[root@control01 ~]# ls</div><div class="line">ironic-agent.initramfs ironic-agent.kernel</div></pre></td></tr></table></figure></p>
<h4 id="配置ironic-conf"><a href="#配置ironic-conf" class="headerlink" title="配置ironic.conf"></a>配置ironic.conf</h4><p>配置drivers 为支持远程console 的pxe_ipmitool_socat<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# cat /etc/kolla/config/ironic.conf</div><div class="line">[DEFAULT]</div><div class="line">enabled_drivers = pxe_ipmitool_socat,pxe_ipmitool</div><div class="line">enabled_hardware_types = ipmi</div><div class="line">enabled_network_interfaces=noop,flat</div><div class="line">enabled_power_interfaces = ipmitool</div><div class="line">enabled_management_interfaces = ipmitool</div><div class="line"></div><div class="line">[neutron]</div><div class="line"><span class="meta">#</span><span class="bash">After deploy the OpenStack, Update the cleaning_network</span></div><div class="line"><span class="meta">#</span><span class="bash">cleaning_network = externel</span></div><div class="line"></div><div class="line">[conductor]</div><div class="line">sync_power_state_interval = 10</div><div class="line">power_state_sync_max_retries = 20</div><div class="line"><span class="meta">#</span><span class="bash">power_state_change_timeout = 30</span></div><div class="line">deploy_callback_timeout = 900</div><div class="line">force_power_state_during_sync = true</div><div class="line"></div><div class="line">[pxe]</div><div class="line"><span class="meta">#</span><span class="bash">uefi_pxe_bootfile_name = bootx64.efi</span></div><div class="line"><span class="meta">#</span><span class="bash">After deploy the OpenStack, Update the tftp_server</span></div><div class="line"><span class="meta">#</span><span class="bash">tftp_server =</span></div><div class="line"><span class="meta">#</span><span class="bash">pxe_append_params = coreos.autologin rd.auto=1 nofb nomodeset vga=normal console=ttyS0,115200n8</span></div><div class="line">pxe_append_params = nofb nomodeset vga=normal console=tty0 console=ttyS0,115200n8</div><div class="line"></div><div class="line">[disk_utils]</div><div class="line"><span class="meta">#</span><span class="bash">default interval is 1 second</span></div><div class="line">iscsi_verify_attempts = 30</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> cat /etc/kolla/config/ironic.conf</span></div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line">enabled_drivers = pxe_ipmitool_socat</div><div class="line">enabled_network_interfaces=noop,flat</div><div class="line"></div><div class="line">[pxe]</div><div class="line">pxe_append_params = nofb nomodeset vga=normal console=tty0 console=ttyS0,115200n8</div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">cat /etc/kolla/config/ironic.conf</div><div class="line">[DEFAULT]</div><div class="line">enabled_drivers = pxe_ipmitool_socat</div><div class="line">enabled_hardware_types = redfish</div><div class="line">enabled_power_interfaces = ipmitool,redfish</div><div class="line">enabled_management_interfaces = ipmitool,redfish</div><div class="line">default_network_interface = flat</div><div class="line"></div><div class="line">[neutron]</div><div class="line"><span class="meta">#</span><span class="bash">After deploy the OpenStack, Update the cleaning_network</span></div><div class="line"><span class="meta">#</span><span class="bash">cleaning_network = externel</span></div><div class="line"></div><div class="line">[conductor]</div><div class="line">sync_power_state_interval = 10</div><div class="line">power_state_sync_max_retries = 20</div><div class="line"><span class="meta">#</span><span class="bash">power_state_change_timeout = 30</span></div><div class="line">deploy_callback_timeout = 900</div><div class="line">force_power_state_during_sync = true</div><div class="line"></div><div class="line">[pxe]</div><div class="line">pxe_append_params = coreos.autologin rd.auto=1 nofb nomodeset vga=normal console=ttyS0,115200n8</div><div class="line"></div><div class="line">[disk_utils]</div><div class="line"><span class="meta">#</span><span class="bash">default interval is 1 second</span></div><div class="line">iscsi_verify_attempts = 30</div></pre></td></tr></table></figure></p>
<h3 id="检查部署"><a href="#检查部署" class="headerlink" title="检查部署"></a>检查部署</h3><h4 id="部署检查"><a href="#部署检查" class="headerlink" title="部署检查"></a>部署检查</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# kolla-ansible -i multinode prechecks</div></pre></td></tr></table></figure>
<h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# kolla-ansible -i multinode deploy</div></pre></td></tr></table></figure>
<h4 id="部署后检查"><a href="#部署后检查" class="headerlink" title="部署后检查"></a>部署后检查</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# ironic driver-list</div><div class="line">+---------------------+---------------------------------+</div><div class="line">| Supported driver(s) | Active host(s)                  |</div><div class="line">+---------------------+---------------------------------+</div><div class="line">| ipmi                | control02, control03, control01 |</div><div class="line">| pxe_ipmitool        | control02, control03, control01 |</div><div class="line">| pxe_ipmitool_socat  | control02, control03, control01 |</div><div class="line">+---------------------+---------------------------------+</div><div class="line">[root@control01 ~]# nova service-list</div><div class="line">+-----+------------------+------------------+----------+---------+-------+----------------------------+-----------------+</div><div class="line">| Id  | Binary           | Host             | Zone     | Status  | State | Updated_at                 | Disabled Reason |</div><div class="line">+-----+------------------+------------------+----------+---------+-------+----------------------------+-----------------+</div><div class="line">| 4   | nova-scheduler   | control02        | internal | enabled | up    | 2017-08-31T01:48:41.000000 | -               |</div><div class="line">| 10  | nova-scheduler   | control01        | internal | enabled | up    | 2017-08-31T01:48:37.000000 | -               |</div><div class="line">| 22  | nova-conductor   | control02        | internal | enabled | up    | 2017-08-31T01:48:40.000000 | -               |</div><div class="line">| 31  | nova-conductor   | control01        | internal | enabled | up    | 2017-08-31T01:48:39.000000 | -               |</div><div class="line">| 61  | nova-consoleauth | control02        | internal | enabled | up    | 2017-08-31T01:48:36.000000 | -               |</div><div class="line">| 64  | nova-consoleauth | control01        | internal | enabled | up    | 2017-08-31T01:48:42.000000 | -               |</div><div class="line">| 67  | nova-compute     | control02        | nova     | enabled | up    | 2017-08-31T01:48:40.000000 | -               |</div><div class="line">| 70  | nova-compute     | control01        | nova     | enabled | up    | 2017-08-31T01:48:36.000000 | -               |</div><div class="line">| 76  | nova-scheduler   | control03        | internal | enabled | up    | 2017-08-31T01:48:42.000000 | -               |</div><div class="line">| 82  | nova-conductor   | control03        | internal | enabled | up    | 2017-08-31T01:48:36.000000 | -               |</div><div class="line">| 91  | nova-consoleauth | control03        | internal | enabled | up    | 2017-08-31T01:48:43.000000 | -               |</div><div class="line">| 94  | nova-compute     | control03        | nova     | enabled | up    | 2017-08-31T01:48:44.000000 | -               |</div><div class="line">| 97  | nova-compute     | control03-ironic | nova     | enabled | up    | 2017-08-31T01:48:44.000000 | -               |</div><div class="line">| 100 | nova-compute     | control02-ironic | nova     | enabled | up    | 2017-08-31T01:48:42.000000 | -               |</div><div class="line">| 103 | nova-compute     | control01-ironic | nova     | enabled | up    | 2017-08-31T01:48:43.000000 | -               |</div><div class="line">+-----+------------------+------------------+----------+---------+-------+----------------------------+-----------------+</div></pre></td></tr></table></figure>
<h3 id="使用ironic-管理物理服务器"><a href="#使用ironic-管理物理服务器" class="headerlink" title="使用ironic 管理物理服务器"></a>使用ironic 管理物理服务器</h3><p>每一台需要管理的裸机，都要创建为一个ironic node ，包括ipmi、服务器配置等信息。 再为ironic node 配置管理网卡的信息。</p>
<h4 id="创建ironic-node"><a href="#创建ironic-node" class="headerlink" title="创建ironic node"></a>创建ironic node</h4><p>创建ironic node,配置网络接口为flat<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# export IRONIC_API_VERSION=1.20</div><div class="line">[root@control01 ~]# ironic node-create -d pxe_ipmitool_socat --network-interface flat -n node1</div><div class="line">+-------------------+--------------------------------------+</div><div class="line">| Property          | Value                                |</div><div class="line">+-------------------+--------------------------------------+</div><div class="line">| chassis_uuid      | None                                 |</div><div class="line">| driver            | pxe_ipmitool_socat                   |</div><div class="line">| driver_info       | &#123;&#125;                                   |</div><div class="line">| extra             | &#123;&#125;                                   |</div><div class="line">| name              | node1                                |</div><div class="line">| network_interface | flat                                 |</div><div class="line">| properties        | &#123;&#125;                                   |</div><div class="line">| resource_class    |                                      |</div><div class="line">| uuid              | c78f0257-bfbf-489c-b525-a39e0b924b79 |</div><div class="line">+-------------------+--------------------------------------+</div></pre></td></tr></table></figure></p>
<h4 id="配置ironic-node-信息"><a href="#配置ironic-node-信息" class="headerlink" title="配置ironic node 信息"></a>配置ironic node 信息</h4><h5 id="配置ipmi信息"><a href="#配置ipmi信息" class="headerlink" title="配置ipmi信息"></a>配置ipmi信息</h5><p>ipmi_username,ipmi_password,ipmi_address 为裸机ipmi信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# NODE_UUID=$(ironic node-list|grep node1|awk -F "| " '&#123;print $2&#125;')</div><div class="line">[root@control01 ~]#  ironic node-update $NODE_UUID add     driver_info/ipmi_username=admin   \</div><div class="line"><span class="meta">&gt;</span><span class="bash">    driver_info/ipmi_password=admin     driver_info/ipmi_address=172.18.21.164 \</span></div><div class="line"><span class="meta">&gt;</span><span class="bash">    driver_info/ipmi_terminal_port=8901</span></div><div class="line">+------------------------+------------------------------------------------------------------+</div><div class="line">| Property               | Value                                                            |</div><div class="line">+------------------------+------------------------------------------------------------------+</div><div class="line">| chassis_uuid           | None                                                             |</div><div class="line">| clean_step             | &#123;&#125;                                                               |</div><div class="line">| console_enabled        | False                                                            |</div><div class="line">| created_at             | 2017-08-31T01:50:09+00:00                                        |</div><div class="line">| driver                 | pxe_ipmitool_socat                                               |</div><div class="line">| driver_info            | &#123;u'ipmi_terminal_port': 8901, u'ipmi_address': u'172.18.21.164', |</div><div class="line">|                        | u'ipmi_username': u'admin', u'ipmi_password': u'******'&#125;         |</div><div class="line">| driver_internal_info   | &#123;&#125;                                                               |</div><div class="line">| extra                  | &#123;&#125;                                                               |</div><div class="line">| inspection_finished_at | None                                                             |</div><div class="line">| inspection_started_at  | None                                                             |</div><div class="line">| instance_info          | &#123;&#125;                                                               |</div><div class="line">| instance_uuid          | None                                                             |</div><div class="line">| last_error             | None                                                             |</div><div class="line">| maintenance            | False                                                            |</div><div class="line">| maintenance_reason     | None                                                             |</div><div class="line">| name                   | node1                                                            |</div><div class="line">| network_interface      | flat                                                             |</div><div class="line">| power_state            | None                                                             |</div><div class="line">| properties             | &#123;&#125;                                                               |</div><div class="line">| provision_state        | enroll                                                           |</div><div class="line">| provision_updated_at   | None                                                             |</div><div class="line">| raid_config            | &#123;&#125;                                                               |</div><div class="line">| reservation            | control02                                                        |</div><div class="line">| resource_class         |                                                                  |</div><div class="line">| target_power_state     | None                                                             |</div><div class="line">| target_provision_state | None                                                             |</div><div class="line">| target_raid_config     | &#123;&#125;                                                               |</div><div class="line">| updated_at             | 2017-08-31T01:51:40+00:00                                        |</div><div class="line">| uuid                   | c78f0257-bfbf-489c-b525-a39e0b924b79                             |</div><div class="line">+------------------------+------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<h4 id="配置ramdisk-kernel信息"><a href="#配置ramdisk-kernel信息" class="headerlink" title="配置ramdisk ,kernel信息"></a>配置ramdisk ,kernel信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# DEPLOY_VMLINUZ_UUID=$(glance image-list|grep deploy-vmlinuz|awk -F "| " '&#123;print $2&#125;')</div><div class="line">[root@control01 ~]# DEPLOY_INITRD_UUID=$(glance image-list|grep deploy-initrd|awk -F "| " '&#123;print $2&#125;')</div><div class="line">[root@control01 ~]# ironic node-update $NODE_UUID add     driver_info/deploy_kernel=$DEPLOY_VMLINUZ_UUID \</div><div class="line"><span class="meta">&gt;</span><span class="bash">     driver_info/deploy_ramdisk=<span class="variable">$DEPLOY_INITRD_UUID</span></span></div><div class="line">+------------------------+-----------------------------------------------------------------------+</div><div class="line">| Property               | Value                                                                 |</div><div class="line">+------------------------+-----------------------------------------------------------------------+</div><div class="line">| chassis_uuid           | None                                                                  |</div><div class="line">| clean_step             | &#123;&#125;                                                                    |</div><div class="line">| console_enabled        | False                                                                 |</div><div class="line">| created_at             | 2017-08-31T01:50:09+00:00                                             |</div><div class="line">| driver                 | pxe_ipmitool_socat                                                    |</div><div class="line">| driver_info            | &#123;u'ipmi_terminal_port': 8901, u'ipmi_username': u'admin',             |</div><div class="line">|                        | u'deploy_kernel': u'99a5c143-e231-4018-a6bf-121585eb6290',            |</div><div class="line">|                        | u'ipmi_address': u'172.18.21.164', u'deploy_ramdisk':                 |</div><div class="line">|                        | u'8c23e3e4-e749-4a91-9af7-63674b5f5128', u'ipmi_password': u'******'&#125; |</div><div class="line">| driver_internal_info   | &#123;&#125;                                                                    |</div><div class="line">| extra                  | &#123;&#125;                                                                    |</div><div class="line">| inspection_finished_at | None                                                                  |</div><div class="line">| inspection_started_at  | None                                                                  |</div><div class="line">| instance_info          | &#123;&#125;                                                                    |</div><div class="line">| instance_uuid          | None                                                                  |</div><div class="line">| last_error             | None                                                                  |</div><div class="line">| maintenance            | False                                                                 |</div><div class="line">| maintenance_reason     | None                                                                  |</div><div class="line">| name                   | node1                                                                 |</div><div class="line">| network_interface      | flat                                                                  |</div><div class="line">| power_state            | None                                                                  |</div><div class="line">| properties             | &#123;&#125;                                                                    |</div><div class="line">| provision_state        | enroll                                                                |</div><div class="line">| provision_updated_at   | None                                                                  |</div><div class="line">| raid_config            | &#123;&#125;                                                                    |</div><div class="line">| reservation            | control02                                                             |</div><div class="line">| resource_class         |                                                                       |</div><div class="line">| target_power_state     | None                                                                  |</div><div class="line">| target_provision_state | None                                                                  |</div><div class="line">| target_raid_config     | &#123;&#125;                                                                    |</div><div class="line">| updated_at             | 2017-08-31T01:52:16+00:00                                             |</div><div class="line">| uuid                   | c78f0257-bfbf-489c-b525-a39e0b924b79                                  |</div><div class="line">+------------------------+-----------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<h5 id="配置服务器硬件信息"><a href="#配置服务器硬件信息" class="headerlink" title="配置服务器硬件信息"></a>配置服务器硬件信息</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# ironic node-update $NODE_UUID add  properties/cpus=36  properties/memory_mb=129024 \</div><div class="line"><span class="meta">&gt;</span><span class="bash">     properties/local_gb=120     properties/cpu_arch=x86_64</span></div><div class="line">+------------------------+-----------------------------------------------------------------------+</div><div class="line">| Property               | Value                                                                 |</div><div class="line">+------------------------+-----------------------------------------------------------------------+</div><div class="line">| chassis_uuid           | None                                                                  |</div><div class="line">| clean_step             | &#123;&#125;                                                                    |</div><div class="line">| console_enabled        | False                                                                 |</div><div class="line">| created_at             | 2017-08-31T01:50:09+00:00                                             |</div><div class="line">| driver                 | pxe_ipmitool_socat                                                    |</div><div class="line">| driver_info            | &#123;u'ipmi_terminal_port': 8901, u'ipmi_username': u'admin',             |</div><div class="line">|                        | u'deploy_kernel': u'99a5c143-e231-4018-a6bf-121585eb6290',            |</div><div class="line">|                        | u'ipmi_address': u'172.18.21.164', u'deploy_ramdisk':                 |</div><div class="line">|                        | u'8c23e3e4-e749-4a91-9af7-63674b5f5128', u'ipmi_password': u'******'&#125; |</div><div class="line">| driver_internal_info   | &#123;&#125;                                                                    |</div><div class="line">| extra                  | &#123;&#125;                                                                    |</div><div class="line">| inspection_finished_at | None                                                                  |</div><div class="line">| inspection_started_at  | None                                                                  |</div><div class="line">| instance_info          | &#123;&#125;                                                                    |</div><div class="line">| instance_uuid          | None                                                                  |</div><div class="line">| last_error             | None                                                                  |</div><div class="line">| maintenance            | False                                                                 |</div><div class="line">| maintenance_reason     | None                                                                  |</div><div class="line">| name                   | node1                                                                 |</div><div class="line">| network_interface      | flat                                                                  |</div><div class="line">| power_state            | None                                                                  |</div><div class="line">| properties             | &#123;u'memory_mb': 129024, u'cpu_arch': u'x86_64', u'local_gb': 120,      |</div><div class="line">|                        | u'cpus': 36&#125;                                                          |</div><div class="line">| provision_state        | enroll                                                                |</div><div class="line">| provision_updated_at   | None                                                                  |</div><div class="line">| raid_config            | &#123;&#125;                                                                    |</div><div class="line">| reservation            | control02                                                             |</div><div class="line">| resource_class         |                                                                       |</div><div class="line">| target_power_state     | None                                                                  |</div><div class="line">| target_provision_state | None                                                                  |</div><div class="line">| target_raid_config     | &#123;&#125;                                                                    |</div><div class="line">| updated_at             | 2017-08-31T01:52:28+00:00                                             |</div><div class="line">| uuid                   | c78f0257-bfbf-489c-b525-a39e0b924b79                                  |</div><div class="line">+------------------------+-----------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<h5 id="开启控制台"><a href="#开启控制台" class="headerlink" title="开启控制台"></a>开启控制台</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]#  ironic node-set-console-mode $NODE_UUID true</div></pre></td></tr></table></figure>
<h4 id="创建ironic-port"><a href="#创建ironic-port" class="headerlink" title="创建ironic port"></a>创建ironic port</h4><p>MAC_ADDRESS 为裸机业务网络网卡MAC地址, 可以登录裸机IPMI查询。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# MAC_ADDRESS=08:9E:01:FC:48:7D</div><div class="line">[root@control01 ~]#  ironic port-create -n $NODE_UUID -a $MAC_ADDRESS</div><div class="line">+-----------------------+--------------------------------------+</div><div class="line">| Property              | Value                                |</div><div class="line">+-----------------------+--------------------------------------+</div><div class="line">| address               | 08:9e:01:fc:48:7d                    |</div><div class="line">| extra                 | &#123;&#125;                                   |</div><div class="line">| local_link_connection | &#123;&#125;                                   |</div><div class="line">| node_uuid             | c78f0257-bfbf-489c-b525-a39e0b924b79 |</div><div class="line">| portgroup_uuid        |                                      |</div><div class="line">| pxe_enabled           | True                                 |</div><div class="line">| uuid                  | 40158d94-76c2-4893-b081-075729ea210f |</div><div class="line">+-----------------------+--------------------------------------+</div></pre></td></tr></table></figure></p>
<h5 id="检查ironic-node"><a href="#检查ironic-node" class="headerlink" title="检查ironic node"></a>检查ironic node</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# ironic node-list</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">| UUID                                 | Name  | Instance UUID | Power State | Provisioning State | Maintenance |</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">| c78f0257-bfbf-489c-b525-a39e0b924b79 | node1 | None          | None        | enroll             | False       |</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">[root@control01 ~]# ironic node-show c78f0257-bfbf-489c-b525-a39e0b924b79</div><div class="line">+------------------------+--------------------------------------------------------------------------+</div><div class="line">| Property               | Value                                                                    |</div><div class="line">+------------------------+--------------------------------------------------------------------------+</div><div class="line">| chassis_uuid           | None                                                                     |</div><div class="line">| clean_step             | &#123;&#125;                                                                       |</div><div class="line">| console_enabled        | False                                                                    |</div><div class="line">| created_at             | 2017-08-31T01:50:09+00:00                                                |</div><div class="line">| driver                 | pxe_ipmitool_socat                                                       |</div><div class="line">| driver_info            | &#123;u'ipmi_terminal_port': 8901, u'ipmi_username': u'admin',                |</div><div class="line">|                        | u'deploy_kernel': u'99a5c143-e231-4018-a6bf-121585eb6290',               |</div><div class="line">|                        | u'ipmi_address': u'172.18.21.164', u'deploy_ramdisk':                    |</div><div class="line">|                        | u'8c23e3e4-e749-4a91-9af7-63674b5f5128', u'ipmi_password': u'******'&#125;    |</div><div class="line">| driver_internal_info   | &#123;&#125;                                                                       |</div><div class="line">| extra                  | &#123;&#125;                                                                       |</div><div class="line">| inspection_finished_at | None                                                                     |</div><div class="line">| inspection_started_at  | None                                                                     |</div><div class="line">| instance_info          | &#123;&#125;                                                                       |</div><div class="line">| instance_uuid          | None                                                                     |</div><div class="line">| last_error             | Error enabling the console on node c78f0257-bfbf-489c-b525-a39e0b924b79. |</div><div class="line">|                        | Reason: Console subprocess failed to start. Command: socat -T600         |</div><div class="line">|                        | -L/tmp/c78f0257-bfbf-489c-b525-a39e0b924b79.pid                          |</div><div class="line">|                        | TCP4-LISTEN:8901,bind=172.18.22.161,reuseaddr EXEC:"ipmitool -H          |</div><div class="line">|                        | 172.18.21.164 -I lanplus -U admin -f /tmp/c78f0257-bfbf-                 |</div><div class="line">|                        | 489c-b525-a39e0b924b79.pw -v sol activate",pty,stderr. Exit code: 1.     |</div><div class="line">|                        | Stderr: '2017/08/31 09:52:42 socat[39] E bind(11, &#123;AF=2                  |</div><div class="line">|                        | 172.18.22.161:8901&#125;, 16): Address already in use                         |</div><div class="line">|                        | '                                                                        |</div><div class="line">| maintenance            | False                                                                    |</div><div class="line">| maintenance_reason     | None                                                                     |</div><div class="line">| name                   | node1                                                                    |</div><div class="line">| network_interface      | flat                                                                     |</div><div class="line">| power_state            | None                                                                     |</div><div class="line">| properties             | &#123;u'memory_mb': 129024, u'cpu_arch': u'x86_64', u'local_gb': 120,         |</div><div class="line">|                        | u'cpus': 36&#125;                                                             |</div><div class="line">| provision_state        | enroll                                                                   |</div><div class="line">| provision_updated_at   | None                                                                     |</div><div class="line">| raid_config            | &#123;&#125;                                                                       |</div><div class="line">| reservation            | None                                                                     |</div><div class="line">| resource_class         |                                                                          |</div><div class="line">| target_power_state     | None                                                                     |</div><div class="line">| target_provision_state | None                                                                     |</div><div class="line">| target_raid_config     | &#123;&#125;                                                                       |</div><div class="line">| updated_at             | 2017-08-31T01:53:01+00:00                                                |</div><div class="line">| uuid                   | c78f0257-bfbf-489c-b525-a39e0b924b79                                     |</div><div class="line">+------------------------+--------------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<h5 id="修改状态将enroll改为available"><a href="#修改状态将enroll改为available" class="headerlink" title="修改状态将enroll改为available"></a>修改状态将enroll改为available</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# ironic --ironic-api-version 1.20 node-set-provision-state $NODE_UUID manage</div><div class="line">[root@control01 ~]# ironic node-list</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">| UUID                                 | Name  | Instance UUID | Power State | Provisioning State | Maintenance |</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">| c78f0257-bfbf-489c-b525-a39e0b924b79 | node1 | None          | power off   | manageable         | False       |</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">[root@control01 ~]# ironic --ironic-api-version 1.20 node-set-provision-state $NODE_UUID provide</div><div class="line">[root@control01 ~]# ironic node-list</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">| UUID                                 | Name  | Instance UUID | Power State | Provisioning State | Maintenance |</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div><div class="line">| c78f0257-bfbf-489c-b525-a39e0b924b79 | node1 | None          | power off   | available          | False       |</div><div class="line">+--------------------------------------+-------+---------------+-------------+--------------------+-------------+</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# ironic node-show c78f0257-bfbf-489c-b525-a39e0b924b79</div><div class="line">+------------------------+-----------------------------------------------------------------------+</div><div class="line">| Property               | Value                                                                 |</div><div class="line">+------------------------+-----------------------------------------------------------------------+</div><div class="line">| chassis_uuid           | None                                                                  |</div><div class="line">| clean_step             | &#123;&#125;                                                                    |</div><div class="line">| console_enabled        | False                                                                 |</div><div class="line">| created_at             | 2017-08-31T01:50:09+00:00                                             |</div><div class="line">| driver                 | pxe_ipmitool_socat                                                    |</div><div class="line">| driver_info            | &#123;u'ipmi_terminal_port': 8901, u'ipmi_username': u'admin',             |</div><div class="line">|                        | u'deploy_kernel': u'99a5c143-e231-4018-a6bf-121585eb6290',            |</div><div class="line">|                        | u'ipmi_address': u'172.18.21.164', u'deploy_ramdisk':                 |</div><div class="line">|                        | u'8c23e3e4-e749-4a91-9af7-63674b5f5128', u'ipmi_password': u'******'&#125; |</div><div class="line">| driver_internal_info   | &#123;&#125;                                                                    |</div><div class="line">| extra                  | &#123;&#125;                                                                    |</div><div class="line">| inspection_finished_at | None                                                                  |</div><div class="line">| inspection_started_at  | None                                                                  |</div><div class="line">| instance_info          | &#123;&#125;                                                                    |</div><div class="line">| instance_uuid          | None                                                                  |</div><div class="line">| last_error             | None                                                                  |</div><div class="line">| maintenance            | False                                                                 |</div><div class="line">| maintenance_reason     | None                                                                  |</div><div class="line">| name                   | node1                                                                 |</div><div class="line">| network_interface      | flat                                                                  |</div><div class="line">| power_state            | power off                                                             |</div><div class="line">| properties             | &#123;u'memory_mb': 129024, u'cpu_arch': u'x86_64', u'local_gb': 120,      |</div><div class="line">|                        | u'cpus': 36&#125;                                                          |</div><div class="line">| provision_state        | available                                                             |</div><div class="line">| provision_updated_at   | 2017-08-31T01:56:55+00:00                                             |</div><div class="line">| raid_config            | &#123;&#125;                                                                    |</div><div class="line">| reservation            | None                                                                  |</div><div class="line">| resource_class         |                                                                       |</div><div class="line">| target_power_state     | None                                                                  |</div><div class="line">| target_provision_state | None                                                                  |</div><div class="line">| target_raid_config     | &#123;&#125;                                                                    |</div><div class="line">| updated_at             | 2017-08-31T01:56:55+00:00                                             |</div><div class="line">| uuid                   | c78f0257-bfbf-489c-b525-a39e0b924b79                                  |</div><div class="line">+------------------------+-----------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<h5 id="检查nova-hypervisor"><a href="#检查nova-hypervisor" class="headerlink" title="检查nova hypervisor"></a>检查nova hypervisor</h5><p>ironic node 添加完成后会新增一个nova hypervisor，通过nova hypervisor-show 可以看到裸机的vcpu,memory,disk 等配置信息。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# nova hypervisor-list</div><div class="line">+----+--------------------------------------+-------+---------+</div><div class="line">| ID | Hypervisor hostname                  | State | Status  |</div><div class="line">+----+--------------------------------------+-------+---------+</div><div class="line">| 4  | control02                            | up    | enabled |</div><div class="line">| 7  | control01                            | up    | enabled |</div><div class="line">| 10 | control03                            | up    | enabled |</div><div class="line">| 58 | c78f0257-bfbf-489c-b525-a39e0b924b79 | up    | enabled |</div><div class="line">+----+--------------------------------------+-------+---------+</div><div class="line">[root@control01 ~]# nova hypervisor-show 58</div><div class="line">+-------------------------+--------------------------------------+</div><div class="line">| Property                | Value                                |</div><div class="line">+-------------------------+--------------------------------------+</div><div class="line">| cpu_info                | &#123;&#125;                                   |</div><div class="line">| current_workload        | 0                                    |</div><div class="line">| disk_available_least    | 120                                  |</div><div class="line">| free_disk_gb            | 120                                  |</div><div class="line">| free_ram_mb             | 129024                               |</div><div class="line">| host_ip                 | 172.18.22.162                        |</div><div class="line">| hypervisor_hostname     | c78f0257-bfbf-489c-b525-a39e0b924b79 |</div><div class="line">| hypervisor_type         | ironic                               |</div><div class="line">| hypervisor_version      | 1                                    |</div><div class="line">| id                      | 58                                   |</div><div class="line">| local_gb                | 120                                  |</div><div class="line">| local_gb_used           | 0                                    |</div><div class="line">| memory_mb               | 129024                               |</div><div class="line">| memory_mb_used          | 0                                    |</div><div class="line">| running_vms             | 0                                    |</div><div class="line">| service_disabled_reason | None                                 |</div><div class="line">| service_host            | control01-ironic                     |</div><div class="line">| service_id              | 103                                  |</div><div class="line">| state                   | up                                   |</div><div class="line">| status                  | enabled                              |</div><div class="line">| vcpus                   | 36                                   |</div><div class="line">| vcpus_used              | 0                                    |</div><div class="line">+-------------------------+--------------------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="创建裸机"><a href="#创建裸机" class="headerlink" title="创建裸机"></a>创建裸机</h3><p>由于目前horizon ironic 部分功能尚未完成，这里先以命令行形式创建虚拟机。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# openstack server create --image 442f0935-33cc-450b-b641-9f438fdcb7ea --flavor 2327b74a-88b4-49f6-a0cd-9a06c13c801a --key-name mykey \</div><div class="line"><span class="meta">&gt;</span><span class="bash">     --nic net-id=f157770d<span class="_">-e</span>81c-41a3-acf1-8<span class="built_in">fc</span>3f4ea7f31 \</span></div><div class="line"><span class="meta">&gt;</span><span class="bash">     --availability-zone nova:control01-ironic <span class="built_in">test</span></span></div><div class="line">+-------------------------------------+------------------------------------------------+</div><div class="line">| Field                               | Value                                          |</div><div class="line">+-------------------------------------+------------------------------------------------+</div><div class="line">| OS-DCF:diskConfig                   | MANUAL                                         |</div><div class="line">| OS-EXT-AZ:availability_zone         | nova                                           |</div><div class="line">| OS-EXT-SRV-ATTR:host                | None                                           |</div><div class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                           |</div><div class="line">| OS-EXT-SRV-ATTR:instance_name       |                                                |</div><div class="line">| OS-EXT-STS:power_state              | NOSTATE                                        |</div><div class="line">| OS-EXT-STS:task_state               | scheduling                                     |</div><div class="line">| OS-EXT-STS:vm_state                 | building                                       |</div><div class="line">| OS-SRV-USG:launched_at              | None                                           |</div><div class="line">| OS-SRV-USG:terminated_at            | None                                           |</div><div class="line">| accessIPv4                          |                                                |</div><div class="line">| accessIPv6                          |                                                |</div><div class="line">| addresses                           |                                                |</div><div class="line">| adminPass                           | YQS2x3r3AyYJ                                   |</div><div class="line">| config_drive                        |                                                |</div><div class="line">| created                             | 2017-08-31T02:01:31Z                           |</div><div class="line">| flavor                              | ironic (2327b74a-88b4-49f6-a0cd-9a06c13c801a)  |</div><div class="line">| hostId                              |                                                |</div><div class="line">| id                                  | 54142f88-8170-4081-a2c0-b8da831a7dd1           |</div><div class="line">| image                               | centos7 (442f0935-33cc-450b-b641-9f438fdcb7ea) |</div><div class="line">| key_name                            | mykey                                          |</div><div class="line">| name                                | test                                           |</div><div class="line">| progress                            | 0                                              |</div><div class="line">| project_id                          | 1345d1d9ddf34ee887fd1c17a4bb02b6               |</div><div class="line">| properties                          |                                                |</div><div class="line">| security_groups                     | name='default'                                 |</div><div class="line">| status                              | BUILD                                          |</div><div class="line">| updated                             | 2017-08-31T02:01:31Z                           |</div><div class="line">| user_id                             | 4b19a4a2173543888ba8460d54d5eebd               |</div><div class="line">| volumes_attached                    |                                                |</div><div class="line">+-------------------------------------+------------------------------------------------+</div></pre></td></tr></table></figure></p>
<h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@control01 ~]# nova list</div><div class="line">+--------------------------------------+----------------------------------------------+--------+------------+-------------+------------------------------+</div><div class="line">| ID                                   | Name                                         | Status | Task State | Power State | Networks                     |</div><div class="line">+--------------------------------------+----------------------------------------------+--------+------------+-------------+------------------------------+</div><div class="line">| 7648bfcf-a2c5-4028-b080-5ab62b218c9a | hadoop-cluster-new-vanilla-default-master1-0 | ACTIVE | -          | Running     | net1=10.10.0.7, 172.18.23.17 |</div><div class="line">| 970c02d3-0d7f-4e83-9866-be0ed25223a2 | hadoop-cluster-new-vanilla-default-worker1-0 | ACTIVE | -          | Running     | net1=10.10.0.10, 172.18.23.8 |</div><div class="line">| e057db81-eeed-40a4-b36c-ecdad7ade378 | hadoop-cluster-new-vanilla-default-worker1-1 | ACTIVE | -          | Running     | net1=10.10.0.6, 172.18.23.28 |</div><div class="line">| b36c5ee6-3b97-4e03-a0ef-f08e1866c0c8 | hadoop-cluster-new-vanilla-default-worker1-2 | ACTIVE | -          | Running     | net1=10.10.0.5               |</div><div class="line">| 54142f88-8170-4081-a2c0-b8da831a7dd1 | test                                         | ACTIVE | -          | Running     | network=172.18.23.11         |</div><div class="line">+--------------------------------------+----------------------------------------------+--------+------------+-------------+------------------------------+</div><div class="line">[root@control01 ~]# ping 172.18.23.11</div><div class="line">PING 172.18.23.11 (172.18.23.11) 56(84) bytes of data.</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=22 ttl=63 time=3.23 ms</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=23 ttl=63 time=0.217 ms</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=24 ttl=63 time=0.223 ms</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=25 ttl=63 time=0.124 ms</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=26 ttl=63 time=0.189 ms</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=27 ttl=63 time=0.195 ms</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=28 ttl=63 time=0.186 ms</div><div class="line">64 bytes from 172.18.23.11: icmp_seq=29 ttl=63 time=0.229 ms</div><div class="line">^C</div><div class="line">--- 172.18.23.11 ping statistics ---</div><div class="line">29 packets transmitted, 8 received, 72% packet loss, time 27999ms</div><div class="line">rtt min/avg/max/mdev = 0.124/0.575/3.239/1.007 ms</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> kolla </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Python中类的定义与使用]]></title>
      <url>/posts/python-class.html</url>
      <content type="html"><![CDATA[<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>　　1.类的定义</p>
<p>　　2.父类，子类定义，以及子类调用父类</p>
<p>　　3.类的组合使用</p>
<p>　　4.内置功能<br><a id="more"></a></p>
<hr>
<h3 id="1-类的定义"><a href="#1-类的定义" class="headerlink" title="1.类的定义"></a>1.类的定义</h3><p>代码如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding:utf8</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hotel</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""docstring for Hotel"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, room, cf=<span class="number">1.0</span>, br=<span class="number">15</span>)</span>:</span></div><div class="line">        self.room = room</div><div class="line">        self.cf = cf</div><div class="line">        self.br = br</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cacl_all</span><span class="params">(self, days=<span class="number">1</span>)</span>:</span></div><div class="line">        <span class="keyword">return</span> (self.room * self.cf + self.br) * days</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    stdroom = Hotel(<span class="number">200</span>)</div><div class="line">    big_room = Hotel(<span class="number">230</span>, <span class="number">0.9</span>)</div><div class="line">    <span class="keyword">print</span> stdroom.cacl_all()</div><div class="line">    <span class="keyword">print</span> stdroom.cacl_all(<span class="number">2</span>)</div><div class="line">    <span class="keyword">print</span> big_room.cacl_all()</div><div class="line">    <span class="keyword">print</span> big_room.cacl_all(<span class="number">3</span>)</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="2-父类、子类以及调用父类"><a href="#2-父类、子类以及调用父类" class="headerlink" title="2.父类、子类以及调用父类"></a>2.父类、子类以及调用父类</h3><p>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="comment"># 父类</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddBook</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, phone)</span>:</span></div><div class="line">        self.name = name</div><div class="line">        self.phone = phone</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_phone</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.phone</div><div class="line"></div><div class="line"><span class="comment"># 子类，继承</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmplEmail</span><span class="params">(AddBook)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, nm, ph, email)</span>:</span></div><div class="line">        <span class="comment"># AddBook.__init__(self, nm, ph) # 调用父类方法一</span></div><div class="line">        super(EmplEmail, self).__init__(nm, ph) <span class="comment"># 调用父类方法二</span></div><div class="line">        self.email = email</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_email</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.email</div><div class="line"></div><div class="line"><span class="comment"># 调用</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    Detian = AddBook(<span class="string">'handetian'</span>, <span class="string">'18210413001'</span>)</div><div class="line">    Meng = AddBook(<span class="string">'shaomeng'</span>, <span class="string">'18210413002'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> Detian.get_phone()</div><div class="line">    <span class="keyword">print</span> AddBook.get_phone(Meng)</div><div class="line"></div><div class="line">    alice = EmplEmail(<span class="string">'alice'</span>, <span class="string">'18210418888'</span>, <span class="string">'alice@xkops.com'</span>)</div><div class="line">    <span class="keyword">print</span> alice.get_email(), alice.get_phone()</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-类的组合使用"><a href="#3-类的组合使用" class="headerlink" title="3.类的组合使用"></a>3.类的组合使用</h3><p>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">1.class类的组合使用</div><div class="line">2.手机、邮箱、QQ等是可以变化的（定义在一起），姓名不可变（单独定义）。</div><div class="line">3.在另一个类中引用</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, phone, email, qq)</span>:</span></div><div class="line">        self.phone = phone</div><div class="line">        self.email = email</div><div class="line">        self.qq = qq</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_phone</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.phone</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_phone</span><span class="params">(self, newphone)</span>:</span></div><div class="line">        self.phone = newphone</div><div class="line">        <span class="keyword">print</span> <span class="string">"手机号更改已更改"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_email</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.email</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddrBook</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">'''docstring for AddBook'''</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, phone, email, qq)</span>:</span></div><div class="line">        self.name = name</div><div class="line">        self.info = Info(phone, email, qq)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    Detian = AddrBook(<span class="string">'handetian'</span>, <span class="string">'18210413001'</span>, <span class="string">'detian@xkops.com'</span>, <span class="string">'123456'</span>)</div><div class="line">    <span class="keyword">print</span> Detian.info.get_phone()</div><div class="line">    Detian.info.update_phone(<span class="number">18210413002</span>)</div><div class="line">    <span class="keyword">print</span> Detian.info.get_phone()</div><div class="line">    <span class="keyword">print</span> Detian.info.get_email()</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="4-内置功能-函数（）加与不加的区别）"><a href="#4-内置功能-函数（）加与不加的区别）" class="headerlink" title="4.内置功能(函数（）加与不加的区别）"></a>4.内置功能(函数（）加与不加的区别）</h3><p>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding:utf8</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, title, author)</span>:</span></div><div class="line">        self.title = title</div><div class="line">        self.author = author</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.title</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.title</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"%s is written by %s"</span> %(self.title, self.author)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    pybook = Books(<span class="string">'Core Python'</span>, <span class="string">'Wesley'</span>)</div><div class="line">    <span class="keyword">print</span> pybook</div><div class="line">    pybook()</div></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding:utf8</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, title, author)</span>:</span></div><div class="line">        self.title = title</div><div class="line">        self.author = author</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.title</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.title</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"%s is written by %s"</span> %(self.title, self.author)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    pybook = Books(<span class="string">'Core Python'</span>, <span class="string">'Wesley'</span>)</div><div class="line">    <span class="keyword">print</span> pybook</div><div class="line">    pybook()</div><div class="line">复制代码</div><div class="line">复制代码</div><div class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="line"></div><div class="line">复制代码</div><div class="line">复制代码</div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding:utf8</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Number</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Custum object</span></div><div class="line">    add/radd -&gt; +; </div><div class="line">    sub/rsub -&gt; -;</div><div class="line">    mul/rmul -&gt; *;</div><div class="line">    div/rdiv -&gt; /;</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, number)</span>:</span></div><div class="line">        self.number = number</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.number + other        </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__radd__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.number  + other</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.number - other</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rsub__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">return</span> other - self.number</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.number &gt; other:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    num = Number(<span class="number">10</span>)</div><div class="line">    <span class="keyword">print</span> num + <span class="number">20</span></div><div class="line">    <span class="keyword">print</span> <span class="number">30</span> + num</div><div class="line">    <span class="keyword">print</span> num - <span class="number">5</span></div><div class="line">    <span class="keyword">print</span> <span class="number">11</span> - num</div><div class="line">    <span class="keyword">print</span> num &gt; <span class="number">20</span></div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 类 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[基于CentOS 7.3 安装Ceph Jewel 10.2.9]]></title>
      <url>/posts/intsall-ceph.html</url>
      <content type="html"><![CDATA[<h3 id="基于CentOS-7-3-安装Ceph-Jewel-10-2-9"><a href="#基于CentOS-7-3-安装Ceph-Jewel-10-2-9" class="headerlink" title="基于CentOS 7.3 安装Ceph Jewel 10.2.9"></a>基于<code>CentOS 7.3</code> 安装<code>Ceph Jewel 10.2.9</code></h3><a id="more"></a>
<h3 id="网络架构图"><a href="#网络架构图" class="headerlink" title="网络架构图"></a>网络架构图</h3><p><img src="https://ljw.howieli.cn/blog/2017-7-18/ceph-top.png" alt=""></p>
<h3 id="节点信息配置"><a href="#节点信息配置" class="headerlink" title="节点信息配置"></a>节点信息配置</h3><p><img src="https://ljw.howieli.cn/blog/2017-7-18/ceph-lab-configure.png" alt=""></p>
<h3 id="配置说明："><a href="#配置说明：" class="headerlink" title="配置说明："></a>配置说明：</h3><blockquote>
<p>采用了4台centos7.3系统的虚拟机，1台Ceph-Master作为安装节点，NTP Server；3台Ceph节点，既作为OSD节点，也作为Monitor节点。每个OSD节点有6个盘：300G的系统盘，3个2TB作为SATA池的OSD，800GB作为SSD池的OSD，240GB SSD盘作为日志盘。</p>
</blockquote>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>这里安装centos7.3的操作系统我就不多说了，下面我说一下环境准备工作。</p>
<p>1.检查操作系统的版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cat /etc/redhat-release</span></div><div class="line">CentOS Linux release 7.3.1611 (Core)</div></pre></td></tr></table></figure></p>
<p>2.查看系统内核版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> uname -r</span></div><div class="line">3.10.0-514.26.2.el7.x86_64</div></pre></td></tr></table></figure></p>
<p>3.关闭防火墙和<code>selinux</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</div><div class="line">setenforce 0</div><div class="line">systemctl stop firewalld</div><div class="line">systemctl disable firewalld</div></pre></td></tr></table></figure></p>
<p>4.查看设备信息（所有的<code>OSD</code>节点）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> lsblk</span></div><div class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</div><div class="line">sda           8:0    0  300G  0 disk </div><div class="line">├─sda1        8:1    0    1G  0 part /boot</div><div class="line">└─sda2        8:2    0  299G  0 part </div><div class="line">  ├─cl-root 253:0    0   50G  0 lvm  /</div><div class="line">  ├─cl-swap 253:1    0    2G  0 lvm  [SWAP]</div><div class="line">  └─cl-home 253:2    0  247G  0 lvm  /home</div><div class="line">sdb           8:16   0    2T  0 disk </div><div class="line">sdc           8:32   0    2T  0 disk </div><div class="line">sdd           8:48   0    2T  0 disk </div><div class="line">sde           8:64   0  800G  0 disk </div><div class="line">sdf           8:80   0  240G  0 disk </div><div class="line">sr0          11:0    1 1024M  0 rom</div></pre></td></tr></table></figure></p>
<p>5.查看网卡配置（所有<code>OSD</code>节点）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ip a</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:06:c8:a4 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 172.16.0.11/24 brd 172.16.0.255 scope global eth0</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:06:c8:ae brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.0.11/24 brd 192.168.0.255 scope global eth1</div><div class="line">       valid_lft forever preferred_lft forever</div></pre></td></tr></table></figure></p>
<p>6.在所有节点配置<code>hosts</code>解析<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">172.16.0.10 ceph-master</div><div class="line">172.16.0.11 ceph-node-1</div><div class="line">172.16.0.12 ceph-node-2</div><div class="line">172.16.0.13 ceph-node-3</div></pre></td></tr></table></figure></p>
<p>7.安装基础的软件包(所有节点)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install tree nmap sysstat lrzsz dos2unix wegt git net-tools -y</div></pre></td></tr></table></figure></p>
<p>8.建立<code>SSH</code>通信（在<code>ceph-master</code>节点上执行）<br>（1）生成秘钥文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa</div></pre></td></tr></table></figure></p>
<p>（2）拷贝秘钥文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ssh-copy-id root@ceph-master</div><div class="line">ssh-copy-id root@ceph-node-1</div><div class="line">ssh-copy-id root@ceph-node-2</div><div class="line">ssh-copy-id root@ceph-node-3</div></pre></td></tr></table></figure></p>
<p>环境准备基本完成</p>
<h3 id="配置NTP服务"><a href="#配置NTP服务" class="headerlink" title="配置NTP服务"></a>配置<code>NTP</code>服务</h3><p>首先我们要在所有的节点上安装<code>NTP</code>服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install -y ntp</span></div></pre></td></tr></table></figure></p>
<h4 id="在ceph-master节点上配置"><a href="#在ceph-master节点上配置" class="headerlink" title="在ceph-master节点上配置"></a>在<code>ceph-master</code>节点上配置</h4><p>1.修改<code>NTP</code>配置文件<code>/etc/ntp.conf</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/ntp.conf</span></div><div class="line"><span class="meta">#</span><span class="bash">server 0.centos.pool.ntp.org iburst</span></div><div class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></div><div class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></div><div class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></div><div class="line">restrict 172.16.0.0 mask 255.255.255.0 nomodify notrap</div><div class="line">server 127.127.1.0 minpoll 4</div><div class="line">fudge 127.127.1.0 stratum 0</div></pre></td></tr></table></figure></p>
<p>2.修改配置文件<code>/etc/ntp/step-tickers</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/ntp/step-tickers</span></div><div class="line"><span class="meta">#</span><span class="bash">0.centos.pool.ntp.org</span></div><div class="line">127.127.1.0</div></pre></td></tr></table></figure></p>
<p>3.启动<code>NTP</code>服务，并设置开机启动<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl enable ntpd ; systemctl start ntpd</div></pre></td></tr></table></figure></p>
<h4 id="在所有的OSD节点配置"><a href="#在所有的OSD节点配置" class="headerlink" title="在所有的OSD节点配置"></a>在所有的<code>OSD</code>节点配置</h4><p>1.修改NTP配置文件<code>/etc/ntp.conf</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/ntp.conf</span></div><div class="line"><span class="meta">#</span><span class="bash">server 0.centos.pool.ntp.org iburst</span></div><div class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></div><div class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></div><div class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></div><div class="line">server 172.16.0.10</div></pre></td></tr></table></figure></p>
<p>2.启动<code>NTP</code>服务，并设置开机启动<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl enable ntpd ; systemctl start ntpd</div></pre></td></tr></table></figure></p>
<h4 id="验证NTP"><a href="#验证NTP" class="headerlink" title="验证NTP"></a>验证<code>NTP</code></h4><p>在所有节点执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ntpq -p</span></div><div class="line"></div><div class="line">     remote           refid      st t when poll reach   delay   offset  jitter</div><div class="line">==============================================================================</div><div class="line">*ceph-master     .LOCL.           1 u   16   64  377    0.269    0.032   0.269</div></pre></td></tr></table></figure></p>
<p>前面有 * 表示已经同步。</p>
<h3 id="安装ceph"><a href="#安装ceph" class="headerlink" title="安装ceph"></a>安装<code>ceph</code></h3><p>####跟新系统源(所有节点执行)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rm -rf /etc/yum.repos.d/*.repo</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</div><div class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</div><div class="line">sed -i '/aliyuncs/d' /etc/yum.repos.d/CentOS-Base.repo</div><div class="line">sed -i 's/$releasever/7/g' /etc/yum.repos.d/CentOS-Base.repo</div><div class="line">sed -i '/aliyuncs/d' /etc/yum.repos.d/epel.repo</div><div class="line">yum clean all</div><div class="line">yum makecache fast</div></pre></td></tr></table></figure></p>
<h4 id="安装ceph-deploy"><a href="#安装ceph-deploy" class="headerlink" title="安装ceph-deploy"></a>安装<code>ceph-deploy</code></h4><p>以下在<code>ceph-master</code>节点上执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install http://mirrors.163.com/ceph/rpm-jewel/el7/noarch/ceph-deploy-1.5.38-0.noarch.rpm</span></div></pre></td></tr></table></figure></p>
<h4 id="查看ceph-deploy版本"><a href="#查看ceph-deploy版本" class="headerlink" title="查看ceph-deploy版本"></a>查看<code>ceph-deploy</code>版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph-deploy --version</span></div><div class="line">1.5.38</div></pre></td></tr></table></figure>
<h4 id="创建ceph集群"><a href="#创建ceph集群" class="headerlink" title="创建ceph集群"></a>创建<code>ceph</code>集群</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ceph-deploy new ceph-node-1 ceph-node-2 ceph-node-3</div></pre></td></tr></table></figure>
<h4 id="编辑ceph配置文件"><a href="#编辑ceph配置文件" class="headerlink" title="编辑ceph配置文件"></a>编辑<code>ceph</code>配置文件</h4><p>在<code>global</code>下添加以下配置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim ceph.conf </span></div><div class="line">[global]</div><div class="line">mon_clock_drift_allowed = 5</div><div class="line">osd_journal_size = 20480</div><div class="line">public_network=172.16.0.0/24</div></pre></td></tr></table></figure></p>
<h4 id="安装Ceph"><a href="#安装Ceph" class="headerlink" title="安装Ceph"></a>安装<code>Ceph</code></h4><p>直接指定源地址，不用担心<code>ceph.com</code>官方源无法下载了。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ceph-deploy install --release jewel --repo-url http://mirrors.163.com/ceph/rpm-jewel/el7 --gpg-url http://mirrors.163.com/ceph/keys/release.asc ceph-master ceph-node-1 ceph-node-2 ceph-node-3</div></pre></td></tr></table></figure></p>
<h4 id="检查ceph版本"><a href="#检查ceph版本" class="headerlink" title="检查ceph版本"></a>检查<code>ceph</code>版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ceph -v</div><div class="line">ceph version 10.2.9 (2ee413f77150c0f375ff6f10edd6c8f9c7d060d0)</div></pre></td></tr></table></figure>
<h4 id="初始化mom节点"><a href="#初始化mom节点" class="headerlink" title="初始化mom节点"></a>初始化<code>mom</code>节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ceph-deploy mon create-initial</div></pre></td></tr></table></figure>
<h4 id="查看集群状态（在OSD节点上查看）"><a href="#查看集群状态（在OSD节点上查看）" class="headerlink" title="查看集群状态（在OSD节点上查看）"></a>查看集群状态（在<code>OSD</code>节点上查看）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph <span class="_">-s</span></span></div><div class="line">    cluster 60597e53-ad29-44bd-8dcd-db6aeae6f580</div><div class="line">     health HEALTH_ERR</div><div class="line">            no osds</div><div class="line">     monmap e2: 3 mons at &#123;ceph-node-1=172.16.0.11:6789/0,ceph-node-2=172.16.0.12:6789/0,ceph-node-3=172.16.0.13:6789/0&#125;</div><div class="line">            election epoch 6, quorum 0,1,2 ceph-node-1,ceph-node-2,ceph-node-3</div><div class="line">     osdmap e1: 0 osds: 0 up, 0 in</div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v2: 64 pgs, 1 pools, 0 bytes data, 0 objects</div><div class="line">            0 kB used, 0 kB / 0 kB avail</div><div class="line">                  64 creating</div></pre></td></tr></table></figure>
<h3 id="配置管理节点ceph-master"><a href="#配置管理节点ceph-master" class="headerlink" title="配置管理节点ceph-master"></a>配置管理节点<code>ceph-master</code></h3><p>为什么每次查看<code>ceph –s</code>的只能在<code>OSD</code>节点上执行，而不能在<code>Master</code>节点上执行？<br>用<code>ceph-deploy</code>把配置文件和<code>admin</code>密钥拷贝到<code>Master</code>节点<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph-deploy admin ceph-master</span></div></pre></td></tr></table></figure></p>
<p>确保你对<code>ceph.client.admin.keyring</code>有正确的操作权限<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> chmod +r /etc/ceph/ceph.client.admin.keyring</span></div></pre></td></tr></table></figure></p>
<p>检查集群的健康状况<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph <span class="_">-s</span></span></div><div class="line">    cluster 60597e53-ad29-44bd-8dcd-db6aeae6f580</div><div class="line">     health HEALTH_ERR</div><div class="line">            no osds</div><div class="line">     monmap e2: 3 mons at &#123;ceph-node-1=172.16.0.11:6789/0,ceph-node-2=172.16.0.12:6789/0,ceph-node-3=172.16.0.13:6789/0&#125;</div><div class="line">            election epoch 6, quorum 0,1,2 ceph-node-1,ceph-node-2,ceph-node-3</div><div class="line">     osdmap e1: 0 osds: 0 up, 0 in</div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v2: 64 pgs, 1 pools, 0 bytes data, 0 objects</div><div class="line">            0 kB used, 0 kB / 0 kB avail</div><div class="line">                  64 creating</div></pre></td></tr></table></figure></p>
<h3 id="对OSD节点配置"><a href="#对OSD节点配置" class="headerlink" title="对OSD节点配置"></a>对<code>OSD</code>节点配置</h3><h4 id="磁盘分区"><a href="#磁盘分区" class="headerlink" title="磁盘分区"></a>磁盘分区</h4><p>将<code>240G</code>的<code>SSD</code>盘分出<code>4</code>个<code>20G</code>的分区用作 <code>journal</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> fdisk /dev/sdf</span></div><div class="line">Welcome to fdisk (util-linux 2.23.2).</div><div class="line">Changes will remain in memory only, until you decide to write them.</div><div class="line">Be careful before using the write command.</div><div class="line">Device does not contain a recognized partition table</div><div class="line">Building a new DOS disklabel with disk identifier 0x9ec0a047.</div><div class="line">Command (m for help): g</div><div class="line">Building a new GPT disklabel (GUID: 31D328DD-E9A0-4306-9C99-8D42F7BA8008)</div><div class="line">Command (m for help): n</div><div class="line">Partition number (1-128, default 1): </div><div class="line">First sector (2048-503316446, default 2048): </div><div class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (2048-503316446, default 503316446): +20G</div><div class="line">Created partition 1</div><div class="line">Command (m for help): n</div><div class="line">Partition number (2-128, default 2): </div><div class="line">First sector (41945088-503316446, default 41945088): </div><div class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (41945088-503316446, default 503316446): +20G</div><div class="line">Created partition 2</div><div class="line">Command (m for help): n</div><div class="line">Partition number (3-128, default 3): </div><div class="line">First sector (83888128-503316446, default 83888128): </div><div class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (83888128-503316446, default 503316446): +20G</div><div class="line">Created partition 3</div><div class="line">Command (m for help): n</div><div class="line">Partition number (4-128, default 4): </div><div class="line">First sector (125831168-503316446, default 125831168): </div><div class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (125831168-503316446, default 503316446): +20G</div><div class="line">Created partition 4</div><div class="line">Command (m for help): p</div><div class="line">Disk /dev/sdf: 257.7 GB, 257698037760 bytes, 503316480 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk label type: gpt</div><div class="line"><span class="meta">#</span><span class="bash">         Start          End    Size  Type            Name</span></div><div class="line"> 1         2048     41945087     20G  Linux filesyste </div><div class="line"> 2     41945088     83888127     20G  Linux filesyste </div><div class="line"> 3     83888128    125831167     20G  Linux filesyste </div><div class="line"> 4    125831168    167774207     20G  Linux filesyste </div><div class="line">Command (m for help): w</div><div class="line">The partition table has been altered!</div><div class="line">Calling ioctl() to re-read partition table.</div><div class="line">Syncing disks.</div></pre></td></tr></table></figure></p>
<h4 id="查看分区"><a href="#查看分区" class="headerlink" title="查看分区"></a>查看分区</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> lsblk</span></div><div class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</div><div class="line">sda           8:0    0  300G  0 disk </div><div class="line">├─sda1        8:1    0    1G  0 part /boot</div><div class="line">└─sda2        8:2    0  299G  0 part </div><div class="line">  ├─cl-root 253:0    0   50G  0 lvm  /</div><div class="line">  ├─cl-swap 253:1    0    2G  0 lvm  [SWAP]</div><div class="line">  └─cl-home 253:2    0  247G  0 lvm  /home</div><div class="line">sdb           8:16   0    2T  0 disk </div><div class="line">sdc           8:32   0    2T  0 disk </div><div class="line">sdd           8:48   0    2T  0 disk </div><div class="line">sde           8:64   0  800G  0 disk </div><div class="line">sdf           8:80   0  240G  0 disk </div><div class="line">├─sdf1        8:81   0   20G  0 part </div><div class="line">├─sdf2        8:82   0   20G  0 part </div><div class="line">├─sdf3        8:83   0   20G  0 part </div><div class="line">└─sdf4        8:84   0   20G  0 part </div><div class="line">sr0          11:0    1 1024M  0 rom</div></pre></td></tr></table></figure>
<h4 id="修改-Journal-分区权限"><a href="#修改-Journal-分区权限" class="headerlink" title="修改 Journal 分区权限"></a>修改 <code>Journal</code> 分区权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chown ceph:ceph /dev/sdf[1-4]</div></pre></td></tr></table></figure>
<h3 id="添加OSD"><a href="#添加OSD" class="headerlink" title="添加OSD"></a>添加<code>OSD</code></h3><p>在<code>ceph-master</code>执行<br>先部署<code>SATA</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ceph-deploy osd prepare ceph-node-1:/dev/sdb:/dev/sdf1 ceph-node-1:/dev/sdc:/dev/sdf2 ceph-node-1:/dev/sdd:/dev/sdf3 ceph-node-2:/dev/sdb:/dev/sdf1 ceph-node-2:/dev/sdc:/dev/sdf2 ceph-node-2:/dev/sdd:/dev/sdf3 ceph-node-3:/dev/sdb:/dev/sdf1 ceph-node-3:/dev/sdc:/dev/sdf2 ceph-node-3:/dev/sdd:/dev/sdf3</div></pre></td></tr></table></figure></p>
<p>再部署<code>SSD</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ceph-deploy osd prepare ceph-node-1:/dev/sde:/dev/sdf4 ceph-node-2:/dev/sde:/dev/sdf4 ceph-node-3:/dev/sde:/dev/sdf4</div></pre></td></tr></table></figure></p>
<p>先部署<code>SATA</code>，再部署<code>SSD</code>，这样序号就会连续了…<br>查看集群状态<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph <span class="_">-s</span></span></div><div class="line">    cluster f9dba93b-c40f-4b31-8e6d-6ea830cad944</div><div class="line">     health HEALTH_OK</div><div class="line">     monmap e1: 3 mons at &#123;ceph-node-1=172.16.0.11:6789/0,ceph-node-2=172.16.0.12:6789/0,ceph-node-3=172.16.0.13:6789/0&#125;</div><div class="line">            election epoch 6, quorum 0,1,2 ceph-node-1,ceph-node-2,ceph-node-3</div><div class="line">     osdmap e56: 12 osds: 12 up, 12 in</div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v142: 128 pgs, 1 pools, 0 bytes data, 0 objects</div><div class="line">            413 MB used, 20821 GB / 20821 GB avail</div><div class="line">                 128 active+clean</div></pre></td></tr></table></figure></p>
<p>查看<code>OSD</code>的分布<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ceph osd tree</span></div><div class="line">ID WEIGHT   TYPE NAME            UP/DOWN REWEIGHT PRIMARY-AFFINITY </div><div class="line">-1 20.33363 root default                                           </div><div class="line">-2  6.77788     host ceph-node-1                                   </div><div class="line"> 0  1.99899         osd.0             up  1.00000          1.00000 </div><div class="line"> 1  1.99899         osd.1             up  1.00000          1.00000 </div><div class="line"> 4  1.99899         osd.4             up  1.00000          1.00000 </div><div class="line"> 9  0.78090         osd.9             up  1.00000          1.00000 </div><div class="line">-3  6.77788     host ceph-node-2                                   </div><div class="line"> 2  1.99899         osd.2             up  1.00000          1.00000 </div><div class="line"> 3  1.99899         osd.3             up  1.00000          1.00000 </div><div class="line"> 5  1.99899         osd.5             up  1.00000          1.00000 </div><div class="line">10  0.78090         osd.10            up  1.00000          1.00000 </div><div class="line">-4  6.77788     host ceph-node-3                                   </div><div class="line"> 6  1.99899         osd.6             up  1.00000          1.00000 </div><div class="line"> 7  1.99899         osd.7             up  1.00000          1.00000 </div><div class="line"> 8  1.99899         osd.8             up  1.00000          1.00000 </div><div class="line">11  0.78090         osd.11            up  1.00000          1.00000</div></pre></td></tr></table></figure></p>
<h3 id="安装完毕"><a href="#安装完毕" class="headerlink" title="安装完毕"></a>安装完毕</h3><p><code>ceph</code>安装完毕</p>
]]></content>
      
        <categories>
            
            <category> ceph </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ceph </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[openstack新建云主机流程介绍]]></title>
      <url>/posts/openstack-nova.html</url>
      <content type="html"><![CDATA[<h3 id="openstack新建云主机流程介绍"><a href="#openstack新建云主机流程介绍" class="headerlink" title="openstack新建云主机流程介绍"></a><code>openstack</code>新建云主机流程介绍</h3><a id="more"></a>
<p><code>openstack</code> 可以登录到你的<code>dashboard</code>上之后点击“项目-计算-实例-创建实例”按钮，然后选择一下相应的配置，只短短十几秒内就可以创建好一台云主机供我们使用了，然而这么牛逼的事情是怎么做到的呢？<br>新建一个云主机流程图<br><img src="https://ljw.howieli.cn/blog/2017-7-3/%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<p>上图我们可以看出要想新建一台完整的云主机至少需要29步。</p>
<h3 id="流程图分析"><a href="#流程图分析" class="headerlink" title="流程图分析"></a>流程图分析</h3><h4 id="流程-1"><a href="#流程-1" class="headerlink" title="流程-1"></a>流程-1</h4><p>首先我们访问<code>dashboard</code>之后，浏览器会显示一个登陆界面（如下图所示），<code>horizon</code>会让我们登陆用户名和密码，然后<code>horizon</code>会把用户名和密码交给<code>keystone</code>来确认我们的身份，<code>keystone</code>确认成功后，才会允许我们登陆进去。（在<code>openstack</code>里<code>keystone</code>就相当于<code>openstack</code>这些组件共同的老大哥）<br><img src="https://ljw.howieli.cn/blog/2017-7-3/%E7%99%BB%E9%99%86%E7%95%8C%E9%9D%A2.png" alt=""><br>在原来我一直以为这里登陆的时候只不过是一个简单的<code>django</code>框架使用<code>pymysql</code>直接查询数据库，而实际上这里的表单信息是提交到了<code>keystone</code>，然后通过<code>keystone</code>查询数据库进行验证的</p>
<h4 id="流程-2"><a href="#流程-2" class="headerlink" title="流程-2"></a>流程-2</h4><p><code>keystone</code>接受到<code>horizon</code>前端表单传过来的用户、密码信息以后，会去查询数据库来确认身份，确认了身份后会将一个<code>token</code>（就相当于办理了一个身份证~~~~）返回到该用户，让这个用户在进行操作的时候不在需要提供用户名和密码了，而是直接拿出<code>token</code>来。</p>
<h4 id="流程-3"><a href="#流程-3" class="headerlink" title="流程-3"></a>流程-3</h4><p><code>horizon</code>拿到<code>token</code>之后，实际上这里在<code>web</code>页面上的显示就是登陆成功了，接下来就是找到“项目-计算-实例-创建实例”按钮，点击创建实例，然后根据我们的需求填写云主机相关的配置信息。<br>填写完配置信息后，点击启动实例之后，<code>horizon</code>就会带着三个东西去找<code>nova-api</code>了。</p>
<ul>
<li>创建云主机的请求</li>
<li>云主机相关配置信息</li>
<li>刚刚<code>keystone</code>返回给的<code>token</code></li>
</ul>
<h4 id="流程-4"><a href="#流程-4" class="headerlink" title="流程-4"></a>流程-4</h4><p><code>nova-api</code>会拿着<code>horizon</code>给的<code>token</code>去找老大哥<code>keystone</code>验证去。</p>
<h4 id="流程-5"><a href="#流程-5" class="headerlink" title="流程-5"></a>流程-5</h4><p><code>keystone</code>看到<code>nova-api</code>拿来的<code>token</code>，查询一下数据库确认，然后告诉给<code>nova-api</code>，这兄弟信得过，可以照他的安排去做。</p>
<h4 id="流程-6"><a href="#流程-6" class="headerlink" title="流程-6"></a>流程-6</h4><p><code>nova-api</code>从大哥那回来，接收了<code>horizon</code>提供的两样东西，一是云主机配置信息，二是创建请求，这<code>nova-api</code>手底下也有一帮小兄弟，这帮人之间沟通可不太方便都得通过一块小黑板（<code>mq</code>消息队列），把自己的需求写在小黑板上，能做的了这事的人自然就去做了。但配置信息现在还不能写在小黑板上，得找到确定去干活的人之后才行啊，所以<code>nova-api</code>就把配置信息放到数据库里。</p>
<h4 id="流程-7"><a href="#流程-7" class="headerlink" title="流程-7"></a>流程-7</h4><p>数据库把配置信息收好之后，对<code>nova-api</code>说了声，我放好了。</p>
<h4 id="流程-8"><a href="#流程-8" class="headerlink" title="流程-8"></a>流程-8</h4><p>放好配置信息后<code>nova-api</code>就在小黑板上写“现在要创建一台云主机，配置信息我已经放到数据库了，然后让<code>nova-schedular</code>给安排。</p>
<h4 id="流程-9"><a href="#流程-9" class="headerlink" title="流程-9"></a>流程-9</h4><p><code>nova-schedular</code>他就像是<code>nova-api</code>的秘书，<code>nova-api</code>的有事都是通过它交代给其他人的，这一步就是他从小黑板上看到了<code>nova-api</code>的信息。</p>
<h4 id="流程-10"><a href="#流程-10" class="headerlink" title="流程-10"></a>流程-10</h4><p><code>nova-schedular</code>现在知道了要创建云主机，但它要看一看云主机都要什么配置，才好决定该把这事交给谁去做（这里是指多个<code>nova-compute</code>的情况，各个计算节点的资源使用情况都在<code>nova-schedular</code>这里），所以他让数据库把云主机配置信息发给他看看。</p>
<h4 id="流程-11"><a href="#流程-11" class="headerlink" title="流程-11"></a>流程-11</h4><p>数据库收到请求之后，把云主机配置信息发给<code>nova-schedular</code>。</p>
<h4 id="流程-12"><a href="#流程-12" class="headerlink" title="流程-12"></a>流程-12</h4><p><code>nova-schedular</code>拿到配置信息后，使用调度算法决定了要让<code>nova-compute</code>去干这个事，就在小黑板上写“<code>nova-compute</code>你给创建个云主机，配置都在数据库里了”。</p>
<h4 id="流程-13"><a href="#流程-13" class="headerlink" title="流程-13"></a>流程-13</h4><p><code>nova-compute</code>看到小黑板上的东西之后，本应该直接去数据库拿取配置信息，但因为<code>nova-compute</code>的特殊身份，<code>nova-compute</code>所在计算节点上全是云主机，万一有一台云主机被黑客入侵从而控制计算节点，直接拖库是很危险的。所以不能让<code>nova-compute</code>知道数据库在什么地方。</p>
<h4 id="流程-14"><a href="#流程-14" class="headerlink" title="流程-14"></a>流程-14</h4><p><code>nova-compute</code>没办法去数据库取东西难道就不工作了吗？那可不行啊，他不知道去哪取，但他哥们知道啊，于是他在小黑板上写“<code>nova-conductor</code>，你帮我去数据库取一下配置信息”。</p>
<h4 id="流程-15"><a href="#流程-15" class="headerlink" title="流程-15"></a>流程-15</h4><p><code>nova-conductor</code>从小黑板上看到了<code>nova-compute</code>的请求。</p>
<h4 id="流程-16"><a href="#流程-16" class="headerlink" title="流程-16"></a>流程-16</h4><p><code>nova-conductor</code>告诉数据库我要查看某某云主机的配置信息。</p>
<h4 id="流程-17"><a href="#流程-17" class="headerlink" title="流程-17"></a>流程-17</h4><p>数据库把云主机配置信息发送给<code>nova-conductor</code>。</p>
<h4 id="流程-18"><a href="#流程-18" class="headerlink" title="流程-18"></a>流程-18</h4><p><code>nova-conductor</code>把配置信息写在小黑板上。</p>
<h4 id="流程-19"><a href="#流程-19" class="headerlink" title="流程-19"></a>流程-19</h4><p><code>nova-compute</code>从小黑板上读取云主机的配置信息。</p>
<h4 id="流程-20"><a href="#流程-20" class="headerlink" title="流程-20"></a>流程-20</h4><p><code>nova-compute</code>拿到了云主机配置信息一看，人家可是专业的，立马就知道该怎么做了，先去找<code>glance-api</code>拿镜像吧，刚才讲了那么多，可都是在<code>nova</code>组件内部的，这次去找别的组件可不是写在小黑板上了，它得带着自己的身份证去，告诉<code>glance-api</code>，我要<code>xxx</code>镜像。</p>
<h4 id="流程-21"><a href="#流程-21" class="headerlink" title="流程-21"></a>流程-21</h4><p><code>glance-api</code>看<code>nova-compute</code>过来，他可不认识<code>nova-compute</code>，让<code>nova-compute</code>拿出身份证，拿着人家身份证找到自己的老大哥<code>keystone</code>看看这人靠不靠谱，<code>keystone</code>一看，没问题，按他说的做吧（在<code>nova</code>验证<code>horizon</code>被当做两步，这里化做一步，是为了简化重复的流程）。</p>
<h4 id="流程-22"><a href="#流程-22" class="headerlink" title="流程-22"></a>流程-22</h4><p><code>glance-api</code>把镜像资源信息返回给<code>nova-compute</code>（这里主要说创建云主机的过程，除<code>nova</code>外其他组件内部先不提）。</p>
<h4 id="流程-23"><a href="#流程-23" class="headerlink" title="流程-23"></a>流程-23</h4><p>接着<code>nova-compute</code>找到<code>neutron-server</code>（图里画错了，因为是偷别人的图，自己的图画了半天画不好。。。），告诉他我要<code>xxx</code>网络资源。</p>
<h4 id="流程-24"><a href="#流程-24" class="headerlink" title="流程-24"></a>流程-24</h4><p><code>neutron-server</code>也不认识他，拿着他的身份证找<code>keystone</code>确认了一下身份。</p>
<h4 id="流程-25"><a href="#流程-25" class="headerlink" title="流程-25"></a>流程-25</h4><p><code>nuetron-server</code>把网络资源信息返回给<code>nova-compute</code>。</p>
<h4 id="流程-26"><a href="#流程-26" class="headerlink" title="流程-26"></a>流程-26</h4><p><code>nova-compute</code>找到<code>cinder-api</code>要存储资源，云主机得有硬盘啊，得存东西啊（同样，这里图中也有错误）。</p>
<h4 id="流程-27"><a href="#流程-27" class="headerlink" title="流程-27"></a>流程-27</h4><p><code>cinder-api</code>也不认识他，拿着他的身份证找<code>keystone</code>确认了一下身份。</p>
<h4 id="流程-28"><a href="#流程-28" class="headerlink" title="流程-28"></a>流程-28</h4><p><code>cinder-api</code>把存储资源信息返回给<code>nova-compute</code>。</p>
<h4 id="流程-29"><a href="#流程-29" class="headerlink" title="流程-29"></a>流程-29</h4><p><code>nova-compute</code>拿到了所有资源之后，他其实也只是个收集信息的，他把工作全都交给了真正创建虚拟机的<code>Hypervisor</code>（<code>kvm</code>，<code>xen</code>等虚拟化技术）。</p>
<p>到此为止，你已经拥有了一台云主机了，流程看似复杂实际上在几十秒就完成了。</p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[openstack镜像格式转换与上传]]></title>
      <url>/posts/openstack-image.html</url>
      <content type="html"><![CDATA[<h3 id="openstack镜像格式转换与上传"><a href="#openstack镜像格式转换与上传" class="headerlink" title="openstack镜像格式转换与上传"></a><code>openstack</code>镜像格式转换与上传</h3><a id="more"></a>
<h3 id="openstack常用镜像格式"><a href="#openstack常用镜像格式" class="headerlink" title="openstack常用镜像格式"></a><code>openstack</code>常用镜像格式</h3><p>今天我给大家介绍一下<code>openstack</code>常用的三种镜像格式，三种镜像格式分别是<code>qcow2</code>、<code>raw</code>、<code>vmdk</code>(所谓的<code>vmdk</code>就是<code>vmware</code>虚拟化的镜像格式，只有<code>openstack</code>纳管<code>vmware</code>才能用的到)。</p>
<h3 id="惊险格式的转换"><a href="#惊险格式的转换" class="headerlink" title="惊险格式的转换"></a>惊险格式的转换</h3><ul>
<li><p>将<code>raw</code>格式的镜像转化成<code>qcow2</code>格式（<code>image</code>代表镜像）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> qemu-img convert <span class="_">-f</span> raw -O qcow2 image.img image.qcow2</span></div></pre></td></tr></table></figure>
</li>
<li><p>将<code>vmdk</code>格式的镜像转化成<code>raw</code>格式（<code>image</code>代表镜像）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> qemu-img convert <span class="_">-f</span> vmdk -O raw image.vmdk image.img</span></div></pre></td></tr></table></figure>
</li>
<li><p>将<code>vmdk</code>格式的镜像转化成<code>qcow2</code>格式（<code>image</code>代表镜像）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> qemu-img convert <span class="_">-f</span> vmdk -O qcow2 image.vmdk image.qcow2</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="获取镜像查看镜像信息"><a href="#获取镜像查看镜像信息" class="headerlink" title="获取镜像查看镜像信息"></a>获取镜像查看镜像信息</h3><p>查看镜像的详细信息<code>qemu-img info image.qcow2</code><br>例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> qemu-img info CentOS-7-x86_64-GenericCloud.qcow2c </span></div><div class="line">image: CentOS-7-x86_64-GenericCloud.qcow2c</div><div class="line">file format: qcow2                                #格式为qcow2</div><div class="line">virtual size: 8.0G (8589934592 bytes)             #空间大小</div><div class="line">disk size: 410M</div><div class="line">cluster_size: 65536</div></pre></td></tr></table></figure></p>
<h3 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h3><p>这里我只介绍在<code>linux</code>命令行上传三种格式的镜像</p>
<ul>
<li><p>上传<code>raw</code>格式的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">openstack image create --disk-format raw --container-format bare \</div><div class="line">--public image_raw --file ./image.raw</div></pre></td></tr></table></figure>
</li>
<li><p>上传<code>qcow2</code>格式的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">glance image-create --name image_qcow2  --disk-format qcow2 --container-format bare &lt; image.qcow2</div></pre></td></tr></table></figure>
</li>
<li><p>上传<code>vmdk</code>格式的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">glance image-create --name image_vmdk --disk-format vmdk --container-format bare --property vmware_adaptertype=ide \</div><div class="line">--property hw_disk_bus=ide --property hypervisor_type=vmware &lt; image.vmdk</div></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[利用kolla快速搭建openstack-ocata单节点]]></title>
      <url>/posts/kolla-openstack-ocata.html</url>
      <content type="html"><![CDATA[<h3 id="利用kolla快速安装openstack-ocata单节点"><a href="#利用kolla快速安装openstack-ocata单节点" class="headerlink" title="利用kolla快速安装openstack-ocata单节点"></a>利用<code>kolla</code>快速安装<code>openstack-ocata</code>单节点</h3><a id="more"></a>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li><p>我还是使用大家最常用的<code>vmware workstation 12.0</code>, <code>CentOS 7.3</code>虚拟机来完成整个的验证过程<br>在虚拟机安装<code>centos7.3</code>我就不再这里多说了,选择最小化安装即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cat /etc/redhat-release </span></div><div class="line">CentOS Linux release 7.3.1611 (Core)</div></pre></td></tr></table></figure>
</li>
<li><p>kolla的安装，要求目标机器是两块网卡，所以我虚拟机也是分配两块网卡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ip a|grep eno</span></div><div class="line">2: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    inet 192.168.18.131/24 brd 192.168.18.255 scope global dynamic eno16777736</div><div class="line">3: eno33554960: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master ovs-system state UP qlen 1000</div><div class="line">    inet 192.168.18.30/24 brd 192.168.18.255 scope global eno33554960</div></pre></td></tr></table></figure>
</li>
</ul>
<p><code>eno16777736</code>:设置的IP是：<code>192.168.18.131</code>，日后<code>Horizon</code>访问就是通过这个<code>IP</code>地址<br><code>eno33554960</code>:设置的IP是：<code>192.168.18.30</code>，这个是让<code>neutron</code>的<code>br-ex</code>绑定使用，虚拟机是通过这块网卡访问外网。</p>
<ul>
<li><p>修改主机名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> hostname</span></div><div class="line">localhost.localdomain</div><div class="line"><span class="meta">#</span><span class="bash"> hostnamectl <span class="built_in">set</span>-hostname kolla</span></div></pre></td></tr></table></figure>
</li>
<li><p>关闭<code>firewalld</code>和<code>iptables</code><br><code>centos7</code>以上系统默认防火墙是<code>firewalld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">disable</span> firewalld</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl stop firewalld</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl status firewalld</span></div></pre></td></tr></table></figure>
</li>
<li><p>关闭<code>selinux</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/"</span> /etc/selinux/config</span></div></pre></td></tr></table></figure>
</li>
<li><p>查看虚拟机是开启了虚拟</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> egrep <span class="string">"vmx|svm"</span> /proc/cpuinfo</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果没有开启虚拟化请开启虚拟化说</p>
<ul>
<li>重启系统<code>reboot</code>生效<h3 id="安装基础包"><a href="#安装基础包" class="headerlink" title="安装基础包"></a>安装基础包</h3></li>
<li><p>一定要先启用<code>EPEL</code>的<code>repo</code>源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install epel-release -y</span></div></pre></td></tr></table></figure>
</li>
<li><p>安装基础软件包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install vim net-tools tmux python-devel libffi-devel gcc openssl-devel git python-pip -y</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装<code>docker</code></h3><ul>
<li><p>设置<code>repo</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tee /etc/yum.repos.d/docker.repo &lt;&lt; <span class="string">'EOF'</span></span></div><div class="line">[dockerrepo]</div><div class="line">name=Docker Repository</div><div class="line">baseurl=https://yum.dockerproject.org/repo/main/centos/$releasever/</div><div class="line">enabled=1</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=https://yum.dockerproject.org/gpg</div><div class="line">EOF</div></pre></td></tr></table></figure>
</li>
<li><p>安装<code>Docker 1.12.5</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install docker-engine-1.12.5 docker-engine-selinux-1.12.5 -y</span></div></pre></td></tr></table></figure>
</li>
<li><p>设置<code>docker</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/systemd/system/docker.service.d</span></div><div class="line"><span class="meta">#</span><span class="bash"> tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt; <span class="string">'EOF'</span></span></div><div class="line">[Service]</div><div class="line">MountFlags=shared</div><div class="line">EOF</div></pre></td></tr></table></figure>
</li>
<li><p>重启先关服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> systemctl daemon-reload</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> docker</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl restart docker</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl status docker</span></div></pre></td></tr></table></figure>
</li>
<li><p>访问私有的<code>Docker</code>仓库<br>查看网卡的<code>ip</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ip a|grep eno16777736 |grep inet|awk <span class="string">'&#123;print $2&#125;'</span>|cut <span class="_">-d</span>/ <span class="_">-f</span>1</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>编辑<code>/usr/lib/systemd/system/docker.service</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ExecStart=/usr/bin/dockerd</span></div><div class="line">ExecStart=/usr/bin/dockerd --insecure-registry 192.168.18.131:4000</div></pre></td></tr></table></figure></p>
<ul>
<li>重启服务<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> systemctl daemon-reload</span></div><div class="line"><span class="meta">#</span><span class="bash"> systemctl restart docker</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装Ansible"><a href="#安装Ansible" class="headerlink" title="安装Ansible"></a>安装<code>Ansible</code></h3><p><code>Kolla</code>项目的<code>Mitaka</code>版本要求<code>ansible</code>版本低于<code>2.0</code>，<code>Newton</code>版本以后的就只支持<code>2.x</code>以上的版本。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum -y install ansible</span></div></pre></td></tr></table></figure></p>
<h3 id="搭建Registry服务器"><a href="#搭建Registry服务器" class="headerlink" title="搭建Registry服务器"></a>搭建<code>Registry</code>服务器</h3><p>默认<code>docker</code>的<code>registry</code>是使用<code>5000</code>端口，对于<code>OpenStack</code>来说，有端口冲突，所以我将端口改成了<code>4000</code>。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> docker run <span class="_">-d</span> -v /opt/registry:/var/lib/registry -p 4000:5000 \</span></div><div class="line">--restart=always --name registry registry:2</div></pre></td></tr></table></figure></p>
<h3 id="下载kolla官方提供的ocata镜像"><a href="#下载kolla官方提供的ocata镜像" class="headerlink" title="下载kolla官方提供的ocata镜像"></a>下载<code>kolla</code>官方提供的<code>ocata</code>镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> wget http://tarballs.openstack.org/kolla/images/centos-source-registry-ocata.tar.gz</span></div><div class="line"><span class="meta">#</span><span class="bash"> du -sh centos-source-registry-ocata.tar.gz </span></div><div class="line">3.0G	centos-source-registry-ocata.tar.gz</div><div class="line"><span class="meta">#</span><span class="bash"> tar zxf centos-source-registry-ocata.tar.gz -C /opt/registry/</span></div></pre></td></tr></table></figure>
<p><code>centos-source-registry-ocata</code>大约有3G。</p>
<h3 id="kolla-ansible"><a href="#kolla-ansible" class="headerlink" title="kolla-ansible"></a><code>kolla-ansible</code></h3><ul>
<li><p>下载<code>kolla-ansible</code>的代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> http://git.trystack.cn/openstack/kolla-ansible -b stable/ocata</span></div></pre></td></tr></table></figure>
</li>
<li><p>安装<code>kolla-ansible</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> kolla-ansible/</span></div><div class="line"><span class="meta">#</span><span class="bash"> pip install . -i https://pypi.tuna.tsinghua.edu.cn/simple</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果<code>pip</code>速度很慢，后面可以加上参数<code>-i https://pypi.tuna.tsinghua.edu.cn/simple</code>，指定国内的<code>pip</code>源</p>
<ul>
<li><p>复制相关文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cp -r etc/kolla /etc/kolla/</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span></span></div></pre></td></tr></table></figure>
</li>
<li><p>如果是在虚拟机里装<code>kolla</code>，希望可以启动再启动虚拟机，那么你需要把<code>virt_type=qemu</code>，默认是<code>kvm</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/kolla/config/nova</div><div class="line">cat &lt;&lt; EOF &gt; /etc/kolla/config/nova/nova-compute.conf</div><div class="line">[libvirt]</div><div class="line">virt_type=qemu</div><div class="line">cpu_mode = none</div><div class="line">EOF</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装kolla"><a href="#安装kolla" class="headerlink" title="安装kolla"></a>安装<code>kolla</code></h3><ul>
<li><p>生成密码文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-genpwd</span></div></pre></td></tr></table></figure>
</li>
<li><p>编辑 <code>/etc/kolla/passwords.yml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/passwords.yml</span></div><div class="line">keystone_admin_password: admin</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这是登录<code>Dashboard</code>，<code>admin</code>使用的密码，你可以根据自己需要进行修改</p>
<ul>
<li>编辑<code>/etc/kolla/globals.yml</code>文件<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/kolla/globals.yml</span></div><div class="line">kolla_base_distro: "centos"</div><div class="line">kolla_install_type: "source"</div><div class="line">openstack_release: "4.0.3"</div><div class="line">kolla_internal_vip_address: "192.168.18.100"</div><div class="line">docker_registry: "192.168.18.131:4000"</div><div class="line">docker_namespace: "lokolla"</div><div class="line">network_interface: "eno16777736"</div><div class="line">neutron_external_interface: "eno33554960"</div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果不知道<code>openstack_release</code>和<code>docker_namespace</code>请查看<br><code># cd /opt/registry/docker/registry/v2/repositories/lokolla/centos-source-keepalived/_manifests/tags/4.0.3/</code><br>就可以知道<code>openstack_release</code>为<code>4.0.3</code>和<code>docker_namespace</code>为<code>lokolla</code>了。</p>
<h3 id="验证部署"><a href="#验证部署" class="headerlink" title="验证部署"></a>验证部署</h3><ul>
<li><p>验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible prechecks -i kolla-ansible/ansible/inventory/all-in-one</span></div></pre></td></tr></table></figure>
</li>
<li><p><code>pull</code>镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible pull -i kolla-ansible/ansible/inventory/all-in-one</span></div></pre></td></tr></table></figure>
</li>
<li><p>部署</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible deploy -i kolla-ansible/ansible/inventory/all-in-one</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>大约半个小时基本上就部署完成了</p>
<h3 id="验证部署-1"><a href="#验证部署-1" class="headerlink" title="验证部署"></a>验证部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> kolla-ansible post-deploy</span></div></pre></td></tr></table></figure>
<p>这样就创建 <code>/etc/kolla/admin-openrc.sh</code>文件</p>
<h3 id="安装安装OpenStack-client端"><a href="#安装安装OpenStack-client端" class="headerlink" title="安装安装OpenStack client端"></a>安装安装<code>OpenStack client</code>端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> pip install python-openstackclient</span></div></pre></td></tr></table></figure>
<h3 id="安装成功"><a href="#安装成功" class="headerlink" title="安装成功"></a>安装成功</h3><p><img src="https://ljw.howieli.cn/blog/2017-6-23/dashboard.jpg" alt=""><br>账号：<code>admin</code><br>密码：<code>admin</code></p>
<h3 id="创建网络"><a href="#创建网络" class="headerlink" title="创建网络"></a>创建网络</h3><ul>
<li><p>编辑 <code>/usr/share/kolla-ansible/init-runonce</code><br>网络需要根据实际情况修改,我都是用的<code>nat</code>模式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">EXT_NET_CIDR='192.168.18.0/24'</div><div class="line">EXT_NET_RANGE='start=192.168.18.10,end=192.168.18.20'</div><div class="line">EXT_NET_GATEWAY='192.168.18.2'</div></pre></td></tr></table></figure>
</li>
<li><p>运行脚本创建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">source /etc/kolla/admin-openrc.sh</div><div class="line">bash /usr/share/kolla-ansible/init-runonce</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="最后进入dashboard创建虚拟机，绑定浮动ip"><a href="#最后进入dashboard创建虚拟机，绑定浮动ip" class="headerlink" title="最后进入dashboard创建虚拟机，绑定浮动ip"></a>最后进入<code>dashboard</code>创建虚拟机，绑定浮动<code>ip</code></h3><p>这里我就不多说了，进入<code>dashboard</code>创建与主机即可，网络选择<code>demo-net</code>网络，创建完成后标定浮动<code>ip</code>即可。</p>
<h3 id="检查虚拟网络"><a href="#检查虚拟网络" class="headerlink" title="检查虚拟网络"></a>检查虚拟网络</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> openstack server list</span></div><div class="line">+--------------------------------------+------+--------+----------------------------------+------------+</div><div class="line">| ID                                   | Name | Status | Networks                         | Image Name |</div><div class="line">+--------------------------------------+------+--------+----------------------------------+------------+</div><div class="line">| 0267025b-8193-42ee-8551-67b7625482ab | tets | ACTIVE | demo-net=10.0.0.6, 192.168.18.12 | cirros     |</div><div class="line">+--------------------------------------+------+--------+----------------------------------+------------+</div><div class="line"><span class="meta">#</span><span class="bash"> ping 192.168.18.12 -c 3</span></div><div class="line">PING 192.168.18.12 (192.168.18.12) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.18.12: icmp_seq=1 ttl=63 time=1.85 ms</div><div class="line">64 bytes from 192.168.18.12: icmp_seq=2 ttl=63 time=1.46 ms</div><div class="line">64 bytes from 192.168.18.12: icmp_seq=3 ttl=63 time=5.94 ms</div><div class="line">--- 192.168.18.12 ping statistics ---</div><div class="line">3 packets transmitted, 3 received, 0% packet loss, time 2005ms</div><div class="line">rtt min/avg/max/mdev = 1.466/3.087/5.942/2.025 ms</div></pre></td></tr></table></figure>
<h3 id="检查虚拟机是能能通外网"><a href="#检查虚拟机是能能通外网" class="headerlink" title="检查虚拟机是能能通外网"></a>检查虚拟机是能能通外网</h3><p><code>cirros</code>用户密码默认为<code>cubswin:)</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ssh cirros@192.168.18.12</span></div><div class="line">cirros@192.168.18.12's password: </div><div class="line"><span class="meta">$</span><span class="bash"> ip a</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue </div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">    inet6 ::1/128 scope host </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc pfifo_fast qlen 1000</div><div class="line">    link/ether fa:16:3e:82:4e:f8 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 10.0.0.6/24 brd 10.0.0.255 scope global eth0</div><div class="line">    inet6 fe80::f816:3eff:fe82:4ef8/64 scope link </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line"><span class="meta">$</span><span class="bash"> ping 8.8.8.8 -c 2</span></div><div class="line">PING 8.8.8.8 (8.8.8.8): 56 data bytes</div><div class="line">64 bytes from 8.8.8.8: seq=0 ttl=127 time=171.481 ms</div><div class="line">64 bytes from 8.8.8.8: seq=1 ttl=127 time=171.464 ms</div><div class="line">--- 8.8.8.8 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 171.464/171.472/171.481 ms</div></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[DevStack]]></title>
      <url>/posts/Openstack-DevStack-ocata.html</url>
      <content type="html"><![CDATA[<h3 id="DevStack安装openstack"><a href="#DevStack安装openstack" class="headerlink" title="DevStack安装openstack"></a><code>DevStack</code>安装<code>openstack</code></h3><a id="more"></a>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="关闭iptables防火墙或firewalld防火墙"><a href="#关闭iptables防火墙或firewalld防火墙" class="headerlink" title="关闭iptables防火墙或firewalld防火墙"></a>关闭<code>iptables</code>防火墙或<code>firewalld</code>防火墙</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> systemctl stop iptables</div><div class="line"><span class="meta">#</span> systemctl disable iptables</div><div class="line"><span class="meta">#</span> systemctl stop firewalld</div><div class="line"><span class="meta">#</span> systemctl disable firewalld</div></pre></td></tr></table></figure>
<h4 id="关闭SElinux"><a href="#关闭SElinux" class="headerlink" title="关闭SElinux"></a>关闭<code>SElinux</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> sed -i 'SELINUX=enforcing/SELINUX=disable/' /etc/selinux/config</div><div class="line"><span class="meta">#</span> reboot</div></pre></td></tr></table></figure>
<h4 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装<code>git</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> yum -y install epel-release git</div></pre></td></tr></table></figure>
<h3 id="准备openstack环境"><a href="#准备openstack环境" class="headerlink" title="准备openstack环境"></a>准备<code>openstack</code>环境</h3><p>下载代码<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> cd /home</div><div class="line"><span class="meta">#</span> git clone https://github.com/openstack-dev/devstack -b stable/ocata</div><div class="line">//指定安装openstack ocata版本，如果你想安装其他版本，则指定其他版本名即可。</div></pre></td></tr></table></figure></p>
<h3 id="创建stack用户"><a href="#创建stack用户" class="headerlink" title="创建stack用户"></a>创建<code>stack</code>用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> bash devstack/tools/create-stack-user.sh</div></pre></td></tr></table></figure>
<h3 id="修改devstack目录的权限，让stack用户可以访问"><a href="#修改devstack目录的权限，让stack用户可以访问" class="headerlink" title="修改devstack目录的权限，让stack用户可以访问"></a>修改<code>devstack</code>目录的权限，让stack用户可以访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> chown -R stack:stack /home/devstack</div><div class="line"><span class="meta">#</span> chmod 777 /opt/stack -R</div></pre></td></tr></table></figure>
<h3 id="切换到stack用户下"><a href="#切换到stack用户下" class="headerlink" title="切换到stack用户下"></a>切换到<code>stack</code>用户下</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> su stack</div><div class="line"><span class="meta">$</span> cd /home/devstack/</div></pre></td></tr></table></figure>
<h3 id="创建一个local-conf文件，添加如下内容。"><a href="#创建一个local-conf文件，添加如下内容。" class="headerlink" title="创建一个local.conf文件，添加如下内容。"></a>创建一个<code>local.conf</code>文件，添加如下内容。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> vim local.conf</div><div class="line">[[local|localrc]]</div><div class="line">ADMIN_PASSWORD=admin</div><div class="line">DATABASE_PASSWORD=$ADMIN_PASSWORD</div><div class="line">RABBIT_PASSWORD=$ADMIN_PASSWORD</div><div class="line">SERVICE_PASSWORD=$ADMIN_PASSWORD</div></pre></td></tr></table></figure>
<h3 id="运行DevStack，执行安装"><a href="#运行DevStack，执行安装" class="headerlink" title="运行DevStack，执行安装"></a>运行<code>DevStack</code>，执行安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> ./stack.sh</div></pre></td></tr></table></figure>
<p>大约30分钟安装完成</p>
<h3 id="默认DevStack会创建admin和demo两个用户，通过设置环境变量可以进行相关的操作。进入到-home-devstack目录下。"><a href="#默认DevStack会创建admin和demo两个用户，通过设置环境变量可以进行相关的操作。进入到-home-devstack目录下。" class="headerlink" title="默认DevStack会创建admin和demo两个用户，通过设置环境变量可以进行相关的操作。进入到/home/devstack目录下。"></a>默认<code>DevStack</code>会创建<code>admin</code>和<code>demo</code>两个用户，通过设置环境变量可以进行相关的操作。进入到<code>/home/devstack</code>目录下。</h3><h4 id="admin用户："><a href="#admin用户：" class="headerlink" title="admin用户："></a><code>admin</code>用户：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> source openrc admin admin</div></pre></td></tr></table></figure>
<h4 id="demo用户"><a href="#demo用户" class="headerlink" title="demo用户"></a><code>demo</code>用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> source openrc demo demo</div></pre></td></tr></table></figure>
<h3 id="安装失败时，可以再次执行安装命令。"><a href="#安装失败时，可以再次执行安装命令。" class="headerlink" title="安装失败时，可以再次执行安装命令。"></a>安装失败时，可以再次执行安装命令。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> ./unstack.sh &amp;&amp; ./stack.sh</div></pre></td></tr></table></figure>
<h3 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h3><ul>
<li><p>由于在<code>DevStack</code>安装过程中，将<code>br-ex</code>的地址设置成了其他<code>IP</code>地址，因此需要将<code>br-ex</code>地址清楚掉，重新配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo ip addr flush br-ex</div></pre></td></tr></table></figure>
</li>
<li><p>然后将物理网卡<code>eth0</code>作为<code>br-ex</code>的端口，这样创建的虚拟机就可以通过<code>eth0</code>访问外部网络，外部网络也可以通过<code>Floating IP</code>访问虚拟机。下面给出配置内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> cat ifcfg-eth0</div><div class="line">TYPE=OVSPort</div><div class="line">DEVICE=eth0</div><div class="line">DEVICETYPE=ovs</div><div class="line">OVS_BRIDGE=br-ex</div><div class="line">ONBOOT=yes</div><div class="line"><span class="meta">#</span>###############################################################</div><div class="line"><span class="meta">#</span> cat ifcfg-br-ex</div><div class="line">TYPE=OVSBridge</div><div class="line">DEVICE=br-ex</div><div class="line">DEVICETYPE=ovs</div><div class="line">BOOTPROTO=static</div><div class="line">IPADDR=192.168.23.100</div><div class="line">NETMASK=255.255.255.0</div><div class="line">GATEWAY=192.168.23.1</div></pre></td></tr></table></figure>
</li>
<li><p>接袭来，设置<code>br-ex</code>外部网桥和重启网络。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> ovs-vsctl add-port br-ex eth0</div><div class="line"><span class="meta">#</span> systemctl restart network</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="登录Dashboard"><a href="#登录Dashboard" class="headerlink" title="登录Dashboard"></a>登录<code>Dashboard</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://192.168.23.100</div><div class="line">账户名： admin</div><div class="line">密  码： admin</div></pre></td></tr></table></figure>
<p><img src="https://ljw.howieli.cn/blog/2017-6-20/dashboard.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[虚拟机手动迁移]]></title>
      <url>/posts/openstack.html</url>
      <content type="html"><![CDATA[<h3 id="openstack虚拟机手动迁移"><a href="#openstack虚拟机手动迁移" class="headerlink" title="openstack虚拟机手动迁移"></a>openstack虚拟机手动迁移</h3><a id="more"></a>
<h3 id="openstack迁移计算节点的实例"><a href="#openstack迁移计算节点的实例" class="headerlink" title="openstack迁移计算节点的实例"></a>openstack迁移计算节点的实例</h3><p>您的云平台必须使用的是共享存储</p>
<h3 id="查看可以迁移到的计算节点"><a href="#查看可以迁移到的计算节点" class="headerlink" title="查看可以迁移到的计算节点"></a>查看可以迁移到的计算节点</h3><p><code># openstack compute service list</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@control161 ~]# openstack compute service list</div><div class="line">+-----+------------------+------------+----------+---------+-------+----------------------------+</div><div class="line">|  ID | Binary           | Host       | Zone     | Status  | State | Updated At                 |</div><div class="line">+-----+------------------+------------+----------+---------+-------+----------------------------+</div><div class="line">|   4 | nova-scheduler   | control161 | internal | enabled | up    | 2017-06-19T08:31:10.000000 |</div><div class="line">|  28 | nova-scheduler   | control162 | internal | enabled | up    | 2017-06-19T08:31:07.000000 |</div><div class="line">|  37 | nova-scheduler   | control163 | internal | enabled | up    | 2017-06-19T08:31:12.000000 |</div><div class="line">|  76 | nova-conductor   | control161 | internal | enabled | up    | 2017-06-19T08:31:04.000000 |</div><div class="line">|  97 | nova-conductor   | control162 | internal | enabled | up    | 2017-06-19T08:31:11.000000 |</div><div class="line">| 121 | nova-conductor   | control163 | internal | enabled | up    | 2017-06-19T08:31:04.000000 |</div><div class="line">| 136 | nova-consoleauth | control161 | internal | enabled | up    | 2017-06-19T08:31:12.000000 |</div><div class="line">| 139 | nova-consoleauth | control163 | internal | enabled | up    | 2017-06-19T08:31:06.000000 |</div><div class="line">| 142 | nova-consoleauth | control162 | internal | enabled | up    | 2017-06-19T08:31:08.000000 |</div><div class="line">| 145 | nova-compute     | compute164 | nova     | enabled | up    | 2017-06-19T08:31:08.000000 |</div><div class="line">| 148 | nova-compute     | control162 | nova     | enabled | up    | 2017-06-19T08:31:10.000000 |</div><div class="line">| 151 | nova-compute     | control161 | nova     | enabled | up    | 2017-06-19T08:31:06.000000 |</div><div class="line">| 154 | nova-compute     | control163 | nova     | enabled | up    | 2017-06-19T08:31:11.000000 |</div><div class="line">+-----+------------------+------------+----------+---------+-------+----------------------------+</div></pre></td></tr></table></figure></p>
<p>可以看到我的云平台上一共有4个计算节点</p>
<h3 id="获取需要迁移实例的列表"><a href="#获取需要迁移实例的列表" class="headerlink" title="获取需要迁移实例的列表"></a>获取需要迁移实例的列表</h3><p>我需要把control61节点上的所有虚拟机都迁移到control163上去<br><code>openstack server list --host control161 --all-projects</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@control161 ~]# openstack server list --host control161 --all-projects</div><div class="line">+--------------------------------------+--------+--------+---------------------------------+------------+</div><div class="line">| ID                                   | Name   | Status | Networks                        | Image Name |</div><div class="line">+--------------------------------------+--------+--------+---------------------------------+------------+</div><div class="line">| a834baba-68a6-4120-9f62-6ea26c6b3231 | test-5 | ACTIVE | network1=10.0.1.13              | cirros.raw |</div><div class="line">| 4e835eaf-2dfe-4ac9-a61d-4345f4722e8e | test-1 | ACTIVE | network1=10.0.1.7, 192.168.24.7 | cirros.raw |</div><div class="line">+--------------------------------------+--------+--------+---------------------------------+------------+</div></pre></td></tr></table></figure></p>
<h3 id="迁移所有的实例"><a href="#迁移所有的实例" class="headerlink" title="迁移所有的实例"></a>迁移所有的实例</h3><p>逐个迁移<br><code>openstack server migrate &lt;serverID&gt; --live control161</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@control161 ~]# openstack server migrate a834baba-68a6-4120-9f62-6ea26c6b3231 --live control163</div><div class="line">[root@control161 ~]# openstack server migrate 4e835eaf-2dfe-4ac9-a61d-4345f4722e8e --live control163</div></pre></td></tr></table></figure></p>
<h3 id="验证是否迁移成功"><a href="#验证是否迁移成功" class="headerlink" title="验证是否迁移成功"></a>验证是否迁移成功</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@control161 ~]# openstack server list --host control161 --all-projects</div><div class="line"></div><div class="line">[root@control161 ~]# openstack server list --host control163 --all-projects</div><div class="line">+--------------------------------------+--------+--------+----------------------------------+------------+</div><div class="line">| ID                                   | Name   | Status | Networks                         | Image Name |</div><div class="line">+--------------------------------------+--------+--------+----------------------------------+------------+</div><div class="line">| a834baba-68a6-4120-9f62-6ea26c6b3231 | test-5 | ACTIVE | network1=10.0.1.13               | cirros.raw |</div><div class="line">| 84afc9cd-f0cc-4cfb-a455-507a2aa9dc17 | test-4 | ACTIVE | network1=10.0.1.8                | cirros.raw |</div><div class="line">| 4e835eaf-2dfe-4ac9-a61d-4345f4722e8e | test-1 | ACTIVE | network1=10.0.1.7, 192.168.24.7  | cirros.raw |</div><div class="line">| 2bfd7854-55fc-4868-bc66-db9dda2cb761 | test   | ACTIVE | network1=10.0.1.10, 192.168.24.5 | cirros     |</div><div class="line">+--------------------------------------+--------+--------+----------------------------------+------------+</div></pre></td></tr></table></figure>
<p>可以看到controll61上的两台虚拟机test-1，test-5已经都到了contrll63节点上去了。</p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在linux系统下使用awk工具详解]]></title>
      <url>/posts/Linux-awk.html</url>
      <content type="html"><![CDATA[<h3 id="在linux系统下使用awk工具详解"><a href="#在linux系统下使用awk工具详解" class="headerlink" title="在linux系统下使用awk工具详解"></a>在linux系统下使用awk工具详解</h3><a id="more"></a>
<h3 id="导读"><a href="#导读" class="headerlink" title="导读"></a>导读</h3><p>awk 是一个强大的文本分析工具。它不仅是 Linux 中，也是任何环境中现有的功能最强大的数据处理引擎之一。相对于 grep 的查找，sed的编辑，awk在其对数据分析并生成报告时，显得尤为强大。<br>当你第一次拿起双手在电脑上使用 awk 命令处理一个或者多个文件的时候，它会依次读取文件的每一行内容, 然后对其进行处理，awk 命令默认从 stdio 标准输入获取文件内容, awk 使用一对单引号来表示 一些可执行的脚本代码，在可执行脚本代码里面，使用一对花括号来表示一段可执行代码块，可以同时存在多个代码块。 awk 的每个花括号内同时又可以有多个指令，每一个指令用分号分隔，awk 其实就是一个脚本编程语言。说了这么多，你肯定还是一脸的懵逼。</p>
<h3 id="awk-命令的基本格式"><a href="#awk-命令的基本格式" class="headerlink" title="awk 命令的基本格式"></a>awk 命令的基本格式</h3><p><code>awk [options] &#39;program&#39; file</code><br>options 这个表示一些可选的参数选项，反正就是你爱用不用，不用可以拉到。。。<br>program 这个表示 awk 的可执行脚本代码，这个是必须要有的。 file 这个表示 awk 需要处理的文件，注意是纯文本文件，不是你的 mp3，也不是 mp4 啥的。。</p>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> awk </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[网卡Bond介绍]]></title>
      <url>/posts/linux-bond.html</url>
      <content type="html"><![CDATA[<h3 id="网卡Bond介绍"><a href="#网卡Bond介绍" class="headerlink" title="网卡Bond介绍"></a>网卡Bond介绍</h3><a id="more"></a>
<h3 id="总括"><a href="#总括" class="headerlink" title="总括"></a>总括</h3><p>  Bond技术即bonding，它是一个Linux内核的一个模块，能将多块物理网卡绑定到一张虚拟网卡上的技术，并通过修改Linux的网口驱动让多块网卡看起来是一个单独的以太网接口设备并具有相同的 IP 地址。Bond技术一般用于解决网卡的单点故障或用于网卡负载较高的场景。</p>
<p>  Bond 的网卡运行在混杂模式(Promisc)下。在正常情况下，网卡只接收目的硬件地址(MAC Address)是自身MAC的以太网帧，过滤其他数据帧，以减轻驱动程序的负担。但是网卡也支持另外一种被称为混杂的模式，运行在此模式下的网卡可以接收网络上所有的数据帧。bonding就运行在这种模式下，而且修改了驱动程序中的MAC地址，将两张或多张网卡的MAC地址改成同一MAC地址。</p>
<p>网卡的bond模式一共有7种，下面详细介绍。</p>
<h3 id="模式0"><a href="#模式0" class="headerlink" title="模式0"></a>模式0</h3><p>  模式0（mode=0，round-robin）：此模式使用轮询策略，即顺序的在每一个被bond的网卡上发送数据包，这种模式提供负载均衡和容错能力。Bond0可以保证bond虚拟网卡和被bond的两张或多张物理网卡拥有相同的MAC地址，其中bond虚拟网卡的MAC地址是其中一张物理网卡的MAC地址，而bond虚拟网卡的MAC地址是根据bond自己实现的一个算法来选择的。<br>  在bond0模式下，如果一个连接或者会话的数据包从不同的网口发出，途中再经过不同的链路，则在客户端很有可能会出现数据包无序到达的现象，而无序到达的数据包一般需要重新发送，这样网络的吞吐量就会下降。同时，如果做bond0的两张或多张网卡接到了同一交换机上，还需对其配置聚合模式。</p>
<h3 id="模式1"><a href="#模式1" class="headerlink" title="模式1"></a>模式1</h3><p>  模式1（mode=1，active-backup）：此模式使用主被策略（热备）。在所有做bond1的物理网卡中，同一时刻只有一张网卡被激活，当且仅当活动网卡失效时才会激活其他的网卡。这种模式下做bond的两张或多张网卡的MAC地址和Bond虚拟网卡的MAC地址相同，而Bond的MAC地址是Bond创建启动后活动网卡（Active Slave）的MAC地址。这种模式要求主被网卡能快速的切换，即当主网卡出现故障后能迅速地切换至备用网卡。切换过程中，上层的应用几乎不受影响，因为Bond的驱动程序会临时接管上层应用的数据包，存放至数据缓冲区，等待备用网卡启动后再发送出去。但是如果切换时间过长，则会引起缓冲区的溢出，导致丢包。</p>
<h3 id="模式2"><a href="#模式2" class="headerlink" title="模式2"></a>模式2</h3><p>  模式2（mode=2，balance-xor）：xor为异或运算(二进制位相异为1，相同为0)。此模式的默认选择策略是：<br>选择网卡的序号=(源MAC地址 XOR 目标MAC地址) % Slave网卡（从网卡）的数量。<br>  其他的传输策略可以通过xmit_hash_policy配置项指定。</p>
<h3 id="模式3"><a href="#模式3" class="headerlink" title="模式3"></a>模式3</h3><p>  模式3（mode=3，broadcast）：使用广播策略，数据包会被广播至所有Slave网卡进行传送。</p>
<h3 id="模式4"><a href="#模式4" class="headerlink" title="模式4"></a>模式4</h3><p>  模式4（mode=4，802.3ad）：使用动态链接聚合策略，启动时会创建一个聚合组，所有Slave网卡共享同样的速率和双工设定。<br>必要条件：<br>  1．支持使用ethtool工具获取每个slave网卡的速率和双工设定；<br>  2．需要交换机支持IEEE 802.3ad 动态链路聚合（Dynamic link aggregation）模式</p>
<h3 id="模式5"><a href="#模式5" class="headerlink" title="模式5"></a>模式5</h3><p>  模式5（mode=5，balance-tlbtransmitload balancing）：基于每个slave网卡的速率选择传输网卡。<br>  必要条件：支持使用ethtool工具获取每个slave网卡的速率。</p>
<h3 id="模式6"><a href="#模式6" class="headerlink" title="模式6"></a>模式6</h3><p>  模式6（mode=6，balance-alb，Adaptive load balancing）：该模式包含了bond5模式，同时还支持对IPV4流量接收时的负载均衡策略(receive load balance, rlb)，而且不需要任何交换机的支持。<br>必要条件：</p>
<ol>
<li>ethtool支持获取每个slave的速率；</li>
<li>底层驱动支持设置某个网卡设备的硬件地址。</li>
</ol>
<h3 id="优劣比较"><a href="#优劣比较" class="headerlink" title="优劣比较"></a>优劣比较</h3><p>7中bond模式对比如下<br><img src="https://ljw.howieli.cn/blog/2017-5-27/bond.png" alt=""><br>  在7种模式中，最为常用的是bond0和bond1。在网络流量较大的场景下推荐使用bond0；在可靠性要求较高的场景下推荐使用bond1。</p>
<h3 id="实践操作"><a href="#实践操作" class="headerlink" title="实践操作"></a>实践操作</h3><p>下面以bond0为例，介绍一下bond的基本配置。具体步骤如下：</p>
<ol>
<li><p>配置前查看是否开启bond模块：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">modinfo bonding</div></pre></td></tr></table></figure>
</li>
<li><p>创建bond0网卡配置文件如下：  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">vim /etc/sysconfig/network-scripts/ifcfg-bond0:</div><div class="line">    DEVICE=bond0</div><div class="line">    ONBOOT=yes #自动启动</div><div class="line">    BOOTPROTO=dhcp #可以选择dhcp，static，none</div><div class="line">    USERCTL=no #该设备只能由root控制</div><div class="line">    NM_CONTROLLED=no #不需要重启网卡，实时生效</div><div class="line">    TYPE=Ethernet    #如选DHCP则需要配置IP地址等信息</div><div class="line">    #IPADDR=10.0.2.10</div><div class="line">    #NETMASK=255.255.255.0</div><div class="line">    #GATEWAY=10.0.2.1</div><div class="line">    #BONDING_OPTS="mode=0 miimon=100fail_over_mac=1"</div><div class="line">    #如果使用了BONDING_OPTS选项，则不需要再使用/etc/modprobe.conf 配置文件对绑定设备进行配置。</div></pre></td></tr></table></figure>
</li>
<li><p>配置被bond的网卡。Bonding接口创建以后，被绑定的网卡必须在他们的设置文件里面添加MASTER和SLAVE两个参数。如eth0的配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vim /etc/sysconfig/network-scripts/ifcfg-eth0:</div><div class="line">    DEVICE=eth0</div><div class="line">    ONBOOT=yes</div><div class="line">    BOOTPROTO=none</div><div class="line">    USERCTL=no</div><div class="line">    NM_CONTROLLED=no</div><div class="line">    MASTER=bond0 #属于哪个bond</div><div class="line">    SLAVE=yes #是否为从网卡，即是否被做bond</div></pre></td></tr></table></figure>
</li>
<li><p>创建并编辑<code>/etc/modprobe.d/bond.conf</code>文件，使系统在启动时加载bonding模块。添加：<br><code>alias bond0 bonding</code> //使系统在启动时加载bonding模块，对外虚拟网络接口设备为 bond0<br><code>options bond0 miimon=100 mode=0 fail_over_mac=1</code><br>其中miimon是用来进行链路监测的，其原理是检测网上的链路状态，一般将miimon值设为100，表示系统每100ms监测一次链路连接状态，如果有一条线路不通就转入另一条线路。bonding定义了网卡的4个链路状态：正常状态(BOND_LINK_UP)、网卡出现故障(BOND_LINK_FAIL)、失效状态(BOND_LINK_DOWN)和恢复状态(BOND_LINK_BACK)。<br>fail_over_mac默认等于0，当发生错误时只修改slave网卡的MAC地址而不修改bond的MAC地址；fail_over_mac=1时，当发生错误时只修改bond网卡的MAC地址而不修改slave网卡的MAC地址。这个选项只在虚拟机上进行测试时开启，如果使用物理机则不需配置。</p>
</li>
<li><p>重启机器，使用<code>cat /proc/net/bonding/bondX</code>命令查看bond配置是否生效。<br> 注：必须关闭NetworkManger服务，否则会和bond冲突</p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux bond </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Tmux Linux 分屏工具]]></title>
      <url>/posts/linux-tmux.html</url>
      <content type="html"><![CDATA[<h3 id="tmux介绍"><a href="#tmux介绍" class="headerlink" title="tmux介绍"></a>tmux介绍</h3><a id="more"></a>
<p>tmux是指通过一个终端登录远程主机并运行后，在其中可以开启多个控制台的终端复用软件。<br>有一本关于Tmux的书tmux：<a href="https://www.amazon.com/tmux-Productive-Development-Brian-Hogan/dp/1934356964" target="_blank" rel="external">Productive Mouse-Free Development</a><br>自己在centos7.2系统上简单的使用了一下</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install tmux -y</span></div></pre></td></tr></table></figure>
<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Ctrl+b ? 显示快捷键帮助</div><div class="line">Ctrl+b C-o 调换窗口位置，类似与vim 里的C-w</div><div class="line">Ctrl+b 空格键 采用下一个内置布局</div><div class="line">Ctrl+b ! 把当前窗口变为新窗口</div><div class="line">Ctrl+b “ 横向分隔窗口</div><div class="line">Ctrl+b % 纵向分隔窗口</div><div class="line">Ctrl+b q 显示分隔窗口的编号</div><div class="line">Ctrl+b o 跳到下一个分隔窗口</div><div class="line">Ctrl+b 上下键 上一个及下一个分隔窗口</div><div class="line">Ctrl+b C-方向键 调整分隔窗口大小</div><div class="line">Ctrl+b c 创建新窗口</div><div class="line">Ctrl+b 0~9 选择几号窗口</div><div class="line">Ctrl+b c 创建新窗口</div><div class="line">Ctrl+b n 选择下一个窗口</div><div class="line">Ctrl+b l 切换到最后使用的窗口</div><div class="line">Ctrl+b p 选择前一个窗口</div><div class="line">Ctrl+b w 以菜单方式显示及选择窗口</div><div class="line">Ctrl+b t 显示时钟</div><div class="line">Ctrl+b ; 切换到最后一个使用的面板</div><div class="line">Ctrl+b x 关闭面板</div><div class="line">Ctrl+b &amp; 关闭窗口</div><div class="line">Ctrl+b s 以菜单方式显示和选择会话</div><div class="line">Ctrl+b d 退出tumx，并保存当前会话，这时，tmux仍在后台运行，可以通过tmux attach进入 到指定的会话</div></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> tmux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[openstack实例启动流程]]></title>
      <url>/posts/openstack-blog.html</url>
      <content type="html"><![CDATA[<h3 id="openstack实例启动流程"><a href="#openstack实例启动流程" class="headerlink" title="openstack实例启动流程"></a>openstack实例启动流程</h3><a id="more"></a>
<p><img src="https://ljw.howieli.cn/blog/2017-5-26/openstack.png" alt=""><br>1.客户端使用自己的用户名密码请求认证。<br>2.keystone通过查询在keystone的数据库user表中保存了user的相关信息，包括password加密后的hash值，并返回一个token_id（令牌），和serviceCatalog(一些服务的endpoint地址，cinder、glance-api后面下载镜像和创建块存储时会用到)。<br>3.客户端带上keystone返回的token_id和创建虚机的相关参数，Post请求nova-api创建虚拟机<br>4.nova-api接收到请求后，首先使用请求携带的token_id来访问该api，以验证请求是否有效。<br>5.keystone验证通过后返回更新后的认证信息。<br>6.nova api检查创建虚拟机参数是否有效与合法。<br>检查虚拟机name是否符合命名规范，flavor_id是否在数据库中存在，image_uuid是否是正确的uuid格式<br>检查instance、vcpu、ram的数量是否超过配额。<br>7.当且仅当所有传参都有效合法时，更新nova数据库，新建一条instance记录，vm_states设为BUILDING，task_state设为SCHEDULING.<br>8.nova api 远程调用传递请求、参数给nova scheduler，把消息“请给我创建一台虚拟机”丢到消息队列，然后定期查询虚机的状态。<br>9.nova scheduler从queue中获取到这条消息<br>10.nova scheduler访问nova 数据库，通过调度算法，过滤出一些合适的计算节点，然后进行排序。<br>11.更新虚机节点信息，返回一个最优节点id给nova scheduler。<br>12.nova scheduler选定host之后，通过rpc调用nova-compute服务，把“创建虚机请求”消息丢个mq。<br>13.nova compute收到创建虚拟机请求的消息<br>nova-compute有个定时任务，定期从数据库中查找到运行在该节点上的所有虚拟机信息，统计得到空闲内存大小和空闲磁盘大小。然后更新数据库compute_node信息，以保证调度的准确性。<br>14.nova compute通过rpc查询nova数据库中虚机的信息例如主机模板和id<br>15.nova conductor从消息队列中拿到请求查询数据库<br>16.nova conductor查询nova数据库<br>17.数据库返回虚机信息<br>18.nova compute从消息队列中获取信息。<br>19.nova compute 请求glance 的rest api，下载所需要的镜像，一般是qcow2的。<br>20.glance api 也会去验证请求的token的有效性。<br>21.glance api 返回镜像信息给nova-compute。<br>22.同理，nova compute请求neutron api配置网络，例如获取虚机ip地址<br>23.验证token的有效性<br>24.neutron返回网络信息<br>25-27 同glance、neutron验证token返回块设备信息<br>28.据上面配置的虚拟机信息，生成xml，写入libvirt,xml文件，然后调用libvirt driver去使用libvirt.xml文件启动虚拟机。</p>
]]></content>
      
        <categories>
            
            <category> openstack </category>
            
        </categories>
        
        
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[python环境准备]]></title>
      <url>/posts/python-blog.html</url>
      <content type="html"><![CDATA[<h3 id="pyenv配置"><a href="#pyenv配置" class="headerlink" title="pyenv配置"></a>pyenv配置</h3><a id="more"></a>
<ol>
<li>安装git <code>yum -y install git</code></li>
<li>安装pyenv <code>curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash</code></li>
<li><p>配置环境变量，在<code>~/.bash_profile</code>里增加。</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PATH=<span class="string">"~/.pyenv/bin:<span class="variable">$PATH</span>"</span></div><div class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv init -)</span>"</span></div><div class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv virtualenv-init -)</span>"</span></div></pre></td></tr></table></figure>
</li>
<li><p>安装编译工具<code>yum -y install gcc make patch</code></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> python </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
